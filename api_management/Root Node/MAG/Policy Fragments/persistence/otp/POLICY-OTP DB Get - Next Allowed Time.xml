<?xml version="1.0" encoding="UTF-8"?>
<wsp:Policy xmlns:L7p="http://www.layer7tech.com/ws/policy" xmlns:wsp="http://schemas.xmlsoap.org/ws/2002/12/policy">
    <wsp:All wsp:Usage="Required">
        <L7p:CommentAssertion>
            <L7p:Comment stringValue=" ============================================"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue=" === ***  THIS POLICY IS READ ONLY ***"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue=" === If you have the need to customize this policy"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue=" === please contact CA APIM Support so we can improve customization capability"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue=" ============================================"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue="!-- Fetches the next_allowed_time for a suspended user --"/>
        </L7p:CommentAssertion>
        <L7p:SetVariable>
            <L7p:Base64Expression stringValue=""/>
            <L7p:VariableToSet stringValue="remainingTime"/>
        </L7p:SetVariable>
        <L7p:SetVariable>
            <L7p:Base64Expression stringValue="MA=="/>
            <L7p:VariableToSet stringValue="recCount"/>
        </L7p:SetVariable>
        <wsp:OneOrMore wsp:Usage="Required">
            <L7p:CommentAssertion>
                <L7p:Comment stringValue="Checking userid "/>
            </L7p:CommentAssertion>
            <L7p:ComparisonAssertion>
                <L7p:CaseSensitive booleanValue="false"/>
                <L7p:Expression1 stringValue="${userid}"/>
                <L7p:Operator operatorNull="null"/>
                <L7p:Predicates predicates="included">
                    <L7p:item dataType="included">
                        <L7p:Type variableDataType="string"/>
                    </L7p:item>
                    <L7p:item binary="included">
                        <L7p:Negated booleanValue="true"/>
                        <L7p:Operator operator="EMPTY"/>
                        <L7p:RightValue stringValue=""/>
                    </L7p:item>
                </L7p:Predicates>
            </L7p:ComparisonAssertion>
            <wsp:All wsp:Usage="Required">
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="MTAz"/>
                    <L7p:VariableToSet stringValue="error.code"/>
                </L7p:SetVariable>
                <L7p:FalseAssertion/>
                <L7p:assertionComment>
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="RIGHT.COMMENT"/>
                            <L7p:value stringValue="// fail"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:assertionComment>
            </wsp:All>
            <L7p:assertionComment>
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="LEFT.COMMENT"/>
                        <L7p:value stringValue="check"/>
                    </L7p:entry>
                    <L7p:entry>
                        <L7p:key stringValue="RIGHT.COMMENT"/>
                        <L7p:value stringValue="userid is empty or not"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:assertionComment>
        </wsp:OneOrMore>
        <L7p:JdbcQuery>
            <L7p:AssertionFailureEnabled booleanValue="false"/>
            <L7p:ConnectionName stringValue="MAG_OAuth"/>
            <L7p:ConvertVariablesToStrings booleanValue="false"/>
            <L7p:NamingMap mapValue="included">
                <L7p:entry>
                    <L7p:key stringValue="next_allowed_time"/>
                    <L7p:value stringValue="nextAllowedTime"/>
                </L7p:entry>
            </L7p:NamingMap>
            <L7p:QueryName stringValue="Query to check if the user has to wait till next retry"/>
            <L7p:SqlQuery stringValue="select next_allowed_time from mag_otp_records where user_id=${userid}"/>
            <L7p:VariablePrefix stringValue="check"/>
        </L7p:JdbcQuery>
        <L7p:SetVariable>
            <L7p:Base64Expression stringValue="JHtjaGVjay5xdWVyeXJlc3VsdC5jb3VudH0="/>
            <L7p:VariableToSet stringValue="recCount"/>
        </L7p:SetVariable>
        <wsp:OneOrMore wsp:Usage="Required">
            <wsp:All wsp:Usage="Required">
                <L7p:ComparisonAssertion>
                    <L7p:CaseSensitive booleanValue="false"/>
                    <L7p:Expression1 stringValue="${recCount}"/>
                    <L7p:Operator operatorNull="null"/>
                    <L7p:Predicates predicates="included">
                        <L7p:item dataType="included">
                            <L7p:Type variableDataType="int"/>
                        </L7p:item>
                        <L7p:item binary="included">
                            <L7p:Operator operator="GT"/>
                            <L7p:RightValue stringValue="0"/>
                        </L7p:item>
                    </L7p:Predicates>
                </L7p:ComparisonAssertion>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="JHtjaGVjay5uZXh0QWxsb3dlZFRpbWV9"/>
                    <L7p:VariableToSet stringValue="nextAllowedTime"/>
                </L7p:SetVariable>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="JHtnYXRld2F5LnRpbWUudXRjfQ=="/>
                    <L7p:DataType variableDataType="dateTime"/>
                    <L7p:DateOffsetExpression stringValue=""/>
                    <L7p:VariableToSet stringValue="current"/>
                </L7p:SetVariable>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="JHtjdXJyZW50LnNlY29uZHN9"/>
                    <L7p:VariableToSet stringValue="current"/>
                </L7p:SetVariable>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="PHJvb3Q+IHRlbXBWYWx1ZSA8L3Jvb3Q+"/>
                    <L7p:ContentType stringValue="text/xml; charset=utf-8"/>
                    <L7p:DataType variableDataType="message"/>
                    <L7p:VariableToSet stringValue="temp"/>
                </L7p:SetVariable>
                <L7p:ResponseXpathAssertion>
                    <L7p:VariablePrefix stringValue="ret"/>
                    <L7p:XmlMsgSrc stringValue="temp"/>
                    <L7p:XpathExpression xpathExpressionValue="included">
                        <L7p:Expression stringValue="$nextAllowedTime - $current"/>
                        <L7p:Namespaces mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="s"/>
                                <L7p:value stringValue="http://schemas.xmlsoap.org/soap/envelope/"/>
                            </L7p:entry>
                        </L7p:Namespaces>
                        <L7p:XpathVersion xpathVersion="XPATH_1_0"/>
                    </L7p:XpathExpression>
                </L7p:ResponseXpathAssertion>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="JHtyZXQucmVzdWx0fQ=="/>
                    <L7p:VariableToSet stringValue="remainingTime"/>
                </L7p:SetVariable>
                <L7p:Regex>
                    <L7p:AutoTarget booleanValue="false"/>
                    <L7p:OtherTargetMessageVariable stringValue="remainingTime"/>
                    <L7p:Regex stringValue="(\d)\..+"/>
                    <L7p:RegexName stringValue="Decimal to Integer"/>
                    <L7p:Replace booleanValue="true"/>
                    <L7p:Replacement stringValue="$1"/>
                    <L7p:Target target="OTHER"/>
                </L7p:Regex>
                <L7p:ComparisonAssertion>
                    <L7p:CaseSensitive booleanValue="false"/>
                    <L7p:Expression1 stringValue="${remainingTime}"/>
                    <L7p:Operator operatorNull="null"/>
                    <L7p:Predicates predicates="included">
                        <L7p:item dataType="included">
                            <L7p:Type variableDataType="int"/>
                        </L7p:item>
                        <L7p:item binary="included">
                            <L7p:Operator operator="GT"/>
                            <L7p:RightValue stringValue="0"/>
                        </L7p:item>
                    </L7p:Predicates>
                </L7p:ComparisonAssertion>
                <L7p:assertionComment>
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="RIGHT.COMMENT"/>
                            <L7p:value stringValue="Calculate the remainingtime"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:assertionComment>
            </wsp:All>
            <wsp:All wsp:Usage="Required">
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="MA=="/>
                    <L7p:VariableToSet stringValue="recCount"/>
                </L7p:SetVariable>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="MA=="/>
                    <L7p:VariableToSet stringValue="remainingTime"/>
                </L7p:SetVariable>
                <L7p:assertionComment>
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="RIGHT.COMMENT"/>
                            <L7p:value stringValue="No remainingtime"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:assertionComment>
            </wsp:All>
        </wsp:OneOrMore>
    </wsp:All>
</wsp:Policy>