<?xml version="1.0" encoding="UTF-8"?>
<wsp:Policy xmlns:L7p="http://www.layer7tech.com/ws/policy" xmlns:wsp="http://schemas.xmlsoap.org/ws/2002/12/policy">
    <wsp:All wsp:Usage="Required">
        <L7p:CommentAssertion>
            <L7p:Comment stringValue=" ============================================"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue=" === ***  THIS POLICY IS READ ONLY ***"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue=" === If you have the need to customize this policy"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue=" === please contact CA APIM Support so we can improve customization capability"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue=" ============================================"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue="This policy adds a new device registration if it does not already exist"/>
        </L7p:CommentAssertion>
        <L7p:SetVariable>
            <L7p:Base64Expression stringValue=""/>
            <L7p:VariableToSet stringValue="content-type"/>
        </L7p:SetVariable>
        <L7p:SetVariable>
            <L7p:Base64Expression stringValue=""/>
            <L7p:VariableToSet stringValue="error.code"/>
        </L7p:SetVariable>
        <wsp:OneOrMore wsp:Usage="Required">
            <wsp:All wsp:Usage="Required">
                <L7p:ComparisonAssertion>
                    <L7p:CaseSensitive booleanValue="false"/>
                    <L7p:Expression1 stringValue="${created}"/>
                    <L7p:Expression2 stringValue=""/>
                    <L7p:Negate booleanValue="true"/>
                    <L7p:Operator operator="EMPTY"/>
                    <L7p:Predicates predicates="included">
                        <L7p:item binary="included">
                            <L7p:CaseSensitive booleanValue="false"/>
                            <L7p:Negated booleanValue="true"/>
                            <L7p:Operator operator="EMPTY"/>
                            <L7p:RightValue stringValue=""/>
                        </L7p:item>
                    </L7p:Predicates>
                </L7p:ComparisonAssertion>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="JHtjcmVhdGVkfQ=="/>
                    <L7p:DataType variableDataType="dateTime"/>
                    <L7p:DateFormat stringValue="&lt;Second Timestamp>"/>
                    <L7p:DateOffsetExpression stringValue=""/>
                    <L7p:VariableToSet stringValue="created"/>
                </L7p:SetVariable>
            </wsp:All>
            <L7p:SetVariable>
                <L7p:Base64Expression stringValue=""/>
                <L7p:DataType variableDataType="dateTime"/>
                <L7p:DateOffsetExpression stringValue=""/>
                <L7p:VariableToSet stringValue="created"/>
            </L7p:SetVariable>
            <L7p:assertionComment>
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="LEFT.COMMENT"/>
                        <L7p:value stringValue="created time"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:assertionComment>
        </wsp:OneOrMore>
        <wsp:OneOrMore wsp:Usage="Required">
            <wsp:All wsp:Usage="Required">
                <L7p:ComparisonAssertion>
                    <L7p:CaseSensitive booleanValue="false"/>
                    <L7p:Expression1 stringValue="${magidentifier}"/>
                    <L7p:Operator operatorNull="null"/>
                    <L7p:Predicates predicates="included">
                        <L7p:item dataType="included">
                            <L7p:Type variableDataType="string"/>
                        </L7p:item>
                        <L7p:item binary="included">
                            <L7p:CaseSensitive booleanValue="false"/>
                            <L7p:Negated booleanValue="true"/>
                            <L7p:Operator operator="EMPTY"/>
                            <L7p:RightValue stringValue=""/>
                        </L7p:item>
                    </L7p:Predicates>
                </L7p:ComparisonAssertion>
                <L7p:ComparisonAssertion>
                    <L7p:CaseSensitive booleanValue="false"/>
                    <L7p:Expression1 stringValue="${signed_cert}"/>
                    <L7p:Operator operatorNull="null"/>
                    <L7p:Predicates predicates="included">
                        <L7p:item dataType="included">
                            <L7p:Type variableDataType="string"/>
                        </L7p:item>
                        <L7p:item binary="included">
                            <L7p:CaseSensitive booleanValue="false"/>
                            <L7p:Negated booleanValue="true"/>
                            <L7p:Operator operator="EMPTY"/>
                            <L7p:RightValue stringValue=""/>
                        </L7p:item>
                    </L7p:Predicates>
                </L7p:ComparisonAssertion>
                <wsp:All wsp:Usage="Required">
                    <L7p:ComparisonAssertion>
                        <L7p:CaseSensitive booleanValue="false"/>
                        <L7p:Expression1 stringValue="${grace}"/>
                        <L7p:Operator operatorNull="null"/>
                        <L7p:Predicates predicates="included">
                            <L7p:item dataType="included">
                                <L7p:Type variableDataType="string"/>
                            </L7p:item>
                            <L7p:item binary="included">
                                <L7p:CaseSensitive booleanValue="false"/>
                                <L7p:Negated booleanValue="true"/>
                                <L7p:Operator operator="EMPTY"/>
                                <L7p:RightValue stringValue=""/>
                            </L7p:item>
                        </L7p:Predicates>
                    </L7p:ComparisonAssertion>
                    <L7p:SetVariable>
                        <L7p:Base64Expression stringValue="JHtncmFjZX0="/>
                        <L7p:DataType variableDataType="dateTime"/>
                        <L7p:DateOffsetExpression stringValue=""/>
                        <L7p:DateOffsetField intValue="5"/>
                        <L7p:VariableToSet stringValue="grace"/>
                    </L7p:SetVariable>
                    <L7p:assertionComment>
                        <L7p:Properties mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="LEFT.COMMENT"/>
                                <L7p:value stringValue="grace"/>
                            </L7p:entry>
                        </L7p:Properties>
                    </L7p:assertionComment>
                </wsp:All>
                <L7p:assertionComment>
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="LEFT.COMMENT"/>
                            <L7p:value stringValue="VALIDATE"/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="RIGHT.COMMENT"/>
                            <L7p:value stringValue="// required input parameters"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:assertionComment>
            </wsp:All>
            <wsp:All wsp:Usage="Required">
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="MTAz"/>
                    <L7p:VariableToSet stringValue="error.code"/>
                </L7p:SetVariable>
                <L7p:FalseAssertion/>
                <L7p:assertionComment>
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="LEFT.COMMENT"/>
                            <L7p:value stringValue="error"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:assertionComment>
            </wsp:All>
            <L7p:assertionComment>
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="LEFT.COMMENT"/>
                        <L7p:value stringValue="parameter"/>
                    </L7p:entry>
                    <L7p:entry>
                        <L7p:key stringValue="RIGHT.COMMENT"/>
                        <L7p:value stringValue="// check for some variables that have to be set"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:assertionComment>
        </wsp:OneOrMore>
        <wsp:OneOrMore wsp:Usage="Required">
            <L7p:ComparisonAssertion>
                <L7p:CaseSensitive booleanValue="false"/>
                <L7p:Expression1 stringValue="${multiuser}"/>
                <L7p:Expression2 stringValue=""/>
                <L7p:Negate booleanValue="true"/>
                <L7p:Operator operator="EMPTY"/>
                <L7p:Predicates predicates="included">
                    <L7p:item binary="included">
                        <L7p:CaseSensitive booleanValue="false"/>
                        <L7p:Negated booleanValue="true"/>
                        <L7p:Operator operator="EMPTY"/>
                        <L7p:RightValue stringValue=""/>
                    </L7p:item>
                </L7p:Predicates>
            </L7p:ComparisonAssertion>
            <L7p:SetVariable>
                <L7p:Base64Expression stringValue="ZmFsc2U="/>
                <L7p:VariableToSet stringValue="multiuser"/>
            </L7p:SetVariable>
            <L7p:assertionComment>
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="LEFT.COMMENT"/>
                        <L7p:value stringValue="multiuser"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:assertionComment>
        </wsp:OneOrMore>
        <L7p:SetVariable>
            <L7p:Base64Expression stringValue=""/>
            <L7p:DataType variableDataType="dateTime"/>
            <L7p:DateOffsetExpression stringValue=""/>
            <L7p:VariableToSet stringValue="now"/>
        </L7p:SetVariable>
        <wsp:OneOrMore wsp:Usage="Required">
            <wsp:All wsp:Usage="Required">
                <L7p:CassandraQuery>
                    <L7p:AssertionComment assertionComment="included">
                        <L7p:Properties mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="LEFT.COMMENT"/>
                                <L7p:value stringValue="MagIdentifier"/>
                            </L7p:entry>
                            <L7p:entry>
                                <L7p:key stringValue="RIGHT.COMMENT"/>
                                <L7p:value stringValue="Check that it does not exist"/>
                            </L7p:entry>
                        </L7p:Properties>
                    </L7p:AssertionComment>
                    <L7p:ConnectionName stringValue="MAG_OAuth_Cassandra"/>
                    <L7p:FetchSize intValue="5000"/>
                    <L7p:GenerateXmlResult booleanValue="true"/>
                    <L7p:MaxRecords intValue="10"/>
                    <L7p:NamingMap mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="count"/>
                            <L7p:value stringValue="count"/>
                        </L7p:entry>
                    </L7p:NamingMap>
                    <L7p:Prefix stringValue="queryMagIdentifier"/>
                    <L7p:QueryDocument stringValueReference="inline"><![CDATA[SELECT count(*) AS Count
                FROM mag_msso_device
                WHERE magidentifier=${magidentifier}]]></L7p:QueryDocument>
                    <L7p:QueryTimeout stringValueNull="null"/>
                </L7p:CassandraQuery>
                <L7p:ComparisonAssertion>
                    <L7p:CaseSensitive booleanValue="false"/>
                    <L7p:Expression1 stringValue="${queryMagIdentifier.count}"/>
                    <L7p:Expression2 stringValue="0"/>
                    <L7p:Predicates predicates="included">
                        <L7p:item binary="included">
                            <L7p:CaseSensitive booleanValue="false"/>
                            <L7p:RightValue stringValue="0"/>
                        </L7p:item>
                    </L7p:Predicates>
                </L7p:ComparisonAssertion>
                <L7p:CassandraQuery>
                    <L7p:AssertionComment assertionComment="included">
                        <L7p:Properties mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="LEFT.COMMENT"/>
                                <L7p:value stringValue="CertDN"/>
                            </L7p:entry>
                            <L7p:entry>
                                <L7p:key stringValue="RIGHT.COMMENT"/>
                                <L7p:value stringValue="Check that it does not exist"/>
                            </L7p:entry>
                        </L7p:Properties>
                    </L7p:AssertionComment>
                    <L7p:ConnectionName stringValue="MAG_OAuth_Cassandra"/>
                    <L7p:FetchSize intValue="5000"/>
                    <L7p:MaxRecords intValue="10"/>
                    <L7p:NamingMap mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="count"/>
                            <L7p:value stringValue="count"/>
                        </L7p:entry>
                    </L7p:NamingMap>
                    <L7p:Prefix stringValue="queryCertDN"/>
                    <L7p:QueryDocument stringValueReference="inline"><![CDATA[SELECT count(*) AS COUNT
                FROM mag_msso_device_certdn
                WHERE certdn=${certdn}]]></L7p:QueryDocument>
                    <L7p:QueryTimeout stringValueNull="null"/>
                </L7p:CassandraQuery>
                <L7p:ComparisonAssertion>
                    <L7p:CaseSensitive booleanValue="false"/>
                    <L7p:Expression1 stringValue="${queryCertDN.count}"/>
                    <L7p:Expression2 stringValue="0"/>
                    <L7p:Predicates predicates="included">
                        <L7p:item binary="included">
                            <L7p:CaseSensitive booleanValue="false"/>
                            <L7p:RightValue stringValue="0"/>
                        </L7p:item>
                    </L7p:Predicates>
                </L7p:ComparisonAssertion>
                <L7p:CassandraQuery>
                    <L7p:AssertionComment assertionComment="included">
                        <L7p:Properties mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="LEFT.COMMENT"/>
                                <L7p:value stringValue="DeviceID"/>
                            </L7p:entry>
                            <L7p:entry>
                                <L7p:key stringValue="RIGHT.COMMENT"/>
                                <L7p:value stringValue="Check that it does not exist"/>
                            </L7p:entry>
                        </L7p:Properties>
                    </L7p:AssertionComment>
                    <L7p:ConnectionName stringValue="MAG_OAuth_Cassandra"/>
                    <L7p:FetchSize intValue="5000"/>
                    <L7p:MaxRecords intValue="10"/>
                    <L7p:NamingMap mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="count"/>
                            <L7p:value stringValue="count"/>
                        </L7p:entry>
                    </L7p:NamingMap>
                    <L7p:Prefix stringValue="queryDeviceID"/>
                    <L7p:QueryDocument stringValueReference="inline"><![CDATA[SELECT count(*) AS COUNT
                FROM mag_msso_device_deviceid
                WHERE deviceid=${deviceid}]]></L7p:QueryDocument>
                    <L7p:QueryTimeout stringValueNull="null"/>
                </L7p:CassandraQuery>
                <L7p:ComparisonAssertion>
                    <L7p:CaseSensitive booleanValue="false"/>
                    <L7p:Expression1 stringValue="${queryDeviceID.count}"/>
                    <L7p:Expression2 stringValue="0"/>
                    <L7p:Predicates predicates="included">
                        <L7p:item binary="included">
                            <L7p:CaseSensitive booleanValue="false"/>
                            <L7p:RightValue stringValue="0"/>
                        </L7p:item>
                    </L7p:Predicates>
                </L7p:ComparisonAssertion>
                <L7p:CassandraQuery>
                    <L7p:ConnectionName stringValue="MAG_OAuth_Cassandra"/>
                    <L7p:FetchSize intValue="5000"/>
                    <L7p:MaxRecords intValue="1000"/>
                    <L7p:QueryDocument stringValueReference="inline"><![CDATA[BEGIN BATCH

                INSERT INTO mag_msso_device (magidentifier,certdn,username,devicestatus,deviceid,devicename,created,updated,multiuser, csr_base64, signed_cert_base64, grace_expiration)
                VALUES (${magidentifier},${certdn},${username},${devicestatus},${deviceid},${devicename},${created.seconds},${now.seconds},${multiuser}, ${csr}, ${signed_cert}, ${grace.seconds});

                INSERT INTO mag_msso_device_username_view (magidentifier,certdn,username,devicestatus,deviceid,devicename,created,updated,multiuser, csr_base64, signed_cert_base64, grace_expiration)
                VALUES (${magidentifier},${certdn},${username},${devicestatus},${deviceid},${devicename},${created.seconds},${now.seconds},${multiuser}, ${csr}, ${signed_cert}, ${grace.seconds});

                INSERT INTO mag_msso_device_user (username, magidentifier)
                VALUES(${username}, ${magidentifier});

                INSERT INTO mag_msso_device_certdn (certdn, magidentifier)
                VALUES(${certdn}, ${magidentifier});

                INSERT INTO mag_msso_device_deviceid (deviceid, magidentifier)
                VALUES(${deviceid}, ${magidentifier});

                INSERT INTO mag_msso_device_overview (magidentifier,certdn,username,devicestatus,deviceid,devicename,created,updated,multiuser,client_key,access_token, csr_base64, signed_cert_base64, grace_expiration)
                VALUES (${magidentifier},${certdn},${username},${devicestatus},${deviceid},${devicename},${created.seconds},${now.seconds},${multiuser},'',null, ${csr}, ${signed_cert}, ${grace.seconds});

                APPLY BATCH]]></L7p:QueryDocument>
                    <L7p:QueryTimeout stringValueNull="null"/>
                </L7p:CassandraQuery>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="dGV4dC9wbGFpbg=="/>
                    <L7p:VariableToSet stringValue="content-type"/>
                </L7p:SetVariable>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="cGVyc2lzdGVk"/>
                    <L7p:VariableToSet stringValue="result"/>
                </L7p:SetVariable>
                <L7p:assertionComment>
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="LEFT.COMMENT"/>
                            <L7p:value stringValue="success"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:assertionComment>
            </wsp:All>
            <wsp:All wsp:Usage="Required">
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="MTA1"/>
                    <L7p:VariableToSet stringValue="error.code"/>
                </L7p:SetVariable>
                <L7p:FalseAssertion/>
                <L7p:assertionComment>
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="LEFT.COMMENT"/>
                            <L7p:value stringValue="error"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:assertionComment>
            </wsp:All>
            <L7p:assertionComment>
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="LEFT.COMMENT"/>
                        <L7p:value stringValue="query"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:assertionComment>
        </wsp:OneOrMore>
    </wsp:All>
</wsp:Policy>