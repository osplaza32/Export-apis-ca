<?xml version="1.0" encoding="UTF-8"?>
<wsp:Policy xmlns:L7p="http://www.layer7tech.com/ws/policy" xmlns:wsp="http://schemas.xmlsoap.org/ws/2002/12/policy">
    <wsp:All wsp:Usage="Required">
        <L7p:CommentAssertion>
            <L7p:Comment stringValue=" ============================================"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue=" === ***  THIS POLICY IS READ ONLY ***"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue=" === Required changes can be implemented in policies in the 'Customizations' folder "/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue=" === The policies within that folder will have the same name as this policy but "/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue=" === either prefixed with '#' or suffixed with 'Extensions'"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue=" === Prefixed policies can be used to overwrite variables of this policy"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue=" === Suffixed policies can be used to extend functionality"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue=" === If you find you cannot add your customizations using the policies in the 'Customizations' folder"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue=" === please contact CA APIM Support so we can improve customization capability"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue=" ============================================"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue="This policy authenticates a user within OTK."/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue="Disable branches or implement other methods for authentication if required"/>
        </L7p:CommentAssertion>
        <wsp:All wsp:Usage="Required">
            <L7p:CommentAssertion>
                <L7p:Comment stringValue="IMPORTANT: the following output variables have to be set!"/>
            </L7p:CommentAssertion>
            <L7p:CommentAssertion>
                <L7p:Comment stringValue="- current.username: the username of the user that authenticated"/>
            </L7p:CommentAssertion>
            <L7p:CommentAssertion>
                <L7p:Comment stringValue="- current.user.role: by default either 'user' or 'admin'. Any user name configured within user role section of 'OTK User Attribute Look Up Extension' will be interpreted as 'admin'"/>
            </L7p:CommentAssertion>
            <L7p:CommentAssertion>
                <L7p:Comment stringValue="- current.user.acr: the acr that was matched when authenticating the user. By default '0'"/>
            </L7p:CommentAssertion>
            <L7p:CommentAssertion>
                <L7p:Comment stringValue="- current.user.authTime: the time when the user authenticated. By default 'now'"/>
            </L7p:CommentAssertion>
            <L7p:CommentAssertion>
                <L7p:Comment stringValue="- salt: this value is used when generating id_token. It ALWAYS has to be the same value for the same user per IDP!"/>
            </L7p:CommentAssertion>
            <L7p:CommentAssertion>
                <L7p:Comment stringValue="- Others, most likely not to be overwritten: error.code, third_party_sso_token, third_party_sso_token_type"/>
            </L7p:CommentAssertion>
            <L7p:assertionComment>
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="LEFT.COMMENT"/>
                        <L7p:value stringValue="README"/>
                    </L7p:entry>
                    <L7p:entry>
                        <L7p:key stringValue="RIGHT.COMMENT"/>
                        <L7p:value stringValue="// Info about output parameters"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:assertionComment>
        </wsp:All>
        <wsp:All wsp:Usage="Required">
            <L7p:CommentAssertion>
                <L7p:Comment stringValue="- the variable 'acrValuesRequested' contains the content requested by a client"/>
            </L7p:CommentAssertion>
            <L7p:CommentAssertion>
                <L7p:Comment stringValue="- extract the content and determine which acr-class should be associated with which branch"/>
            </L7p:CommentAssertion>
            <L7p:CommentAssertion>
                <L7p:Comment stringValue="- after successful authentication set the variable 'current.user.acr' to the value that was used"/>
            </L7p:CommentAssertion>
            <L7p:assertionComment>
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="LEFT.COMMENT"/>
                        <L7p:value stringValue="README"/>
                    </L7p:entry>
                    <L7p:entry>
                        <L7p:key stringValue="RIGHT.COMMENT"/>
                        <L7p:value stringValue="// Info about acr handling"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:assertionComment>
        </wsp:All>
        <wsp:All wsp:Usage="Required">
            <L7p:CommentAssertion>
                <L7p:Comment stringValue="Default branches:"/>
            </L7p:CommentAssertion>
            <L7p:CommentAssertion>
                <L7p:Comment stringValue="- Authorization Header: this extracts username and password from a HTTP Basic Authorization header. By default only used in the context of MAG"/>
            </L7p:CommentAssertion>
            <L7p:CommentAssertion>
                <L7p:Comment stringValue="- Internal: authenticates users against the internal identity provider. This branch should be updated if an LDAP (or simiar) is used"/>
            </L7p:CommentAssertion>
            <L7p:CommentAssertion>
                <L7p:Comment stringValue="- ID_TOKEN: authentication by validating an id_token that was issued by OTK. By default used with the parameters 'id_token_hint, prompt=none' at the endpint '.../authorize/login'"/>
            </L7p:CommentAssertion>
            <L7p:CommentAssertion>
                <L7p:Comment stringValue="- Browser session-cookie: used if a user selecte to be rememered at the Authorization Server's login page"/>
            </L7p:CommentAssertion>
            <L7p:CommentAssertion>
                <L7p:Comment stringValue="- [MAG] Social Login: used with MAG if social login is used. By default used at the endpoint '.../authorize/login'"/>
            </L7p:CommentAssertion>
            <L7p:CommentAssertion>
                <L7p:Comment stringValue="- SiteMinder: enabled and used if SiteMinder is used as IDP"/>
            </L7p:CommentAssertion>
            <L7p:assertionComment>
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="LEFT.COMMENT"/>
                        <L7p:value stringValue="README"/>
                    </L7p:entry>
                    <L7p:entry>
                        <L7p:key stringValue="RIGHT.COMMENT"/>
                        <L7p:value stringValue="// Info about branches"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:assertionComment>
        </wsp:All>
        <L7p:SetVariable>
            <L7p:AssertionComment assertionComment="included">
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="LEFT.COMMENT"/>
                        <L7p:value stringValue="[MAG]"/>
                    </L7p:entry>
                    <L7p:entry>
                        <L7p:key stringValue="RIGHT.COMMENT"/>
                        <L7p:value stringValue="Set by SiteMinder branch if MAG is enabled"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:AssertionComment>
            <L7p:Base64Expression stringValue=""/>
            <L7p:VariableToSet stringValue="third_party_sso_token"/>
        </L7p:SetVariable>
        <L7p:SetVariable>
            <L7p:AssertionComment assertionComment="included">
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="LEFT.COMMENT"/>
                        <L7p:value stringValue="[MAG]"/>
                    </L7p:entry>
                    <L7p:entry>
                        <L7p:key stringValue="RIGHT.COMMENT"/>
                        <L7p:value stringValue="Set by SiteMinder branch if MAG is enabled"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:AssertionComment>
            <L7p:Base64Expression stringValue=""/>
            <L7p:VariableToSet stringValue="third_party_sso_token_type"/>
        </L7p:SetVariable>
        <L7p:SetVariable>
            <L7p:AssertionComment assertionComment="included">
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="LEFT.COMMENT"/>
                        <L7p:value stringValue="user role"/>
                    </L7p:entry>
                    <L7p:entry>
                        <L7p:key stringValue="RIGHT.COMMENT"/>
                        <L7p:value stringValue="will be overridden if a user is identified as administrator"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:AssertionComment>
            <L7p:Base64Expression stringValue="dXNlcg=="/>
            <L7p:VariableToSet stringValue="current.user.role"/>
        </L7p:SetVariable>
        <L7p:SetVariable>
            <L7p:AssertionComment assertionComment="included">
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="RIGHT.COMMENT"/>
                        <L7p:value stringValue="// initialize"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:AssertionComment>
            <L7p:Base64Expression stringValue=""/>
            <L7p:VariableToSet stringValue="error.code"/>
        </L7p:SetVariable>
        <L7p:SetVariable>
            <L7p:AssertionComment assertionComment="included">
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="RIGHT.COMMENT"/>
                        <L7p:value stringValue="// may contain additional attributes to be exposed"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:AssertionComment>
            <L7p:Base64Expression stringValue=""/>
            <L7p:VariableToSet stringValue="current.user.attributes"/>
        </L7p:SetVariable>
        <L7p:SetVariable>
            <L7p:AssertionComment assertionComment="included">
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="LEFT.COMMENT"/>
                        <L7p:value stringValue="acr"/>
                    </L7p:entry>
                    <L7p:entry>
                        <L7p:key stringValue="RIGHT.COMMENT"/>
                        <L7p:value stringValue="default level of authentication context class"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:AssertionComment>
            <L7p:Base64Expression stringValue=""/>
            <L7p:VariableToSet stringValue="current.user.acr"/>
        </L7p:SetVariable>
        <L7p:SetVariable>
            <L7p:Base64Expression stringValue="JHtnYXRld2F5LnRpbWUuc2Vjb25kc30="/>
            <L7p:VariableToSet stringValue="current.time"/>
        </L7p:SetVariable>
        <L7p:SetVariable>
            <L7p:Base64Expression stringValue="JHtjdXJyZW50LnRpbWV9"/>
            <L7p:VariableToSet stringValue="current.user.authTime"/>
        </L7p:SetVariable>
        <L7p:SetVariable>
            <L7p:Base64Expression stringValue="JHtjdXJyZW50LnRpbWV9"/>
            <L7p:VariableToSet stringValue="existingAuthTime"/>
        </L7p:SetVariable>
        <wsp:OneOrMore wsp:Usage="Required">
            <wsp:All wsp:Usage="Required">
                <L7p:ComparisonAssertion>
                    <L7p:CaseSensitive booleanValue="false"/>
                    <L7p:Expression1 stringValue="${authIdToken}"/>
                    <L7p:Expression2 stringValue=""/>
                    <L7p:Negate booleanValue="true"/>
                    <L7p:Operator operator="EMPTY"/>
                    <L7p:Predicates predicates="included">
                        <L7p:item binary="included">
                            <L7p:CaseSensitive booleanValue="false"/>
                            <L7p:Negated booleanValue="true"/>
                            <L7p:Operator operator="EMPTY"/>
                            <L7p:RightValue stringValue=""/>
                        </L7p:item>
                    </L7p:Predicates>
                </L7p:ComparisonAssertion>
                <L7p:Encapsulated>
                    <L7p:EncapsulatedAssertionConfigGuid stringValue="f330bc51-c1fb-44bd-a07a-93baf86adad2"/>
                    <L7p:EncapsulatedAssertionConfigName stringValue="OTK id_token Validation"/>
                    <L7p:Parameters mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="acr"/>
                            <L7p:value stringValue=""/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="azp"/>
                            <L7p:value stringValue=""/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="check_expiration"/>
                            <L7p:value stringValue="true"/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="jwt"/>
                            <L7p:value stringValue="${authIdToken}"/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="resource_owner"/>
                            <L7p:value stringValue=""/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="salt"/>
                            <L7p:value stringValue=""/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="shared_secret"/>
                            <L7p:value stringValue=""/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="shared_secret_alg"/>
                            <L7p:value stringValue=""/>
                        </L7p:entry>
                    </L7p:Parameters>
                </L7p:Encapsulated>
                <L7p:ResponseXpathAssertion>
                    <L7p:VariablePrefix stringValue="xpathAuthTime"/>
                    <L7p:XmlMsgSrc stringValue="resp"/>
                    <L7p:XpathExpression xpathExpressionValue="included">
                        <L7p:Expression stringValue="/ns0:validation/ns0:auth_time/text()"/>
                        <L7p:Namespaces mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="ns0"/>
                                <L7p:value stringValue="http://ns.l7tech.com/2012/11/otk-ovp"/>
                            </L7p:entry>
                            <L7p:entry>
                                <L7p:key stringValue="s"/>
                                <L7p:value stringValue="http://schemas.xmlsoap.org/soap/envelope/"/>
                            </L7p:entry>
                            <L7p:entry>
                                <L7p:key stringValue="ns"/>
                                <L7p:value stringValue="http://ns.l7tech.com/2012/11/otk-tokenstore"/>
                            </L7p:entry>
                        </L7p:Namespaces>
                        <L7p:XpathVersion xpathVersion="XPATH_1_0"/>
                    </L7p:XpathExpression>
                </L7p:ResponseXpathAssertion>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="JHt4cGF0aEF1dGhUaW1lLnJlc3VsdH0="/>
                    <L7p:VariableToSet stringValue="existingAuthTime"/>
                </L7p:SetVariable>
                <L7p:assertionComment>
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="LEFT.COMMENT"/>
                            <L7p:value stringValue="Id Token Passed in"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:assertionComment>
            </wsp:All>
            <wsp:All wsp:Usage="Required">
                <L7p:ComparisonAssertion>
                    <L7p:CaseSensitive booleanValue="false"/>
                    <L7p:Expression1 stringValue="${authIdToken}"/>
                    <L7p:Expression2 stringValue=""/>
                    <L7p:Operator operator="EMPTY"/>
                    <L7p:Predicates predicates="included">
                        <L7p:item binary="included">
                            <L7p:CaseSensitive booleanValue="false"/>
                            <L7p:Operator operator="EMPTY"/>
                            <L7p:RightValue stringValue=""/>
                        </L7p:item>
                    </L7p:Predicates>
                </L7p:ComparisonAssertion>
                <L7p:Encapsulated>
                    <L7p:EncapsulatedAssertionConfigGuid stringValue="755e056d-fe4a-440c-81ac-cc76dfd58899"/>
                    <L7p:EncapsulatedAssertionConfigName stringValue="OTK id_token Lookup"/>
                    <L7p:Parameters mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="azp"/>
                            <L7p:value stringValue="${clientId}"/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="format"/>
                            <L7p:value stringValue=""/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="jwt"/>
                            <L7p:value stringValue=""/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="resource_owner"/>
                            <L7p:value stringValue="${username}"/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="sub"/>
                            <L7p:value stringValue=""/>
                        </L7p:entry>
                    </L7p:Parameters>
                </L7p:Encapsulated>
                <L7p:ResponseXpathAssertion>
                    <L7p:VariablePrefix stringValue="jwtValues"/>
                    <L7p:XmlMsgSrc stringValue="resp"/>
                    <L7p:XpathExpression xpathExpressionValue="included">
                        <L7p:Expression stringValue="/ns:values/ns:value/ns:jwt/text()"/>
                        <L7p:Namespaces mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="ns"/>
                                <L7p:value stringValue="http://ns.l7tech.com/2012/11/otk-tokenstore"/>
                            </L7p:entry>
                            <L7p:entry>
                                <L7p:key stringValue="s"/>
                                <L7p:value stringValue="http://schemas.xmlsoap.org/soap/envelope/"/>
                            </L7p:entry>
                        </L7p:Namespaces>
                        <L7p:XpathVersion xpathVersion="XPATH_1_0"/>
                    </L7p:XpathExpression>
                </L7p:ResponseXpathAssertion>
                <L7p:Regex>
                    <L7p:AutoTarget booleanValue="false"/>
                    <L7p:CaptureVar stringValue="payloadB64"/>
                    <L7p:OtherTargetMessageVariable stringValue="jwtValues.result"/>
                    <L7p:Regex stringValue="[.]([^.]+)[.]"/>
                    <L7p:Replacement stringValue=""/>
                    <L7p:Target target="OTHER"/>
                </L7p:Regex>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="JHtwYXlsb2FkQjY0WzFdfQ=="/>
                    <L7p:VariableToSet stringValue="payloadB64"/>
                </L7p:SetVariable>
                <L7p:EncodeDecode>
                    <L7p:SourceVariableName stringValue="payloadB64"/>
                    <L7p:TargetDataType variableDataType="string"/>
                    <L7p:TargetVariableName stringValue="payload"/>
                    <L7p:TransformType transformType="BASE64_DECODE"/>
                </L7p:EncodeDecode>
                <L7p:CustomAssertion>
                    <L7p:base64SerializedValue>rO0ABXNyADFjb20ubDd0ZWNoLnBvbGljeS5hc3NlcnRpb24uQ3VzdG9tQXNzZXJ0aW9uSG9sZGVyZtcreFwddTICAAlaAAxpc1VpQXV0b09wZW5MAApjYXRlZ29yaWVzdAAPTGphdmEvdXRpbC9TZXQ7TAAIY2F0ZWdvcnl0ACpMY29tL2w3dGVjaC9wb2xpY3kvYXNzZXJ0aW9uL2V4dC9DYXRlZ29yeTtMAA9jdXN0b21Bc3NlcnRpb250ADFMY29tL2w3dGVjaC9wb2xpY3kvYXNzZXJ0aW9uL2V4dC9DdXN0b21Bc3NlcnRpb247TAAUY3VzdG9tTW9kdWxlRmlsZU5hbWV0ABJMamF2YS9sYW5nL1N0cmluZztMAA9kZXNjcmlwdGlvblRleHRxAH4ABEwAD3BhbGV0dGVOb2RlTmFtZXEAfgAETAAOcG9saWN5Tm9kZU5hbWVxAH4ABEwAHnJlZ2lzdGVyZWRDdXN0b21GZWF0dXJlU2V0TmFtZXEAfgAEeHIAJWNvbS5sN3RlY2gucG9saWN5LmFzc2VydGlvbi5Bc3NlcnRpb27bX2OZPL2isQIAAloAB2VuYWJsZWRMABBhc3NlcnRpb25Db21tZW50dAAvTGNvbS9sN3RlY2gvcG9saWN5L2Fzc2VydGlvbi9Bc3NlcnRpb24kQ29tbWVudDt4cAFzcgAtY29tLmw3dGVjaC5wb2xpY3kuYXNzZXJ0aW9uLkFzc2VydGlvbiRDb21tZW50wRemdwvAdqYCAAFMAApwcm9wZXJ0aWVzdAAPTGphdmEvdXRpbC9NYXA7eHBzcgARamF2YS51dGlsLkhhc2hNYXAFB9rBwxZg0QMAAkYACmxvYWRGYWN0b3JJAAl0aHJlc2hvbGR4cD9AAAAAAAAMdwgAAAAQAAAAAXQADVJJR0hULkNPTU1FTlR0ACgvLyBjaGVjayBleHBpcmF0aW9uIGFuZCBvdXRwdXQgYXV0aF90aW1leAFzcgARamF2YS51dGlsLkhhc2hTZXS6RIWVlri3NAMAAHhwdwwAAAACP0AAAAAAAAFzcgAoY29tLmw3dGVjaC5wb2xpY3kuYXNzZXJ0aW9uLmV4dC5DYXRlZ29yeVqwnGWhRP41AgACSQAFbXlLZXlMAAZteU5hbWVxAH4ABHhwAAAAB3QAH01lc3NhZ2VWYWxpZGF0aW9uVHJhbnNmb3JtYXRpb254cHNyAERjb20ubDd0ZWNoLmN1c3RvbS5vcGVuaWRjb25uZWN0LkRlY29kZUlEVG9rZW4uSURUb2tlbkRlY29kZUFzc2VydGlvbsZeqgVzv/y5AgAQWgAJZXhwb3J0QWNyWgAJZXhwb3J0QWxsWgAMZXhwb3J0QXRIYXNoWgAJZXhwb3J0QXVkWgAOZXhwb3J0QXV0aFRpbWVaAAlleHBvcnRBenBaAAtleHBvcnRDSGFzaFoAEGV4cG9ydEV4cGlyYXRpb25aAAlleHBvcnRJYXRaAAlleHBvcnRJc3NaAAtleHBvcnROb25jZVoACWV4cG9ydFN1YloADnZhbGlkYXRlQ2xhaW1zWgASdmFsaWRhdGVFeHBpcmF0aW9uTAAOZXhwb3J0VmFyaWFibGVxAH4ABEwAB3BheWxvYWRxAH4ABHhwAAAAAAEAAAAAAAAAAAF0AARkaWR0dAAKJHtwYXlsb2FkfXQAH09wZW5JRENvbm5lY3RBc3NlcnRpb24tYjc1My5qYXJ0AC5EZWNvZGVzIGFuIElEIFRva2VuIHBhc3NlZCBpbiBhcyBKU09OIG1lc3NhZ2UucHBw</L7p:base64SerializedValue>
                </L7p:CustomAssertion>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="JHtkaWR0LmF1dGhfdGltZX0="/>
                    <L7p:VariableToSet stringValue="existingAuthTime"/>
                </L7p:SetVariable>
                <L7p:assertionComment>
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="LEFT.COMMENT"/>
                            <L7p:value stringValue="Look-up"/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="RIGHT.COMMENT"/>
                            <L7p:value stringValue="// try to find id_token using client_id and resource_owner"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:assertionComment>
            </wsp:All>
            <L7p:TrueAssertion/>
            <L7p:assertionComment>
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="LEFT.COMMENT"/>
                        <L7p:value stringValue="Existing id_token auth_time"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:assertionComment>
        </wsp:OneOrMore>
        <L7p:SetVariable>
            <L7p:AssertionComment assertionComment="included">
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="LEFT.COMMENT"/>
                        <L7p:value stringValue="reset"/>
                    </L7p:entry>
                    <L7p:entry>
                        <L7p:key stringValue="RIGHT.COMMENT"/>
                        <L7p:value stringValue="// reset error.code to empty to prevent incorrect error code to be used below"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:AssertionComment>
            <L7p:Base64Expression stringValue=""/>
            <L7p:VariableToSet stringValue="error.code"/>
        </L7p:SetVariable>
        <wsp:OneOrMore wsp:Usage="Required">
            <wsp:All wsp:Usage="Required">
                <L7p:ComparisonAssertion>
                    <L7p:CaseSensitive booleanValue="false"/>
                    <L7p:Expression1 stringValue="${username}"/>
                    <L7p:Expression2 stringValue=""/>
                    <L7p:Operator operator="EMPTY"/>
                    <L7p:Predicates predicates="included">
                        <L7p:item binary="included">
                            <L7p:CaseSensitive booleanValue="false"/>
                            <L7p:Operator operator="EMPTY"/>
                            <L7p:RightValue stringValue=""/>
                        </L7p:item>
                    </L7p:Predicates>
                </L7p:ComparisonAssertion>
                <L7p:ComparisonAssertion>
                    <L7p:CaseSensitive booleanValue="false"/>
                    <L7p:Expression1 stringValue="${authHeader}"/>
                    <L7p:Expression2 stringValue=""/>
                    <L7p:Negate booleanValue="true"/>
                    <L7p:Operator operator="EMPTY"/>
                    <L7p:Predicates predicates="included">
                        <L7p:item binary="included">
                            <L7p:CaseSensitive booleanValue="false"/>
                            <L7p:Negated booleanValue="true"/>
                            <L7p:Operator operator="EMPTY"/>
                            <L7p:RightValue stringValue=""/>
                        </L7p:item>
                    </L7p:Predicates>
                </L7p:ComparisonAssertion>
                <L7p:Regex>
                    <L7p:AutoTarget booleanValue="false"/>
                    <L7p:CaptureVar stringValue="authorization"/>
                    <L7p:OtherTargetMessageVariable stringValue="authHeader"/>
                    <L7p:Regex stringValue="[ ](.{1,128})$"/>
                    <L7p:Replacement stringValue=""/>
                    <L7p:Target target="OTHER"/>
                </L7p:Regex>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="JHthdXRob3JpemF0aW9uWzFdfQ=="/>
                    <L7p:VariableToSet stringValue="authorization"/>
                </L7p:SetVariable>
                <L7p:EncodeDecode>
                    <L7p:SourceVariableName stringValue="authorization"/>
                    <L7p:TargetDataType variableDataType="string"/>
                    <L7p:TargetVariableName stringValue="authorization"/>
                    <L7p:TransformType transformType="BASE64_DECODE"/>
                </L7p:EncodeDecode>
                <L7p:Regex>
                    <L7p:AutoTarget booleanValue="false"/>
                    <L7p:CaptureVar stringValue="authorization"/>
                    <L7p:OtherTargetMessageVariable stringValue="authorization"/>
                    <L7p:Regex stringValue="^([^:]{1,64}):(.{1,64})"/>
                    <L7p:Replacement stringValue=""/>
                    <L7p:Target target="OTHER"/>
                </L7p:Regex>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="JHthdXRob3JpemF0aW9uWzFdfQ=="/>
                    <L7p:VariableToSet stringValue="username"/>
                </L7p:SetVariable>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="JHthdXRob3JpemF0aW9uWzJdfQ=="/>
                    <L7p:VariableToSet stringValue="password"/>
                </L7p:SetVariable>
            </wsp:All>
            <L7p:TrueAssertion/>
            <L7p:assertionComment>
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="LEFT.COMMENT"/>
                        <L7p:value stringValue="Authorization Header"/>
                    </L7p:entry>
                    <L7p:entry>
                        <L7p:key stringValue="RIGHT.COMMENT"/>
                        <L7p:value stringValue="Extract username and password from http basic authorization header if it exists"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:assertionComment>
        </wsp:OneOrMore>
        <wsp:OneOrMore wsp:Usage="Required">
            <wsp:All wsp:Usage="Required">
                <L7p:Include>
                    <L7p:PolicyGuid stringValue="e2038842-60b3-4fa4-a95a-9039d622cd7e"/>
                </L7p:Include>
                <wsp:OneOrMore wsp:Usage="Required">
                    <L7p:ComparisonAssertion>
                        <L7p:CaseSensitive booleanValue="false"/>
                        <L7p:Expression1 stringValue="${prompt}"/>
                        <L7p:Expression2 stringValue=""/>
                        <L7p:Operator operator="EMPTY"/>
                        <L7p:Predicates predicates="included">
                            <L7p:item binary="included">
                                <L7p:CaseSensitive booleanValue="false"/>
                                <L7p:Operator operator="EMPTY"/>
                                <L7p:RightValue stringValue=""/>
                            </L7p:item>
                        </L7p:Predicates>
                    </L7p:ComparisonAssertion>
                    <L7p:Regex>
                        <L7p:AutoTarget booleanValue="false"/>
                        <L7p:OtherTargetMessageVariable stringValue="prompt"/>
                        <L7p:Regex stringValue="\blogin\b"/>
                        <L7p:Replacement stringValue=""/>
                        <L7p:Target target="OTHER"/>
                    </L7p:Regex>
                    <wsp:All wsp:Usage="Required">
                        <L7p:Regex>
                            <L7p:AutoTarget booleanValue="false"/>
                            <L7p:OtherTargetMessageVariable stringValue="prompt"/>
                            <L7p:Regex stringValue="\bnone\b"/>
                            <L7p:Replacement stringValue=""/>
                            <L7p:Target target="OTHER"/>
                        </L7p:Regex>
                        <L7p:Regex>
                            <L7p:AutoTarget booleanValue="false"/>
                            <L7p:OtherTargetMessageVariable stringValue="prompt"/>
                            <L7p:ProceedIfPatternMatches booleanValue="false"/>
                            <L7p:Regex stringValue="\blogin\b"/>
                            <L7p:Replacement stringValue=""/>
                            <L7p:Target target="OTHER"/>
                        </L7p:Regex>
                        <L7p:SetVariable>
                            <L7p:AssertionComment assertionComment="included">
                                <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="LEFT.COMMENT"/>
                                    <L7p:value stringValue="auth_time"/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// update auth_time to use existing"/>
                                    </L7p:entry>
                                </L7p:Properties>
                            </L7p:AssertionComment>
                            <L7p:Base64Expression stringValue="JHtleGlzdGluZ0F1dGhUaW1lfQ=="/>
                            <L7p:VariableToSet stringValue="current.user.authTime"/>
                        </L7p:SetVariable>
                        <L7p:assertionComment>
                            <L7p:Properties mapValue="included">
                                <L7p:entry>
                                    <L7p:key stringValue="LEFT.COMMENT"/>
                                    <L7p:value stringValue="none"/>
                                </L7p:entry>
                                <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// prompt contains none"/>
                                </L7p:entry>
                            </L7p:Properties>
                        </L7p:assertionComment>
                    </wsp:All>
                    <L7p:assertionComment>
                        <L7p:Properties mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="LEFT.COMMENT"/>
                                <L7p:value stringValue="prompt"/>
                            </L7p:entry>
                            <L7p:entry>
                                <L7p:key stringValue="RIGHT.COMMENT"/>
                                <L7p:value stringValue="// check prompt value"/>
                            </L7p:entry>
                        </L7p:Properties>
                    </L7p:assertionComment>
                </wsp:OneOrMore>
                <L7p:assertionComment>
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="LEFT.COMMENT"/>
                            <L7p:value stringValue="Custom IDP or Siteminder"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:assertionComment>
            </wsp:All>
            <wsp:All wsp:Usage="Required">
                <L7p:ComparisonAssertion>
                    <L7p:CaseSensitive booleanValue="false"/>
                    <L7p:Expression1 stringValue="${authIdToken}"/>
                    <L7p:Expression2 stringValue=""/>
                    <L7p:Negate booleanValue="true"/>
                    <L7p:Operator operator="EMPTY"/>
                    <L7p:Predicates predicates="included">
                        <L7p:item binary="included">
                            <L7p:CaseSensitive booleanValue="false"/>
                            <L7p:Negated booleanValue="true"/>
                            <L7p:Operator operator="EMPTY"/>
                            <L7p:RightValue stringValue=""/>
                        </L7p:item>
                    </L7p:Predicates>
                </L7p:ComparisonAssertion>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="JHthdXRoSWRUb2tlbn0="/>
                    <L7p:VariableToSet stringValue="existing_jwt"/>
                </L7p:SetVariable>
                <L7p:ComparisonAssertion>
                    <L7p:CaseSensitive booleanValue="false"/>
                    <L7p:Expression1 stringValue="${username}"/>
                    <L7p:Expression2 stringValue=""/>
                    <L7p:Operator operator="EMPTY"/>
                    <L7p:Predicates predicates="included">
                        <L7p:item binary="included">
                            <L7p:CaseSensitive booleanValue="false"/>
                            <L7p:Operator operator="EMPTY"/>
                            <L7p:RightValue stringValue=""/>
                        </L7p:item>
                    </L7p:Predicates>
                </L7p:ComparisonAssertion>
                <L7p:CommentAssertion>
                    <L7p:Comment stringValue="id_token validation"/>
                </L7p:CommentAssertion>
                <L7p:CommentAssertion>
                    <L7p:Comment stringValue="'aud' can be ignored"/>
                </L7p:CommentAssertion>
                <L7p:Encapsulated>
                    <L7p:EncapsulatedAssertionConfigGuid stringValue="f330bc51-c1fb-44bd-a07a-93baf86adad2"/>
                    <L7p:EncapsulatedAssertionConfigName stringValue="OTK id_token Validation"/>
                    <L7p:Parameters mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="acr"/>
                            <L7p:value stringValue=""/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="azp"/>
                            <L7p:value stringValue=""/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="check_expiration"/>
                            <L7p:value stringValue="true"/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="jwt"/>
                            <L7p:value stringValue="${authIdToken}"/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="resource_owner"/>
                            <L7p:value stringValue=""/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="salt"/>
                            <L7p:value stringValue=""/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="shared_secret"/>
                            <L7p:value stringValue=""/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="shared_secret_alg"/>
                            <L7p:value stringValue=""/>
                        </L7p:entry>
                    </L7p:Parameters>
                </L7p:Encapsulated>
                <L7p:ResponseXpathAssertion>
                    <L7p:VariablePrefix stringValue="xpathResourceOwner"/>
                    <L7p:XmlMsgSrc stringValue="resp"/>
                    <L7p:XpathExpression xpathExpressionValue="included">
                        <L7p:Expression stringValue="/ns0:validation/ns0:resource_owner/text()"/>
                        <L7p:Namespaces mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="ns"/>
                                <L7p:value stringValue="http://ns.l7tech.com/2012/11/otk-tokenstore"/>
                            </L7p:entry>
                            <L7p:entry>
                                <L7p:key stringValue="ns0"/>
                                <L7p:value stringValue="http://ns.l7tech.com/2012/11/otk-ovp"/>
                            </L7p:entry>
                            <L7p:entry>
                                <L7p:key stringValue="s"/>
                                <L7p:value stringValue="http://schemas.xmlsoap.org/soap/envelope/"/>
                            </L7p:entry>
                        </L7p:Namespaces>
                        <L7p:XpathVersion xpathVersion="XPATH_1_0"/>
                    </L7p:XpathExpression>
                </L7p:ResponseXpathAssertion>
                <L7p:ResponseXpathAssertion>
                    <L7p:VariablePrefix stringValue="xpathResourceOwnerAcr"/>
                    <L7p:XmlMsgSrc stringValue="resp"/>
                    <L7p:XpathExpression xpathExpressionValue="included">
                        <L7p:Expression stringValue="/ns0:validation/ns0:acr/text()"/>
                        <L7p:Namespaces mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="ns0"/>
                                <L7p:value stringValue="http://ns.l7tech.com/2012/11/otk-ovp"/>
                            </L7p:entry>
                            <L7p:entry>
                                <L7p:key stringValue="s"/>
                                <L7p:value stringValue="http://schemas.xmlsoap.org/soap/envelope/"/>
                            </L7p:entry>
                            <L7p:entry>
                                <L7p:key stringValue="ns"/>
                                <L7p:value stringValue="http://ns.l7tech.com/2012/11/otk-tokenstore"/>
                            </L7p:entry>
                        </L7p:Namespaces>
                        <L7p:XpathVersion xpathVersion="XPATH_1_0"/>
                    </L7p:XpathExpression>
                </L7p:ResponseXpathAssertion>
                <L7p:ResponseXpathAssertion>
                    <L7p:VariablePrefix stringValue="xpathResourceOwnerSalt"/>
                    <L7p:XmlMsgSrc stringValue="resp"/>
                    <L7p:XpathExpression xpathExpressionValue="included">
                        <L7p:Expression stringValue="/ns0:validation/ns0:salt/text()"/>
                        <L7p:Namespaces mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="ns0"/>
                                <L7p:value stringValue="http://ns.l7tech.com/2012/11/otk-ovp"/>
                            </L7p:entry>
                            <L7p:entry>
                                <L7p:key stringValue="s"/>
                                <L7p:value stringValue="http://schemas.xmlsoap.org/soap/envelope/"/>
                            </L7p:entry>
                            <L7p:entry>
                                <L7p:key stringValue="ns"/>
                                <L7p:value stringValue="http://ns.l7tech.com/2012/11/otk-tokenstore"/>
                            </L7p:entry>
                        </L7p:Namespaces>
                        <L7p:XpathVersion xpathVersion="XPATH_1_0"/>
                    </L7p:XpathExpression>
                </L7p:ResponseXpathAssertion>
                <L7p:ResponseXpathAssertion>
                    <L7p:VariablePrefix stringValue="xpathAuthTime"/>
                    <L7p:XmlMsgSrc stringValue="resp"/>
                    <L7p:XpathExpression xpathExpressionValue="included">
                        <L7p:Expression stringValue="/ns0:validation/ns0:auth_time/text()"/>
                        <L7p:Namespaces mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="ns0"/>
                                <L7p:value stringValue="http://ns.l7tech.com/2012/11/otk-ovp"/>
                            </L7p:entry>
                            <L7p:entry>
                                <L7p:key stringValue="s"/>
                                <L7p:value stringValue="http://schemas.xmlsoap.org/soap/envelope/"/>
                            </L7p:entry>
                            <L7p:entry>
                                <L7p:key stringValue="ns"/>
                                <L7p:value stringValue="http://ns.l7tech.com/2012/11/otk-tokenstore"/>
                            </L7p:entry>
                        </L7p:Namespaces>
                        <L7p:XpathVersion xpathVersion="XPATH_1_0"/>
                    </L7p:XpathExpression>
                </L7p:ResponseXpathAssertion>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="JHt4cGF0aFJlc291cmNlT3duZXIucmVzdWx0fQ=="/>
                    <L7p:VariableToSet stringValue="current.username"/>
                </L7p:SetVariable>
                <wsp:OneOrMore wsp:Usage="Required">
                    <L7p:Regex>
                        <L7p:AssertionComment assertionComment="included">
                            <L7p:Properties mapValue="included">
                                <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// does not contain none"/>
                                </L7p:entry>
                            </L7p:Properties>
                        </L7p:AssertionComment>
                        <L7p:AutoTarget booleanValue="false"/>
                        <L7p:OtherTargetMessageVariable stringValue="prompt"/>
                        <L7p:ProceedIfPatternMatches booleanValue="false"/>
                        <L7p:Regex stringValue="\bnone\b"/>
                        <L7p:Replacement stringValue=""/>
                        <L7p:Target target="OTHER"/>
                    </L7p:Regex>
                    <L7p:SetVariable>
                        <L7p:Base64Expression stringValue="JHt4cGF0aEF1dGhUaW1lLnJlc3VsdH0="/>
                        <L7p:VariableToSet stringValue="current.user.authTime"/>
                    </L7p:SetVariable>
                    <L7p:assertionComment>
                        <L7p:Properties mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="LEFT.COMMENT"/>
                                <L7p:value stringValue="prompt"/>
                            </L7p:entry>
                            <L7p:entry>
                                <L7p:key stringValue="RIGHT.COMMENT"/>
                                <L7p:value stringValue="// use existing auth_time from id_token if prompt value contains none"/>
                            </L7p:entry>
                        </L7p:Properties>
                    </L7p:assertionComment>
                </wsp:OneOrMore>
                <L7p:SetVariable>
                    <L7p:AssertionComment assertionComment="included">
                        <L7p:Properties mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="RIGHT.COMMENT"/>
                                <L7p:value stringValue="Used to create a PPID within an id_token"/>
                            </L7p:entry>
                        </L7p:Properties>
                    </L7p:AssertionComment>
                    <L7p:Base64Expression stringValue="JHt4cGF0aFJlc291cmNlT3duZXJTYWx0LnJlc3VsdH0="/>
                    <L7p:VariableToSet stringValue="salt"/>
                </L7p:SetVariable>
                <L7p:CommentAssertion>
                    <L7p:Comment stringValue="Setting 'acr' to the original value. May be be overwritten if the usage of the id_token shall be something different"/>
                </L7p:CommentAssertion>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="JHt4cGF0aFJlc291cmNlT3duZXJBY3IucmVzdWx0fQ=="/>
                    <L7p:VariableToSet stringValue="current.user.acr"/>
                </L7p:SetVariable>
                <L7p:Encapsulated>
                    <L7p:AssertionComment assertionComment="included">
                        <L7p:Properties mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="RIGHT.COMMENT"/>
                                <L7p:value stringValue="// look up user role"/>
                            </L7p:entry>
                        </L7p:Properties>
                    </L7p:AssertionComment>
                    <L7p:EncapsulatedAssertionConfigGuid stringValue="fb3a7c6b-6fc1-47b3-a823-2eecdfa173fe"/>
                    <L7p:EncapsulatedAssertionConfigName stringValue="OTK User Attribute Look Up"/>
                    <L7p:Parameters mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="custom"/>
                            <L7p:value stringValue="${provider}"/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="given_username"/>
                            <L7p:value stringValue="${current.username}"/>
                        </L7p:entry>
                    </L7p:Parameters>
                </L7p:Encapsulated>
                <L7p:assertionComment>
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="LEFT.COMMENT"/>
                            <L7p:value stringValue="ID_TOKEN"/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="RIGHT.COMMENT"/>
                            <L7p:value stringValue="Default usage: authenticates a user based on a given id_token_hint in the context of OpenID Connect response_type flows"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:assertionComment>
            </wsp:All>
            <wsp:All wsp:Usage="Required">
                <L7p:ComparisonAssertion>
                    <L7p:CaseSensitive booleanValue="false"/>
                    <L7p:Expression1 stringValue="${cookiename}"/>
                    <L7p:Expression2 stringValue=""/>
                    <L7p:Negate booleanValue="true"/>
                    <L7p:Operator operator="EMPTY"/>
                    <L7p:Predicates predicates="included">
                        <L7p:item binary="included">
                            <L7p:CaseSensitive booleanValue="false"/>
                            <L7p:Negated booleanValue="true"/>
                            <L7p:Operator operator="EMPTY"/>
                            <L7p:RightValue stringValue=""/>
                        </L7p:item>
                    </L7p:Predicates>
                </L7p:ComparisonAssertion>
                <L7p:ComparisonAssertion>
                    <L7p:CaseSensitive booleanValue="false"/>
                    <L7p:Expression1 stringValue="${username}"/>
                    <L7p:Expression2 stringValue=""/>
                    <L7p:Operator operator="EMPTY"/>
                    <L7p:Predicates predicates="included">
                        <L7p:item binary="included">
                            <L7p:CaseSensitive booleanValue="false"/>
                            <L7p:Operator operator="EMPTY"/>
                            <L7p:RightValue stringValue=""/>
                        </L7p:item>
                    </L7p:Predicates>
                </L7p:ComparisonAssertion>
                <L7p:Regex>
                    <L7p:AutoTarget booleanValue="false"/>
                    <L7p:CaptureVar stringValue="authUserCookie"/>
                    <L7p:OtherTargetMessageVariable stringValue="cookie"/>
                    <L7p:PatternContainsVariables booleanValue="true"/>
                    <L7p:Regex stringValue="${cookiename}=([a-zA-Z0-9-_/]{1,128})"/>
                    <L7p:Replacement stringValue=""/>
                    <L7p:Target target="OTHER"/>
                </L7p:Regex>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="JHthdXRoVXNlckNvb2tpZVsxXX0="/>
                    <L7p:VariableToSet stringValue="user_session_key"/>
                </L7p:SetVariable>
                <L7p:Encapsulated>
                    <L7p:EncapsulatedAssertionConfigGuid stringValue="4e4bc164-3fa2-4b15-ba65-31cef45b84b0"/>
                    <L7p:EncapsulatedAssertionConfigName stringValue="OTK Session GET"/>
                    <L7p:Parameters mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="cacheAge"/>
                            <L7p:value stringValue=""/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="cacheId"/>
                            <L7p:value stringValue="userSessionIDCacheV2"/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="cacheKey"/>
                            <L7p:value stringValue="${user_session_key}"/>
                        </L7p:entry>
                    </L7p:Parameters>
                </L7p:Encapsulated>
                <L7p:ResponseXpathAssertion>
                    <L7p:VariablePrefix stringValue="sessionValue"/>
                    <L7p:XmlMsgSrc stringValue="resp"/>
                    <L7p:XpathExpression xpathExpressionValue="included">
                        <L7p:Expression stringValue="/ns:found/ns:value/text()"/>
                        <L7p:Namespaces mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="ns"/>
                                <L7p:value stringValue="http://ns.l7tech.com/2012/11/otk-session"/>
                            </L7p:entry>
                            <L7p:entry>
                                <L7p:key stringValue="s"/>
                                <L7p:value stringValue="http://schemas.xmlsoap.org/soap/envelope/"/>
                            </L7p:entry>
                        </L7p:Namespaces>
                        <L7p:XpathVersion xpathVersion="XPATH_1_0"/>
                    </L7p:XpathExpression>
                </L7p:ResponseXpathAssertion>
                <L7p:EncodeDecode>
                    <L7p:SourceVariableName stringValue="sessionValue.result"/>
                    <L7p:TargetDataType variableDataType="string"/>
                    <L7p:TargetVariableName stringValue="decoded"/>
                    <L7p:TransformType transformType="URL_DECODE"/>
                </L7p:EncodeDecode>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="JHtkZWNvZGVkfQ=="/>
                    <L7p:ContentType stringValue="text/xml;charset=UTF-8"/>
                    <L7p:DataType variableDataType="message"/>
                    <L7p:VariableToSet stringValue="userSession"/>
                </L7p:SetVariable>
                <L7p:ResponseXpathAssertion>
                    <L7p:VariablePrefix stringValue="xpathResourceOwner"/>
                    <L7p:XmlMsgSrc stringValue="userSession"/>
                    <L7p:XpathExpression xpathExpressionValue="included">
                        <L7p:Expression stringValue="/s/resource_owner/text()"/>
                        <L7p:Namespaces mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="s"/>
                                <L7p:value stringValue="http://schemas.xmlsoap.org/soap/envelope/"/>
                            </L7p:entry>
                        </L7p:Namespaces>
                        <L7p:XpathVersion xpathVersion="XPATH_1_0"/>
                    </L7p:XpathExpression>
                </L7p:ResponseXpathAssertion>
                <L7p:ResponseXpathAssertion>
                    <L7p:VariablePrefix stringValue="xpathResourceOwnerSalt"/>
                    <L7p:XmlMsgSrc stringValue="userSession"/>
                    <L7p:XpathExpression xpathExpressionValue="included">
                        <L7p:Expression stringValue="/s/salt/text()"/>
                        <L7p:Namespaces mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="s"/>
                                <L7p:value stringValue="http://schemas.xmlsoap.org/soap/envelope/"/>
                            </L7p:entry>
                        </L7p:Namespaces>
                        <L7p:XpathVersion xpathVersion="XPATH_1_0"/>
                    </L7p:XpathExpression>
                </L7p:ResponseXpathAssertion>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="JHt4cGF0aFJlc291cmNlT3duZXIucmVzdWx0fQ=="/>
                    <L7p:VariableToSet stringValue="current.username"/>
                </L7p:SetVariable>
                <L7p:SetVariable>
                    <L7p:AssertionComment assertionComment="included">
                        <L7p:Properties mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="RIGHT.COMMENT"/>
                                <L7p:value stringValue="Used to create a PPID within an id_token"/>
                            </L7p:entry>
                        </L7p:Properties>
                    </L7p:AssertionComment>
                    <L7p:Base64Expression stringValue="JHt4cGF0aFJlc291cmNlT3duZXJTYWx0LnJlc3VsdH0="/>
                    <L7p:VariableToSet stringValue="salt"/>
                </L7p:SetVariable>
                <L7p:Encapsulated>
                    <L7p:AssertionComment assertionComment="included">
                        <L7p:Properties mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="RIGHT.COMMENT"/>
                                <L7p:value stringValue="// look up user role"/>
                            </L7p:entry>
                        </L7p:Properties>
                    </L7p:AssertionComment>
                    <L7p:EncapsulatedAssertionConfigGuid stringValue="fb3a7c6b-6fc1-47b3-a823-2eecdfa173fe"/>
                    <L7p:EncapsulatedAssertionConfigName stringValue="OTK User Attribute Look Up"/>
                    <L7p:Parameters mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="custom"/>
                            <L7p:value stringValue="${provider}"/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="given_username"/>
                            <L7p:value stringValue="${current.username}"/>
                        </L7p:entry>
                    </L7p:Parameters>
                </L7p:Encapsulated>
                <L7p:assertionComment>
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="LEFT.COMMENT"/>
                            <L7p:value stringValue="Browser Session-Cookie"/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="RIGHT.COMMENT"/>
                            <L7p:value stringValue="Disable this branch if cookies for the authorization server should not be supported"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:assertionComment>
            </wsp:All>
            <wsp:All wsp:Usage="Required">
                <L7p:SetVariable>
                    <L7p:AssertionComment assertionComment="included">
                        <L7p:Properties mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="RIGHT.COMMENT"/>
                                <L7p:value stringValue="Used to create a PPID within an id_token"/>
                            </L7p:entry>
                        </L7p:Properties>
                    </L7p:AssertionComment>
                    <L7p:Base64Expression stringValue="ZmFsc2U="/>
                    <L7p:VariableToSet stringValue="encas_social_login_successful"/>
                </L7p:SetVariable>
                <L7p:Encapsulated>
                    <L7p:EncapsulatedAssertionConfigGuid stringValue="f3776d1f-d2b5-41c5-8176-893d234a841e"/>
                    <L7p:EncapsulatedAssertionConfigName stringValue="MAG User Authentication - Social Login"/>
                    <L7p:NoOpIfConfigMissing booleanValue="true"/>
                </L7p:Encapsulated>
                <L7p:ComparisonAssertion>
                    <L7p:CaseSensitive booleanValue="false"/>
                    <L7p:Expression1 stringValue="${username}"/>
                    <L7p:Expression2 stringValue=""/>
                    <L7p:Operator operator="EMPTY"/>
                    <L7p:Predicates predicates="included">
                        <L7p:item binary="included">
                            <L7p:CaseSensitive booleanValue="false"/>
                            <L7p:Operator operator="EMPTY"/>
                            <L7p:RightValue stringValue=""/>
                        </L7p:item>
                    </L7p:Predicates>
                </L7p:ComparisonAssertion>
                <L7p:ComparisonAssertion>
                    <L7p:Expression1 stringValue="${encas_social_login_successful}"/>
                    <L7p:Expression2 stringValue="true"/>
                    <L7p:Predicates predicates="included">
                        <L7p:item binary="included">
                            <L7p:RightValue stringValue="true"/>
                        </L7p:item>
                    </L7p:Predicates>
                </L7p:ComparisonAssertion>
                <L7p:Encapsulated>
                    <L7p:AssertionComment assertionComment="included">
                        <L7p:Properties mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="RIGHT.COMMENT"/>
                                <L7p:value stringValue="// look up user role"/>
                            </L7p:entry>
                        </L7p:Properties>
                    </L7p:AssertionComment>
                    <L7p:EncapsulatedAssertionConfigGuid stringValue="fb3a7c6b-6fc1-47b3-a823-2eecdfa173fe"/>
                    <L7p:EncapsulatedAssertionConfigName stringValue="OTK User Attribute Look Up"/>
                    <L7p:Parameters mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="custom"/>
                            <L7p:value stringValue="${provider}"/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="given_username"/>
                            <L7p:value stringValue="${current.username}"/>
                        </L7p:entry>
                    </L7p:Parameters>
                </L7p:Encapsulated>
                <L7p:assertionComment>
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="LEFT.COMMENT"/>
                            <L7p:value stringValue="[MAG] Social Login"/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="RIGHT.COMMENT"/>
                            <L7p:value stringValue="Disable this branch if social login with MAG should not be supported"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:assertionComment>
            </wsp:All>
            <wsp:OneOrMore wsp:Usage="Required">
                <wsp:All wsp:Usage="Required">
                    <L7p:ComparisonAssertion>
                        <L7p:CaseSensitive booleanValue="false"/>
                        <L7p:Expression1 stringValue="${error.code}"/>
                        <L7p:Expression2 stringValue=""/>
                        <L7p:Operator operator="EMPTY"/>
                        <L7p:Predicates predicates="included">
                            <L7p:item binary="included">
                                <L7p:CaseSensitive booleanValue="false"/>
                                <L7p:Operator operator="EMPTY"/>
                                <L7p:RightValue stringValue=""/>
                            </L7p:item>
                        </L7p:Predicates>
                    </L7p:ComparisonAssertion>
                    <L7p:AuditDetailAssertion>
                        <L7p:Detail stringValue="Failed to authenticate user!"/>
                    </L7p:AuditDetailAssertion>
                    <L7p:SetVariable>
                        <L7p:Base64Expression stringValue=""/>
                        <L7p:VariableToSet stringValue="current.user.role"/>
                    </L7p:SetVariable>
                    <L7p:SetVariable>
                        <L7p:Base64Expression stringValue="MjAy"/>
                        <L7p:VariableToSet stringValue="error.code"/>
                    </L7p:SetVariable>
                    <L7p:assertionComment>
                        <L7p:Properties mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="LEFT.COMMENT"/>
                                <L7p:value stringValue="Empty"/>
                            </L7p:entry>
                            <L7p:entry>
                                <L7p:key stringValue="RIGHT.COMMENT"/>
                                <L7p:value stringValue="// error.code is empty"/>
                            </L7p:entry>
                        </L7p:Properties>
                    </L7p:assertionComment>
                </wsp:All>
                <L7p:TrueAssertion/>
                <L7p:assertionComment>
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="LEFT.COMMENT"/>
                            <L7p:value stringValue="ERROR"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:assertionComment>
            </wsp:OneOrMore>
            <L7p:assertionComment>
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="LEFT.COMMENT"/>
                        <L7p:value stringValue="authentication"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:assertionComment>
        </wsp:OneOrMore>
        <wsp:OneOrMore wsp:Usage="Required">
            <L7p:ComparisonAssertion>
                <L7p:AssertionComment assertionComment="included">
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="LEFT.COMMENT"/>
                            <L7p:value stringValue="Empty"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:AssertionComment>
                <L7p:CaseSensitive booleanValue="false"/>
                <L7p:Expression1 stringValue="${maxAge}"/>
                <L7p:Expression2 stringValue=""/>
                <L7p:Operator operator="EMPTY"/>
                <L7p:Predicates predicates="included">
                    <L7p:item binary="included">
                        <L7p:CaseSensitive booleanValue="false"/>
                        <L7p:Operator operator="EMPTY"/>
                        <L7p:RightValue stringValue=""/>
                    </L7p:item>
                </L7p:Predicates>
            </L7p:ComparisonAssertion>
            <wsp:All wsp:Usage="Required">
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="JHtjdXJyZW50LnRpbWV9"/>
                    <L7p:DataType variableDataType="dateTime"/>
                    <L7p:DateOffsetExpression stringValue="-${maxAge}"/>
                    <L7p:VariableToSet stringValue="validAuthTime"/>
                </L7p:SetVariable>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="JHt2YWxpZEF1dGhUaW1lLnNlY29uZHN9"/>
                    <L7p:DataType variableDataType="int"/>
                    <L7p:VariableToSet stringValue="validAuthTime"/>
                </L7p:SetVariable>
                <L7p:ComparisonAssertion>
                    <L7p:CaseSensitive booleanValue="false"/>
                    <L7p:Expression1 stringValue="${current.user.authTime}"/>
                    <L7p:Operator operatorNull="null"/>
                    <L7p:Predicates predicates="included">
                        <L7p:item dataType="included">
                            <L7p:Type variableDataType="int"/>
                        </L7p:item>
                        <L7p:item binary="included">
                            <L7p:CaseSensitive booleanValue="false"/>
                            <L7p:Operator operator="GT"/>
                            <L7p:RightValue stringValue="${validAuthTime}"/>
                        </L7p:item>
                    </L7p:Predicates>
                </L7p:ComparisonAssertion>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="JHtleGlzdGluZ0F1dGhUaW1lfQ=="/>
                    <L7p:VariableToSet stringValue="current.user.authTime"/>
                </L7p:SetVariable>
                <L7p:assertionComment>
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="LEFT.COMMENT"/>
                            <L7p:value stringValue="Success"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:assertionComment>
            </wsp:All>
            <wsp:OneOrMore wsp:Usage="Required">
                <wsp:All wsp:Usage="Required">
                    <L7p:ComparisonAssertion>
                        <L7p:CaseSensitive booleanValue="false"/>
                        <L7p:Expression1 stringValue="${error.code}"/>
                        <L7p:Expression2 stringValue=""/>
                        <L7p:Operator operator="EMPTY"/>
                        <L7p:Predicates predicates="included">
                            <L7p:item binary="included">
                                <L7p:CaseSensitive booleanValue="false"/>
                                <L7p:Operator operator="EMPTY"/>
                                <L7p:RightValue stringValue=""/>
                            </L7p:item>
                        </L7p:Predicates>
                    </L7p:ComparisonAssertion>
                    <L7p:AuditDetailAssertion>
                        <L7p:Detail stringValue="auth_time: ${current.user.authTime} is outside valid window: ${validAuthTime}"/>
                    </L7p:AuditDetailAssertion>
                    <L7p:SetVariable>
                        <L7p:Base64Expression stringValue=""/>
                        <L7p:VariableToSet stringValue="current.user.role"/>
                    </L7p:SetVariable>
                    <L7p:SetVariable>
                        <L7p:Base64Expression stringValue="MjAy"/>
                        <L7p:VariableToSet stringValue="error.code"/>
                    </L7p:SetVariable>
                    <L7p:assertionComment>
                        <L7p:Properties mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="LEFT.COMMENT"/>
                                <L7p:value stringValue="Empty"/>
                            </L7p:entry>
                            <L7p:entry>
                                <L7p:key stringValue="RIGHT.COMMENT"/>
                                <L7p:value stringValue="// error.code is empty"/>
                            </L7p:entry>
                        </L7p:Properties>
                    </L7p:assertionComment>
                </wsp:All>
                <L7p:TrueAssertion/>
                <L7p:assertionComment>
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="LEFT.COMMENT"/>
                            <L7p:value stringValue="ERROR"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:assertionComment>
            </wsp:OneOrMore>
            <L7p:assertionComment>
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="LEFT.COMMENT"/>
                        <L7p:value stringValue="Max Age"/>
                    </L7p:entry>
                    <L7p:entry>
                        <L7p:key stringValue="RIGHT.COMMENT"/>
                        <L7p:value stringValue="// check to see if auth_time falls within max_age"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:assertionComment>
        </wsp:OneOrMore>
        <wsp:All wsp:Usage="Required">
            <L7p:ComparisonAssertion>
                <L7p:CaseSensitive booleanValue="false"/>
                <L7p:Expression1 stringValue="${error.code}"/>
                <L7p:Expression2 stringValue=""/>
                <L7p:Operator operator="EMPTY"/>
                <L7p:Predicates predicates="included">
                    <L7p:item binary="included">
                        <L7p:CaseSensitive booleanValue="false"/>
                        <L7p:Operator operator="EMPTY"/>
                        <L7p:RightValue stringValue=""/>
                    </L7p:item>
                </L7p:Predicates>
            </L7p:ComparisonAssertion>
            <L7p:assertionComment>
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="LEFT.COMMENT"/>
                        <L7p:value stringValue="ERROR"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:assertionComment>
        </wsp:All>
    </wsp:All>
</wsp:Policy>