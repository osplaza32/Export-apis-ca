<?xml version="1.0" encoding="UTF-8"?>
<wsp:Policy xmlns:L7p="http://www.layer7tech.com/ws/policy" xmlns:wsp="http://schemas.xmlsoap.org/ws/2002/12/policy">
    <wsp:All wsp:Usage="Required">
        <L7p:CommentAssertion>
            <L7p:Comment stringValue=" ============================================"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue=" === ***  THIS POLICY IS READ ONLY ***"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue=" === If you have the need to customize this policy"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue=" === please contact CA APIM Support so we can improve customization capability"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue=" ============================================"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue="The fragment enables an API/ Service endpoint to require a valid oauth access token"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue="Input: the http request including the oauth header"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue="Output: oauth_consumer_key, oauth_token, oauth_verifier, authorizationHeader"/>
        </L7p:CommentAssertion>
        <L7p:Encapsulated>
            <L7p:EncapsulatedAssertionConfigGuid stringValue="7e2b4f64-e226-4a03-980a-c4603163acc0"/>
            <L7p:EncapsulatedAssertionConfigName stringValue="OTK OVP Configuration"/>
        </L7p:Encapsulated>
        <L7p:Include>
            <L7p:PolicyGuid stringValue="b1f54732-14d9-43a1-841e-d76dedfe24af"/>
        </L7p:Include>
        <wsp:OneOrMore wsp:Usage="Required">
            <L7p:ComparisonAssertion>
                <L7p:Expression1 stringValue="${oauth.requestType}"/>
                <L7p:Expression2 stringValue="access token"/>
                <L7p:Predicates predicates="included">
                    <L7p:item binary="included">
                        <L7p:RightValue stringValue="access token"/>
                    </L7p:item>
                </L7p:Predicates>
            </L7p:ComparisonAssertion>
            <wsp:All wsp:Usage="Required">
                <L7p:HardcodedResponse>
                    <L7p:AssertionComment assertionComment="included">
                        <L7p:Properties mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="LEFT.COMMENT"/>
                                <L7p:value stringValue="400"/>
                            </L7p:entry>
                        </L7p:Properties>
                    </L7p:AssertionComment>
                    <L7p:Base64ResponseBody stringValue="SW52YWxpZCBvYXV0aCBwYXJhbWV0ZXJz"/>
                    <L7p:EarlyResponse booleanValue="true"/>
                    <L7p:ResponseStatus stringValue="400"/>
                </L7p:HardcodedResponse>
                <L7p:FalseAssertion/>
                <L7p:assertionComment>
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="RIGHT.COMMENT"/>
                            <L7p:value stringValue="Wrong request type"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:assertionComment>
            </wsp:All>
            <L7p:assertionComment>
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="RIGHT.COMMENT"/>
                        <L7p:value stringValue="Check request type"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:assertionComment>
        </wsp:OneOrMore>
        <wsp:All wsp:Usage="Required">
            <L7p:SetVariable>
                <L7p:Base64Expression stringValue="JHtwYXJhbXN9"/>
                <L7p:ContentType stringValue="application/x-www-form-urlencoded"/>
                <L7p:DataType variableDataType="message"/>
                <L7p:VariableToSet stringValue="params"/>
            </L7p:SetVariable>
            <L7p:HttpRoutingAssertion>
                <L7p:CurrentSecurityHeaderHandling intValue="3"/>
                <L7p:FailOnErrorStatus booleanValue="false"/>
                <L7p:HttpMethod httpMethod="POST"/>
                <L7p:ProtectedServiceUrl stringValue="${host_oauth_ovp_server}/oauth/validation/validate/v1/signature"/>
                <L7p:ProxyPassword stringValueNull="null"/>
                <L7p:ProxyUsername stringValueNull="null"/>
                <L7p:RequestHeaderRules httpPassthroughRuleSet="included">
                    <L7p:Rules httpPassthroughRules="included"/>
                </L7p:RequestHeaderRules>
                <L7p:RequestMsgSrc stringValue="params"/>
                <L7p:RequestParamRules httpPassthroughRuleSet="included">
                    <L7p:Rules httpPassthroughRules="included"/>
                </L7p:RequestParamRules>
                <L7p:ResponseHeaderRules httpPassthroughRuleSet="included">
                    <L7p:ForwardAll booleanValue="true"/>
                    <L7p:Rules httpPassthroughRules="included"/>
                </L7p:ResponseHeaderRules>
                <L7p:ResponseMsgDest stringValue="validationResult"/>
                <L7p:SamlAssertionVersion intValue="2"/>
            </L7p:HttpRoutingAssertion>
            <wsp:OneOrMore wsp:Usage="Required">
                <wsp:All wsp:Usage="Required">
                    <L7p:ResponseXpathAssertion>
                        <L7p:VariablePrefix stringValue=""/>
                        <L7p:XmlMsgSrc stringValue="validationResult"/>
                        <L7p:XpathExpression xpathExpressionValue="included">
                            <L7p:Expression stringValue="/ns:validation/ns:result[text()='valid']"/>
                            <L7p:Namespaces mapValue="included">
                                <L7p:entry>
                                    <L7p:key stringValue="ns"/>
                                    <L7p:value stringValue="http://ns.l7tech.com/2012/11/otk-ovp"/>
                                </L7p:entry>
                                <L7p:entry>
                                    <L7p:key stringValue="s"/>
                                    <L7p:value stringValue="http://schemas.xmlsoap.org/soap/envelope/"/>
                                </L7p:entry>
                            </L7p:Namespaces>
                            <L7p:XpathVersion xpathVersion="XPATH_1_0"/>
                        </L7p:XpathExpression>
                    </L7p:ResponseXpathAssertion>
                </wsp:All>
                <wsp:All wsp:Usage="Required">
                    <L7p:ResponseXpathAssertion>
                        <L7p:VariablePrefix stringValue="xpathError"/>
                        <L7p:XmlMsgSrc stringValue="validationResult"/>
                        <L7p:XpathExpression xpathExpressionValue="included">
                            <L7p:Expression stringValue="/ns:validation/ns:error/text()"/>
                            <L7p:Namespaces mapValue="included">
                                <L7p:entry>
                                    <L7p:key stringValue="ns"/>
                                    <L7p:value stringValue="http://ns.l7tech.com/2012/11/otk-ovp"/>
                                </L7p:entry>
                                <L7p:entry>
                                    <L7p:key stringValue="s"/>
                                    <L7p:value stringValue="http://schemas.xmlsoap.org/soap/envelope/"/>
                                </L7p:entry>
                            </L7p:Namespaces>
                            <L7p:XpathVersion xpathVersion="XPATH_1_0"/>
                        </L7p:XpathExpression>
                    </L7p:ResponseXpathAssertion>
                    <L7p:HardcodedResponse>
                        <L7p:AssertionComment assertionComment="included">
                            <L7p:Properties mapValue="included">
                                <L7p:entry>
                                    <L7p:key stringValue="LEFT.COMMENT"/>
                                    <L7p:value stringValue="401"/>
                                </L7p:entry>
                            </L7p:Properties>
                        </L7p:AssertionComment>
                        <L7p:Base64ResponseBody stringValue="JHt4cGF0aEVycm9yLnJlc3VsdH0="/>
                        <L7p:EarlyResponse booleanValue="true"/>
                        <L7p:ResponseStatus stringValue="401"/>
                    </L7p:HardcodedResponse>
                    <L7p:FalseAssertion/>
                    <L7p:assertionComment>
                        <L7p:Properties mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="RIGHT.COMMENT"/>
                                <L7p:value stringValue="validation failure"/>
                            </L7p:entry>
                        </L7p:Properties>
                    </L7p:assertionComment>
                </wsp:All>
            </wsp:OneOrMore>
            <L7p:assertionComment>
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="RIGHT.COMMENT"/>
                        <L7p:value stringValue="Validate signature"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:assertionComment>
        </wsp:All>
    </wsp:All>
</wsp:Policy>