<?xml version="1.0" encoding="UTF-8"?>
<wsp:Policy xmlns:L7p="http://www.layer7tech.com/ws/policy" xmlns:wsp="http://schemas.xmlsoap.org/ws/2002/12/policy">
    <wsp:All wsp:Usage="Required">
        <L7p:CommentAssertion>
            <L7p:Comment stringValue="************************************************************************************"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue="* Policy for Syncing Portal Account Plans onto the tenant gateway"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue="*"/>
        </L7p:CommentAssertion>
        <L7p:CommentAssertion>
            <L7p:Comment stringValue="************************************************************************************"/>
        </L7p:CommentAssertion>
        <L7p:Encapsulated>
            <L7p:EncapsulatedAssertionConfigGuid stringValue="ed1e3112-5df8-4769-8436-09ddb1362f88"/>
            <L7p:EncapsulatedAssertionConfigName stringValue="portalosencass"/>
            <L7p:Parameters mapValue="included">
                <L7p:entry>
                    <L7p:key stringValue="defaultHost"/>
                    <L7p:value stringValue="${gateway.portal.config.pssg.host}"/>
                </L7p:entry>
                <L7p:entry>
                    <L7p:key stringValue="defaultPort"/>
                    <L7p:value stringValue="9447"/>
                </L7p:entry>
                <L7p:entry>
                    <L7p:key stringValue="hostName"/>
                    <L7p:value stringValue="${gateway.portal.config.pssg.sync.host}"/>
                </L7p:entry>
                <L7p:entry>
                    <L7p:key stringValue="port"/>
                    <L7p:value stringValue="${gateway.portal.config.pssg.sync.port}"/>
                </L7p:entry>
            </L7p:Parameters>
        </L7p:Encapsulated>
        <L7p:HttpRoutingAssertion>
            <L7p:AssertionComment assertionComment="included">
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="LEFT.COMMENT"/>
                        <L7p:value stringValue="get from portal"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:AssertionComment>
            <L7p:HttpMethod httpMethod="GET"/>
            <L7p:KeyAlias stringValue="portalman"/>
            <L7p:NonDefaultKeystoreId goidValue="00000000000000000000000000000002"/>
            <L7p:ProtectedServiceUrl stringValue="https://${outputHost}:${outputPort}/sync/accounts?identifier=${gateway.portal.config.identifier}&amp;nodeId=${gateway.portal.config.node.id}"/>
            <L7p:ProxyPassword stringValueNull="null"/>
            <L7p:ProxyUsername stringValueNull="null"/>
            <L7p:RequestHeaderRules httpPassthroughRuleSet="included">
                <L7p:ForwardAll booleanValue="true"/>
                <L7p:Rules httpPassthroughRules="included">
                    <L7p:item httpPassthroughRule="included">
                        <L7p:Name stringValue="Cookie"/>
                    </L7p:item>
                    <L7p:item httpPassthroughRule="included">
                        <L7p:Name stringValue="SOAPAction"/>
                    </L7p:item>
                </L7p:Rules>
            </L7p:RequestHeaderRules>
            <L7p:RequestParamRules httpPassthroughRuleSet="included">
                <L7p:ForwardAll booleanValue="true"/>
                <L7p:Rules httpPassthroughRules="included"/>
            </L7p:RequestParamRules>
            <L7p:ResponseHeaderRules httpPassthroughRuleSet="included">
                <L7p:ForwardAll booleanValue="true"/>
                <L7p:Rules httpPassthroughRules="included">
                    <L7p:item httpPassthroughRule="included">
                        <L7p:Name stringValue="Set-Cookie"/>
                    </L7p:item>
                </L7p:Rules>
            </L7p:ResponseHeaderRules>
            <L7p:ResponseMsgDest stringValue="httpResponse1"/>
            <L7p:SamlAssertionVersion intValue="2"/>
            <L7p:UsesDefaultKeyStore booleanValue="false"/>
        </L7p:HttpRoutingAssertion>
        <L7p:SetVariable>
            <L7p:Base64Expression stringValue="YXBpUGxhbg=="/>
            <L7p:VariableToSet stringValue="cacheKey"/>
        </L7p:SetVariable>
        <L7p:SetVariable>
            <L7p:Base64Expression stringValue="JHtnYXRld2F5LnBvcnRhbC5zeW5jLmFjY291bnQucGxhbi5jYWNoZS5hZ2V9"/>
            <L7p:VariableToSet stringValue="cacheAge"/>
        </L7p:SetVariable>
        <L7p:SetVariable>
            <L7p:Base64Expression stringValue=""/>
            <L7p:ContentType stringValue="text/xml; charset=utf-8"/>
            <L7p:DataType variableDataType="message"/>
            <L7p:VariableToSet stringValue="empty.message"/>
        </L7p:SetVariable>
        <L7p:GenerateSecurityHash>
            <L7p:Algorithm stringValue="MD5"/>
            <L7p:Base64Data stringValue="JHtodHRwUmVzcG9uc2UxLm1haW5wYXJ0fQ=="/>
            <L7p:LineBreak lineBreak="CR-LF"/>
            <L7p:TargetOutputVariable stringValue="encodedApis"/>
        </L7p:GenerateSecurityHash>
        <wsp:OneOrMore wsp:Usage="Required">
            <L7p:CacheLookup>
                <L7p:CacheEntryKey stringValue="${cacheKey}"/>
                <L7p:CacheId stringValue="portal"/>
                <L7p:ContentTypeOverride stringValue=""/>
                <L7p:MaxEntryAgeSeconds stringValue="${cacheAge}"/>
                <L7p:OtherTargetMessageVariable stringValue="prevApi"/>
                <L7p:Target target="OTHER"/>
            </L7p:CacheLookup>
            <L7p:TrueAssertion/>
        </wsp:OneOrMore>
        <wsp:OneOrMore wsp:Usage="Required">
            <wsp:All wsp:Usage="Required">
                <L7p:ComparisonAssertion>
                    <L7p:CaseSensitive booleanValue="false"/>
                    <L7p:Expression1 stringValue="${encodedApis}"/>
                    <L7p:Operator operatorNull="null"/>
                    <L7p:Predicates predicates="included">
                        <L7p:item dataType="included">
                            <L7p:Type variableDataType="string"/>
                        </L7p:item>
                        <L7p:item binary="included">
                            <L7p:RightValue stringValue="${prevApi.mainpart}"/>
                        </L7p:item>
                    </L7p:Predicates>
                </L7p:ComparisonAssertion>
                <L7p:assertionComment>
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="LEFT.COMMENT"/>
                            <L7p:value stringValue="do nothing if no change from portal"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:assertionComment>
            </wsp:All>
            <wsp:All wsp:Usage="Required">
                <L7p:CacheStorage>
                    <L7p:CacheEntryKey stringValue="${cacheKey}"/>
                    <L7p:CacheId stringValue="portal"/>
                    <L7p:MaxEntryAgeSeconds stringValue="${cacheAge}"/>
                    <L7p:OtherTargetMessageVariable stringValue="encodedApis"/>
                    <L7p:Target target="OTHER"/>
                </L7p:CacheStorage>
                <wsp:OneOrMore wsp:Usage="Required">
                    <wsp:All wsp:Usage="Required">
                        <L7p:JSONSchema>
                            <L7p:OtherTargetMessageVariable stringValue="httpResponse1"/>
                            <L7p:ResourceInfo staticResourceInfo="included">
                                <L7p:Document stringValueReference="inline"><![CDATA[{
  "type": "object",
  "properties": {
    "accounts": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "PlanId": {
            "type": "string"
          },
          "Name": {
            "type": "string"
          },
          "DefaultPlan": {
            "type": "string"
          }
        }
      }
    }
  },
  "required": [
    "accounts"
  ]
}]]></L7p:Document>
                            </L7p:ResourceInfo>
                            <L7p:Target target="OTHER"/>
                        </L7p:JSONSchema>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="dHJ1ZQ=="/>
                            <L7p:VariableToSet stringValue="validJson"/>
                        </L7p:SetVariable>
                    </wsp:All>
                    <wsp:All wsp:Usage="Required">
                        <L7p:AuditDetailAssertion>
                            <L7p:Detail stringValue="Failed to sync Portal Account Plans: invalid sync response"/>
                            <L7p:Level stringValue="WARNING"/>
                        </L7p:AuditDetailAssertion>
                        <L7p:AuditDetailAssertion>
                            <L7p:Detail stringValue="${httpResponse1.mainpart}"/>
                        </L7p:AuditDetailAssertion>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="ZmFsc2U="/>
                            <L7p:VariableToSet stringValue="validJson"/>
                        </L7p:SetVariable>
                    </wsp:All>
                    <L7p:assertionComment>
                        <L7p:Properties mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="LEFT.COMMENT"/>
                                <L7p:value stringValue="validate json"/>
                            </L7p:entry>
                        </L7p:Properties>
                    </L7p:assertionComment>
                </wsp:OneOrMore>
                <wsp:OneOrMore wsp:Usage="Required">
                    <L7p:ComparisonAssertion>
                        <L7p:CaseSensitive booleanValue="false"/>
                        <L7p:Expression1 stringValue="${validJson}"/>
                        <L7p:Operator operatorNull="null"/>
                        <L7p:Predicates predicates="included">
                            <L7p:item dataType="included">
                                <L7p:Type variableDataType="boolean"/>
                            </L7p:item>
                            <L7p:item binary="included">
                                <L7p:CaseSensitive booleanValue="false"/>
                                <L7p:RightValue stringValue="false"/>
                            </L7p:item>
                        </L7p:Predicates>
                    </L7p:ComparisonAssertion>
                    <wsp:All wsp:Usage="Required">
                        <L7p:CommentAssertion>
                            <L7p:Comment stringValue="//--------------------- account plan list"/>
                        </L7p:CommentAssertion>
                        <L7p:SetVariable>
                            <L7p:AssertionComment assertionComment="included">
                                <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="LEFT.COMMENT"/>
                                    <L7p:value stringValue="start building account plans"/>
                                    </L7p:entry>
                                </L7p:Properties>
                            </L7p:AssertionComment>
                            <L7p:Base64Expression stringValue="PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9InllcyI/Pg0KPGw3OkFjY291bnRQbGFucyB4bWxuczpsNz0iaHR0cDovL25zLmw3dGVjaC5jb20vMjAxMi8wNC9hcGktbWFuYWdlbWVudCIvPg=="/>
                            <L7p:ContentType stringValue="application/xml; charset=utf-8"/>
                            <L7p:DataType variableDataType="message"/>
                            <L7p:VariableToSet stringValue="accountPlansXml"/>
                        </L7p:SetVariable>
                        <L7p:ResponseXpathAssertion>
                            <L7p:AssertionComment assertionComment="included">
                                <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="LEFT.COMMENT"/>
                                    <L7p:value stringValue="find account plans element"/>
                                    </L7p:entry>
                                </L7p:Properties>
                            </L7p:AssertionComment>
                            <L7p:VariablePrefix stringValue="accountPlansElement"/>
                            <L7p:XmlMsgSrc stringValue="accountPlansXml"/>
                            <L7p:XpathExpression xpathExpressionValue="included">
                                <L7p:Expression stringValue="/l7:AccountPlans"/>
                                <L7p:Namespaces mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="l7"/>
                                    <L7p:value stringValue="http://ns.l7tech.com/2012/04/api-management"/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="s"/>
                                    <L7p:value stringValue="http://schemas.xmlsoap.org/soap/envelope/"/>
                                    </L7p:entry>
                                </L7p:Namespaces>
                                <L7p:XpathVersion xpathVersion="XPATH_1_0"/>
                            </L7p:XpathExpression>
                        </L7p:ResponseXpathAssertion>
                        <wsp:OneOrMore wsp:Usage="Required">
                            <L7p:EvaluateJsonPathExpression>
                                <L7p:Expression stringValue="accounts"/>
                                <L7p:OtherTargetMessageVariable stringValue="httpResponse1"/>
                                <L7p:Target target="OTHER"/>
                            </L7p:EvaluateJsonPathExpression>
                            <L7p:TrueAssertion/>
                            <L7p:assertionComment>
                                <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="LEFT.COMMENT"/>
                                    <L7p:value stringValue="extract portal account plan list"/>
                                    </L7p:entry>
                                </L7p:Properties>
                            </L7p:assertionComment>
                        </wsp:OneOrMore>
                        <L7p:ForEachLoop L7p:Usage="Required"
                            loopVariable="jsonPath.results" variablePrefix="results">
                            <L7p:SetVariable>
                                <L7p:Base64Expression stringValue="JHtyZXN1bHRzLmN1cnJlbnR9"/>
                                <L7p:ContentType stringValue="application/json; charset=utf-8"/>
                                <L7p:DataType variableDataType="message"/>
                                <L7p:VariableToSet stringValue="props"/>
                            </L7p:SetVariable>
                            <L7p:EvaluateJsonPathExpression>
                                <L7p:Expression stringValue="Name"/>
                                <L7p:OtherTargetMessageVariable stringValue="props"/>
                                <L7p:Target target="OTHER"/>
                                <L7p:VariablePrefix stringValue="name"/>
                            </L7p:EvaluateJsonPathExpression>
                            <L7p:EvaluateJsonPathExpression>
                                <L7p:Expression stringValue="PlanId"/>
                                <L7p:OtherTargetMessageVariable stringValue="props"/>
                                <L7p:Target target="OTHER"/>
                                <L7p:VariablePrefix stringValue="planId"/>
                            </L7p:EvaluateJsonPathExpression>
                            <L7p:EvaluateJsonPathExpression>
                                <L7p:Expression stringValue="DefaultPlan"/>
                                <L7p:OtherTargetMessageVariable stringValue="props"/>
                                <L7p:Target target="OTHER"/>
                                <L7p:VariablePrefix stringValue="defaultPlan"/>
                            </L7p:EvaluateJsonPathExpression>
                            <L7p:Encapsulated>
                                <L7p:EncapsulatedAssertionConfigGuid stringValue="5821066a-15a6-4523-a8f7-3d159129cdb5"/>
                                <L7p:EncapsulatedAssertionConfigName stringValue="Portal Escape XML"/>
                                <L7p:Parameters mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="escapedXml"/>
                                    <L7p:value stringValue="${name.result}"/>
                                    </L7p:entry>
                                </L7p:Parameters>
                            </L7p:Encapsulated>
                            <L7p:SetVariable>
                                <L7p:Base64Expression stringValue="JHtlc2NhcGVkWG1sfQ=="/>
                                <L7p:VariableToSet stringValue="escapedName"/>
                            </L7p:SetVariable>
                            <L7p:SetVariable>
                                <L7p:AssertionComment assertionComment="included">
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="LEFT.COMMENT"/>
                                    <L7p:value stringValue="build account plan xml"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                </L7p:AssertionComment>
                                <L7p:Base64Expression stringValue="PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4NCjxsNzpBY2NvdW50UGxhbiB4bWxuczpsNz0iaHR0cDovL25zLmw3dGVjaC5jb20vMjAxMi8wNC9hcGktbWFuYWdlbWVudCI+DQogICA8bDc6UGxhbklkPiR7cGxhbklkLnJlc3VsdH08L2w3OlBsYW5JZD4NCiAgIDxsNzpQbGFuTmFtZT4ke2VzY2FwZWROYW1lfTwvbDc6UGxhbk5hbWU+DQogICA8bDc6RGVmYXVsdFBsYW4+JHtkZWZhdWx0UGxhbi5yZXN1bHR9PC9sNzpEZWZhdWx0UGxhbj4NCiAgIDxsNzpQbGFuRGV0YWlscy8+DQogICA8bDc6UGxhbk1hcHBpbmcvPg0KPC9sNzpBY2NvdW50UGxhbj4="/>
                                <L7p:ContentType stringValue="text/xml; charset=utf-8"/>
                                <L7p:DataType variableDataType="message"/>
                                <L7p:VariableToSet stringValue="accountPlanXml"/>
                            </L7p:SetVariable>
                            <L7p:ResponseXpathAssertion>
                                <L7p:AssertionComment assertionComment="included">
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="LEFT.COMMENT"/>
                                    <L7p:value stringValue="find account plans element"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                </L7p:AssertionComment>
                                <L7p:VariablePrefix stringValue="planDetailsElement"/>
                                <L7p:XmlMsgSrc stringValue="accountPlanXml"/>
                                <L7p:XpathExpression xpathExpressionValue="included">
                                    <L7p:Expression stringValue="/l7:AccountPlan/l7:PlanDetails"/>
                                    <L7p:Namespaces mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="l7"/>
                                    <L7p:value stringValue="http://ns.l7tech.com/2012/04/api-management"/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="s"/>
                                    <L7p:value stringValue="http://schemas.xmlsoap.org/soap/envelope/"/>
                                    </L7p:entry>
                                    </L7p:Namespaces>
                                    <L7p:XpathVersion xpathVersion="XPATH_1_0"/>
                                </L7p:XpathExpression>
                            </L7p:ResponseXpathAssertion>
                            <wsp:OneOrMore wsp:Usage="Required">
                                <wsp:All wsp:Usage="Required">
                                    <L7p:EvaluateJsonPathExpression>
                                    <L7p:Expression stringValue="ThroughputQuota"/>
                                    <L7p:OtherTargetMessageVariable stringValue="props"/>
                                    <L7p:Target target="OTHER"/>
                                    <L7p:VariablePrefix stringValue="throughputQuota"/>
                                    </L7p:EvaluateJsonPathExpression>
                                    <L7p:ComparisonAssertion>
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:Expression1 stringValue="${throughputQuota.found}"/>
                                    <L7p:Operator operatorNull="null"/>
                                    <L7p:Predicates predicates="included">
                                    <L7p:item dataType="included">
                                    <L7p:Type variableDataType="boolean"/>
                                    </L7p:item>
                                    <L7p:item binary="included">
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:RightValue stringValue="true"/>
                                    </L7p:item>
                                    </L7p:Predicates>
                                    </L7p:ComparisonAssertion>
                                    <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="JHt0aHJvdWdocHV0UXVvdGEucmVzdWx0fQ=="/>
                                    <L7p:ContentType stringValue="application/json; charset=utf-8"/>
                                    <L7p:DataType variableDataType="message"/>
                                    <L7p:VariableToSet stringValue="quotaJson"/>
                                    </L7p:SetVariable>
                                    <L7p:EvaluateJsonPathExpression>
                                    <L7p:Expression stringValue="Quota"/>
                                    <L7p:OtherTargetMessageVariable stringValue="quotaJson"/>
                                    <L7p:Target target="OTHER"/>
                                    <L7p:VariablePrefix stringValue="quota"/>
                                    </L7p:EvaluateJsonPathExpression>
                                    <L7p:EvaluateJsonPathExpression>
                                    <L7p:Expression stringValue="TimeUnit"/>
                                    <L7p:OtherTargetMessageVariable stringValue="quotaJson"/>
                                    <L7p:Target target="OTHER"/>
                                    <L7p:VariablePrefix stringValue="timeUnit"/>
                                    </L7p:EvaluateJsonPathExpression>
                                    <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4NCjxsNzpUaHJvdWdocHV0UXVvdGEgbDc6ZW5hYmxlZD0idHJ1ZSIgeG1sbnM6bDc9Imh0dHA6Ly9ucy5sN3RlY2guY29tLzIwMTIvMDQvYXBpLW1hbmFnZW1lbnQiPg0KCTxsNzpRdW90YT4ke3F1b3RhLnJlc3VsdH08L2w3OlF1b3RhPg0KCTxsNzpUaW1lVW5pdD4ke3RpbWVVbml0LnJlc3VsdH08L2w3OlRpbWVVbml0Pg0KCTxsNzpDb3VudGVyU3RyYXRlZ3k+MjwvbDc6Q291bnRlclN0cmF0ZWd5Pg0KPC9sNzpUaHJvdWdocHV0UXVvdGE+"/>
                                    <L7p:ContentType stringValue="text/xml; charset=utf-8"/>
                                    <L7p:DataType variableDataType="message"/>
                                    <L7p:VariableToSet stringValue="throughputQuotaXml"/>
                                    </L7p:SetVariable>
                                    <L7p:RemoveElement>
                                    <L7p:ElementFromVariable stringValue="planDetailsElement.elements[0]"/>
                                    <L7p:ElementToInsertVariable stringValue="throughputQuotaXml.mainpart"/>
                                    <L7p:InsertedElementLocation insertedElementLocation="LAST_CHILD"/>
                                    <L7p:OtherTargetMessageVariable stringValue="accountPlanXml"/>
                                    <L7p:Target target="OTHER"/>
                                    </L7p:RemoveElement>
                                </wsp:All>
                                <L7p:TrueAssertion/>
                                <L7p:assertionComment>
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="LEFT.COMMENT"/>
                                    <L7p:value stringValue="ThroughputQuota"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                </L7p:assertionComment>
                            </wsp:OneOrMore>
                            <wsp:OneOrMore wsp:Usage="Required">
                                <wsp:All wsp:Usage="Required">
                                    <L7p:EvaluateJsonPathExpression>
                                    <L7p:Expression stringValue="RateLimit"/>
                                    <L7p:OtherTargetMessageVariable stringValue="props"/>
                                    <L7p:Target target="OTHER"/>
                                    <L7p:VariablePrefix stringValue="rateLimit"/>
                                    </L7p:EvaluateJsonPathExpression>
                                    <L7p:ComparisonAssertion>
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:Expression1 stringValue="${rateLimit.found}"/>
                                    <L7p:Operator operatorNull="null"/>
                                    <L7p:Predicates predicates="included">
                                    <L7p:item dataType="included">
                                    <L7p:Type variableDataType="boolean"/>
                                    </L7p:item>
                                    <L7p:item binary="included">
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:RightValue stringValue="true"/>
                                    </L7p:item>
                                    </L7p:Predicates>
                                    </L7p:ComparisonAssertion>
                                    <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="JHtyYXRlTGltaXQucmVzdWx0fQ=="/>
                                    <L7p:ContentType stringValue="application/json; charset=utf-8"/>
                                    <L7p:DataType variableDataType="message"/>
                                    <L7p:VariableToSet stringValue="rateLimitJson"/>
                                    </L7p:SetVariable>
                                    <L7p:EvaluateJsonPathExpression>
                                    <L7p:Expression stringValue="MaxRequestRate"/>
                                    <L7p:OtherTargetMessageVariable stringValue="rateLimitJson"/>
                                    <L7p:Target target="OTHER"/>
                                    <L7p:VariablePrefix stringValue="maxRequestRate"/>
                                    </L7p:EvaluateJsonPathExpression>
                                    <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4NCjxsNzpSYXRlTGltaXQgbDc6ZW5hYmxlZD0idHJ1ZSIgeG1sbnM6bDc9Imh0dHA6Ly9ucy5sN3RlY2guY29tLzIwMTIvMDQvYXBpLW1hbmFnZW1lbnQiPg0KCTxsNzpNYXhSZXF1ZXN0UmF0ZT4ke21heFJlcXVlc3RSYXRlLnJlc3VsdH08L2w3Ok1heFJlcXVlc3RSYXRlPg0KCTxsNzpXaW5kb3dTaXplSW5TZWNvbmRzPjYwPC9sNzpXaW5kb3dTaXplSW5TZWNvbmRzPg0KCTxsNzpIYXJkTGltaXQ+dHJ1ZTwvbDc6SGFyZExpbWl0Pg0KPC9sNzpSYXRlTGltaXQ+"/>
                                    <L7p:ContentType stringValue="text/xml; charset=utf-8"/>
                                    <L7p:DataType variableDataType="message"/>
                                    <L7p:VariableToSet stringValue="rateLimitXml"/>
                                    </L7p:SetVariable>
                                    <L7p:RemoveElement>
                                    <L7p:ElementFromVariable stringValue="planDetailsElement.elements[0]"/>
                                    <L7p:ElementToInsertVariable stringValue="rateLimitXml.mainpart"/>
                                    <L7p:InsertedElementLocation insertedElementLocation="LAST_CHILD"/>
                                    <L7p:OtherTargetMessageVariable stringValue="accountPlanXml"/>
                                    <L7p:Target target="OTHER"/>
                                    </L7p:RemoveElement>
                                </wsp:All>
                                <L7p:TrueAssertion/>
                                <L7p:assertionComment>
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="LEFT.COMMENT"/>
                                    <L7p:value stringValue="RateLimit"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                </L7p:assertionComment>
                            </wsp:OneOrMore>
                            <wsp:OneOrMore wsp:Usage="Required">
                                <wsp:All wsp:Usage="Required">
                                    <L7p:EvaluateJsonPathExpression>
                                    <L7p:Expression stringValue="PlanMapping"/>
                                    <L7p:OtherTargetMessageVariable stringValue="props"/>
                                    <L7p:Target target="OTHER"/>
                                    <L7p:VariablePrefix stringValue="planMapping"/>
                                    </L7p:EvaluateJsonPathExpression>
                                    <L7p:ComparisonAssertion>
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:Expression1 stringValue="${planMapping.found}"/>
                                    <L7p:MultivaluedComparison multivaluedComparison="FIRST"/>
                                    <L7p:Operator operatorNull="null"/>
                                    <L7p:Predicates predicates="included">
                                    <L7p:item dataType="included">
                                    <L7p:Type variableDataType="boolean"/>
                                    </L7p:item>
                                    <L7p:item binary="included">
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:RightValue stringValue="true"/>
                                    </L7p:item>
                                    </L7p:Predicates>
                                    </L7p:ComparisonAssertion>
                                    <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="JHtwbGFuTWFwcGluZy5yZXN1bHRzfQ=="/>
                                    <L7p:ContentType stringValue="application/json; charset=utf-8"/>
                                    <L7p:DataType variableDataType="message"/>
                                    <L7p:VariableToSet stringValue="mappingIds"/>
                                    </L7p:SetVariable>
                                    <L7p:ResponseXpathAssertion>
                                    <L7p:AssertionComment assertionComment="included">
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="LEFT.COMMENT"/>
                                    <L7p:value stringValue="find plan mapping element"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:AssertionComment>
                                    <L7p:VariablePrefix stringValue="planMappingElement"/>
                                    <L7p:XmlMsgSrc stringValue="accountPlanXml"/>
                                    <L7p:XpathExpression xpathExpressionValue="included">
                                    <L7p:Expression stringValue="/l7:AccountPlan/l7:PlanMapping"/>
                                    <L7p:Namespaces mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="l7"/>
                                    <L7p:value stringValue="http://ns.l7tech.com/2012/04/api-management"/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="s"/>
                                    <L7p:value stringValue="http://schemas.xmlsoap.org/soap/envelope/"/>
                                    </L7p:entry>
                                    </L7p:Namespaces>
                                    <L7p:XpathVersion xpathVersion="XPATH_1_0"/>
                                    </L7p:XpathExpression>
                                    </L7p:ResponseXpathAssertion>
                                    <L7p:Join>
                                    <L7p:InputVariable stringValue="planMapping.results"/>
                                    <L7p:OutputVariable stringValue="planMappingIds"/>
                                    </L7p:Join>
                                    <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4NCjxsNzpJZHMgeG1sbnM6bDc9Imh0dHA6Ly9ucy5sN3RlY2guY29tLzIwMTIvMDQvYXBpLW1hbmFnZW1lbnQiPiR7cGxhbk1hcHBpbmdJZHN9PC9sNzpJZHM+"/>
                                    <L7p:ContentType stringValue="text/xml; charset=utf-8"/>
                                    <L7p:DataType variableDataType="message"/>
                                    <L7p:VariableToSet stringValue="idsXml"/>
                                    </L7p:SetVariable>
                                    <L7p:RemoveElement>
                                    <L7p:ElementFromVariable stringValue="planMappingElement.elements[0]"/>
                                    <L7p:ElementToInsertVariable stringValue="idsXml.mainpart"/>
                                    <L7p:InsertedElementLocation insertedElementLocation="LAST_CHILD"/>
                                    <L7p:OtherTargetMessageVariable stringValue="accountPlanXml"/>
                                    <L7p:Target target="OTHER"/>
                                    </L7p:RemoveElement>
                                </wsp:All>
                                <L7p:TrueAssertion/>
                                <L7p:assertionComment>
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="LEFT.COMMENT"/>
                                    <L7p:value stringValue="PlanMappings"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                </L7p:assertionComment>
                            </wsp:OneOrMore>
                            <L7p:RemoveElement>
                                <L7p:ElementFromVariable stringValue="accountPlansElement.elements[0]"/>
                                <L7p:ElementToInsertVariable stringValue="accountPlanXml.mainpart"/>
                                <L7p:InsertedElementLocation insertedElementLocation="LAST_CHILD"/>
                                <L7p:OtherTargetMessageVariable stringValue="accountPlansXml"/>
                                <L7p:Target target="OTHER"/>
                            </L7p:RemoveElement>
                            <L7p:assertionComment>
                                <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="LEFT.COMMENT"/>
                                    <L7p:value stringValue="for each plan"/>
                                    </L7p:entry>
                                </L7p:Properties>
                            </L7p:assertionComment>
                        </L7p:ForEachLoop>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="dHJ1ZQ=="/>
                            <L7p:VariableToSet stringValue="pman.options.removeOmitted"/>
                        </L7p:SetVariable>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="UFVU"/>
                            <L7p:VariableToSet stringValue="pman.operation"/>
                        </L7p:SetVariable>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="LzEvYWNjb3VudC9wbGFucw=="/>
                            <L7p:VariableToSet stringValue="pman.resUri"/>
                        </L7p:SetVariable>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="JHtnYXRld2F5LnBvcnRhbC5hY2NvdW50LnBsYW5zLmZyYWdtZW50Lmd1aWR9"/>
                            <L7p:VariableToSet stringValue="pman.options.policyGUID"/>
                        </L7p:SetVariable>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="ZmFsc2U="/>
                            <L7p:VariableToSet stringValue="pman.options.asyncUpdate"/>
                        </L7p:SetVariable>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="JHthY2NvdW50UGxhbnNYbWwubWFpbnBhcnR9"/>
                            <L7p:VariableToSet stringValue="pman.resource"/>
                        </L7p:SetVariable>
                        <L7p:ManagePortalResource/>
                        <wsp:OneOrMore wsp:Usage="Required">
                            <wsp:All wsp:Usage="Required">
                                <L7p:ComparisonAssertion>
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:Expression1 stringValue="${pman.resp.status}"/>
                                    <L7p:MultivaluedComparison multivaluedComparison="FIRST"/>
                                    <L7p:Operator operatorNull="null"/>
                                    <L7p:Predicates predicates="included">
                                    <L7p:item dataType="included">
                                    <L7p:Type variableDataType="int"/>
                                    </L7p:item>
                                    <L7p:item binary="included">
                                    <L7p:RightValue stringValue="200"/>
                                    </L7p:item>
                                    </L7p:Predicates>
                                </L7p:ComparisonAssertion>
                                <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="JHtwbWFuLnJlc1VyaX0="/>
                                    <L7p:VariableToSet stringValue="pman.resUri.orig"/>
                                </L7p:SetVariable>
                                <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="JHtwbWFuLm9wZXJhdGlvbn0="/>
                                    <L7p:VariableToSet stringValue="pman.operation.orig"/>
                                </L7p:SetVariable>
                                <L7p:SetVariable>
                                    <L7p:AssertionComment assertionComment="included">
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="//query all API Plans for processing"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:AssertionComment>
                                    <L7p:Base64Expression stringValue="LzEvYWNjb3VudC9wbGFucw=="/>
                                    <L7p:VariableToSet stringValue="pman.resUri"/>
                                </L7p:SetVariable>
                                <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="R0VU"/>
                                    <L7p:VariableToSet stringValue="pman.operation"/>
                                </L7p:SetVariable>
                                <L7p:ManagePortalResource/>
                                <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="JHtwbWFuLnJlc3AucmVzb3VyY2V9"/>
                                    <L7p:ContentType stringValue="text/xml; charset=utf-8"/>
                                    <L7p:DataType variableDataType="message"/>
                                    <L7p:VariableToSet stringValue="accountPlans"/>
                                </L7p:SetVariable>
                                <L7p:Encapsulated>
                                    <L7p:EncapsulatedAssertionConfigGuid stringValue="10bfae36-858f-4aa7-9b3d-67935e57bdcd"/>
                                    <L7p:EncapsulatedAssertionConfigName stringValue="Portal Reload Account Plans Fragment"/>
                                </L7p:Encapsulated>
                                <L7p:assertionComment>
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="LEFT.COMMENT"/>
                                    <L7p:value stringValue="sync successful"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                </L7p:assertionComment>
                            </wsp:All>
                            <L7p:TrueAssertion/>
                            <L7p:assertionComment>
                                <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="LEFT.COMMENT"/>
                                    <L7p:value stringValue="reload account plans fragment"/>
                                    </L7p:entry>
                                </L7p:Properties>
                            </L7p:assertionComment>
                        </wsp:OneOrMore>
                        <wsp:OneOrMore wsp:Usage="Required">
                            <wsp:All wsp:Usage="Required">
                                <L7p:ComparisonAssertion>
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:Expression1 stringValue="${errorCode}"/>
                                    <L7p:MultivaluedComparison multivaluedComparison="FIRST"/>
                                    <L7p:Operator operatorNull="null"/>
                                    <L7p:Predicates predicates="included">
                                    <L7p:item dataType="included">
                                    <L7p:Type variableDataType="string"/>
                                    </L7p:item>
                                    <L7p:item binary="included">
                                    <L7p:Operator operator="NE"/>
                                    <L7p:RightValue stringValue="0"/>
                                    </L7p:item>
                                    </L7p:Predicates>
                                </L7p:ComparisonAssertion>
                                <L7p:AuditDetailAssertion>
                                    <L7p:Detail stringValue="Failed to sync Portal Account Plans: failed to update account plans fragment"/>
                                    <L7p:Level stringValue="WARNING"/>
                                </L7p:AuditDetailAssertion>
                            </wsp:All>
                            <wsp:All wsp:Usage="Required">
                                <L7p:ComparisonAssertion>
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:Expression1 stringValue="${pman.resp.status}"/>
                                    <L7p:MultivaluedComparison multivaluedComparison="FIRST"/>
                                    <L7p:Operator operatorNull="null"/>
                                    <L7p:Predicates predicates="included">
                                    <L7p:item dataType="included">
                                    <L7p:Type variableDataType="int"/>
                                    </L7p:item>
                                    <L7p:item binary="included">
                                    <L7p:RightValue stringValue="200"/>
                                    </L7p:item>
                                    </L7p:Predicates>
                                </L7p:ComparisonAssertion>
                                <L7p:AuditDetailAssertion>
                                    <L7p:Detail stringValue="Portal Account Plans sync completed"/>
                                    <L7p:LoggingOnly booleanValue="true"/>
                                </L7p:AuditDetailAssertion>
                                <L7p:assertionComment>
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="LEFT.COMMENT"/>
                                    <L7p:value stringValue="sync successful"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                </L7p:assertionComment>
                            </wsp:All>
                            <wsp:All wsp:Usage="Required">
                                <L7p:AuditDetailAssertion>
                                    <L7p:Detail stringValue="Failed to sync Portal Account Plans: ${pman.resp.detail}"/>
                                    <L7p:Level stringValue="WARNING"/>
                                </L7p:AuditDetailAssertion>
                                <L7p:assertionComment>
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="LEFT.COMMENT"/>
                                    <L7p:value stringValue="sync failed"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                </L7p:assertionComment>
                            </wsp:All>
                            <L7p:assertionComment>
                                <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="LEFT.COMMENT"/>
                                    <L7p:value stringValue="report"/>
                                    </L7p:entry>
                                </L7p:Properties>
                            </L7p:assertionComment>
                        </wsp:OneOrMore>
                    </wsp:All>
                </wsp:OneOrMore>
                <L7p:assertionComment>
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="LEFT.COMMENT"/>
                            <L7p:value stringValue="update account plans"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:assertionComment>
            </wsp:All>
        </wsp:OneOrMore>
        <wsp:All wsp:Usage="Required">
            <L7p:Include>
                <L7p:PolicyGuid stringValue="53af9c54-c545-47ae-8d78-88944a997251"/>
            </L7p:Include>
            <L7p:SetVariable>
                <L7p:Base64Expression stringValue="MS4wL3NjaGVkdWxlZFRhc2tzP25hbWU9UG9ydGFsJTIwU3luYyUyMEFjY291bnQlMjBQbGFu"/>
                <L7p:VariableToSet stringValue="restGatewayMan.uri"/>
            </L7p:SetVariable>
            <L7p:SetVariable>
                <L7p:Base64Expression stringValue="R0VU"/>
                <L7p:VariableToSet stringValue="restGatewayMan.action"/>
            </L7p:SetVariable>
            <L7p:RESTGatewayManagement>
                <L7p:OtherTargetMessageVariable stringValue="empty.message"/>
                <L7p:Target target="OTHER"/>
            </L7p:RESTGatewayManagement>
            <L7p:ResponseXpathAssertion>
                <L7p:VariablePrefix stringValue="cron"/>
                <L7p:XpathExpression xpathExpressionValue="included">
                    <L7p:Expression stringValue="/l7:List/l7:Item/l7:Resource/l7:ScheduledTask/l7:CronExpression/text()"/>
                    <L7p:Namespaces mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="s"/>
                            <L7p:value stringValue="http://schemas.xmlsoap.org/soap/envelope/"/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="l7"/>
                            <L7p:value stringValue="http://ns.l7tech.com/2010/04/gateway-management"/>
                        </L7p:entry>
                    </L7p:Namespaces>
                    <L7p:XpathVersion xpathVersion="XPATH_1_0"/>
                </L7p:XpathExpression>
            </L7p:ResponseXpathAssertion>
            <L7p:SetVariable>
                <L7p:Base64Expression stringValue="ew0KImNvdW50IjogIiR7YWNjb3VudFBsYW5Db3VudC5yZXN1bHR9IiwNCiJjcm9uIjogIiR7Y3Jvbi5yZXN1bHR9Ig0KfQ=="/>
                <L7p:ContentType stringValue="application/json; charset=utf-8"/>
                <L7p:DataType variableDataType="message"/>
                <L7p:VariableToSet stringValue="postJson"/>
            </L7p:SetVariable>
            <L7p:Encapsulated>
                <L7p:EncapsulatedAssertionConfigGuid stringValue="ed1e3112-5df8-4769-8436-09ddb1362f88"/>
                <L7p:EncapsulatedAssertionConfigName stringValue="portalosencass"/>
                <L7p:Parameters mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="defaultHost"/>
                        <L7p:value stringValue="${gateway.portal.config.pssg.host}"/>
                    </L7p:entry>
                    <L7p:entry>
                        <L7p:key stringValue="defaultPort"/>
                        <L7p:value stringValue="9447"/>
                    </L7p:entry>
                    <L7p:entry>
                        <L7p:key stringValue="hostName"/>
                        <L7p:value stringValue="${gateway.portal.config.pssg.sync.host}"/>
                    </L7p:entry>
                    <L7p:entry>
                        <L7p:key stringValue="port"/>
                        <L7p:value stringValue="${gateway.portal.config.pssg.sync.port}"/>
                    </L7p:entry>
                </L7p:Parameters>
            </L7p:Encapsulated>
            <L7p:HttpRoutingAssertion>
                <L7p:AssertionComment assertionComment="included">
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="LEFT.COMMENT"/>
                            <L7p:value stringValue="post count and cron to portal"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:AssertionComment>
                <L7p:HttpMethod httpMethod="POST"/>
                <L7p:KeyAlias stringValue="portalman"/>
                <L7p:NonDefaultKeystoreId goidValue="00000000000000000000000000000002"/>
                <L7p:ProtectedServiceUrl stringValue="https://${outputHost}:${outputPort}/sync/accounts?identifier=${gateway.portal.config.identifier}&amp;nodeId=${gateway.portal.config.node.id}"/>
                <L7p:ProxyPassword stringValueNull="null"/>
                <L7p:ProxyUsername stringValueNull="null"/>
                <L7p:RequestHeaderRules httpPassthroughRuleSet="included">
                    <L7p:ForwardAll booleanValue="true"/>
                    <L7p:Rules httpPassthroughRules="included">
                        <L7p:item httpPassthroughRule="included">
                            <L7p:Name stringValue="Cookie"/>
                        </L7p:item>
                        <L7p:item httpPassthroughRule="included">
                            <L7p:Name stringValue="SOAPAction"/>
                        </L7p:item>
                    </L7p:Rules>
                </L7p:RequestHeaderRules>
                <L7p:RequestMsgSrc stringValue="postJson"/>
                <L7p:RequestParamRules httpPassthroughRuleSet="included">
                    <L7p:ForwardAll booleanValue="true"/>
                    <L7p:Rules httpPassthroughRules="included"/>
                </L7p:RequestParamRules>
                <L7p:ResponseHeaderRules httpPassthroughRuleSet="included">
                    <L7p:ForwardAll booleanValue="true"/>
                    <L7p:Rules httpPassthroughRules="included">
                        <L7p:item httpPassthroughRule="included">
                            <L7p:Name stringValue="Set-Cookie"/>
                        </L7p:item>
                    </L7p:Rules>
                </L7p:ResponseHeaderRules>
                <L7p:ResponseMsgDest stringValue="httpResponse1"/>
                <L7p:SamlAssertionVersion intValue="2"/>
                <L7p:UsesDefaultKeyStore booleanValue="false"/>
            </L7p:HttpRoutingAssertion>
        </wsp:All>
    </wsp:All>
</wsp:Policy>