<?xml version="1.0" encoding="UTF-8"?>
<wsp:Policy xmlns:L7p="http://www.layer7tech.com/ws/policy" xmlns:wsp="http://schemas.xmlsoap.org/ws/2002/12/policy">
    <wsp:All wsp:Usage="Required">
        <L7p:SetVariable>
            <L7p:Base64Expression stringValue=""/>
            <L7p:ContentType stringValue="text/xml; charset=utf-8"/>
            <L7p:DataType variableDataType="message"/>
            <L7p:VariableToSet stringValue="empty.message"/>
        </L7p:SetVariable>
        <L7p:SetVariable>
            <L7p:Base64Expression stringValue="JHtodHRwUmVzcG9uc2UxLm1haW5wYXJ0fQ=="/>
            <L7p:ContentType stringValue="application/json; charset=utf-8"/>
            <L7p:DataType variableDataType="message"/>
            <L7p:VariableToSet stringValue="incomingJson"/>
        </L7p:SetVariable>
        <L7p:Encapsulated>
            <L7p:EncapsulatedAssertionConfigGuid stringValue="e6970550-1d92-4d95-8c07-e7c8082ec073"/>
            <L7p:EncapsulatedAssertionConfigName stringValue="Portal API Key Sync"/>
            <L7p:Parameters mapValue="included">
                <L7p:entry>
                    <L7p:key stringValue="incomingJson"/>
                    <L7p:value stringValue="incomingJson"/>
                </L7p:entry>
            </L7p:Parameters>
        </L7p:Encapsulated>
        <wsp:OneOrMore wsp:Usage="Required">
            <wsp:All wsp:Usage="Required">
                <L7p:EvaluateJsonPathExpression>
                    <L7p:Expression stringValue="incrementStart"/>
                    <L7p:OtherTargetMessageVariable stringValue="incomingJson"/>
                    <L7p:Target target="OTHER"/>
                    <L7p:VariablePrefix stringValue="incomngJson.incrementStart"/>
                </L7p:EvaluateJsonPathExpression>
                <L7p:EvaluateJsonPathExpression>
                    <L7p:Expression stringValue="bulkSync"/>
                    <L7p:OtherTargetMessageVariable stringValue="incomingJson"/>
                    <L7p:Target target="OTHER"/>
                    <L7p:VariablePrefix stringValue="incomngJson.bulkSync"/>
                </L7p:EvaluateJsonPathExpression>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="MS4wL3NjaGVkdWxlZFRhc2tzP25hbWU9UG9ydGFsJTIwU3luYyUyMEFwcGxpY2F0aW9u"/>
                    <L7p:VariableToSet stringValue="restGatewayMan.uri"/>
                </L7p:SetVariable>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="R0VU"/>
                    <L7p:VariableToSet stringValue="restGatewayMan.action"/>
                </L7p:SetVariable>
                <L7p:RESTGatewayManagement>
                    <L7p:OtherTargetMessageVariable stringValue="empty.message"/>
                    <L7p:Target target="OTHER"/>
                </L7p:RESTGatewayManagement>
                <L7p:ResponseXpathAssertion>
                    <L7p:VariablePrefix stringValue="cron"/>
                    <L7p:XpathExpression xpathExpressionValue="included">
                        <L7p:Expression stringValue="/l7:List/l7:Item/l7:Resource/l7:ScheduledTask/l7:CronExpression/text()"/>
                        <L7p:Namespaces mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="s"/>
                                <L7p:value stringValue="http://schemas.xmlsoap.org/soap/envelope/"/>
                            </L7p:entry>
                            <L7p:entry>
                                <L7p:key stringValue="l7"/>
                                <L7p:value stringValue="http://ns.l7tech.com/2010/04/gateway-management"/>
                            </L7p:entry>
                        </L7p:Namespaces>
                        <L7p:XpathVersion xpathVersion="XPATH_1_0"/>
                    </L7p:XpathExpression>
                </L7p:ResponseXpathAssertion>
                <wsp:OneOrMore wsp:Usage="Required">
                    <wsp:All wsp:Usage="Required">
                        <L7p:Encapsulated>
                            <L7p:EncapsulatedAssertionConfigGuid stringValue="4338292f-e9cf-458d-97b0-f10e884d4072"/>
                            <L7p:EncapsulatedAssertionConfigName stringValue="Portal API Key Count"/>
                        </L7p:Encapsulated>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="JHthcGlrZXljb3VudH0="/>
                            <L7p:VariableToSet stringValue="apiKeyCount.count"/>
                        </L7p:SetVariable>
                        <L7p:assertionComment>
                            <L7p:Properties mapValue="included">
                                <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="//use encass if avaialable starting otk 4.1"/>
                                </L7p:entry>
                            </L7p:Properties>
                        </L7p:assertionComment>
                    </wsp:All>
                    <L7p:JdbcQuery>
                        <L7p:ConnectionName stringValue="OAuth"/>
                        <L7p:ConvertVariablesToStrings booleanValue="false"/>
                        <L7p:NamingMap mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="count(*)"/>
                                <L7p:value stringValue="count"/>
                            </L7p:entry>
                        </L7p:NamingMap>
                        <L7p:SqlQuery stringValue="select count(*) from portal_apikey"/>
                        <L7p:VariablePrefix stringValue="apiKeyCount"/>
                    </L7p:JdbcQuery>
                    <L7p:assertionComment>
                        <L7p:Properties mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="RIGHT.COMMENT"/>
                                <L7p:value stringValue="//get app count"/>
                            </L7p:entry>
                        </L7p:Properties>
                    </L7p:assertionComment>
                </wsp:OneOrMore>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="eyANCiAgImluY3JlbWVudFN0YXJ0IiA6ICR7aW5jcmVtZW50U3RhcnR9LCANCiAgImluY3JlbWVudEVuZCIgOiAke2luY29tbmdKc29uLmluY3JlbWVudFN0YXJ0LnJlc3VsdH0sIA0KICAiYnVsa1N5bmMiIDogIiR7aW5jb21uZ0pzb24uYnVsa3N5bmMucmVzdWx0fSIsIA0KICAiZW50aXR5VHlwZSIgOiAiQVBQTElDQVRJT04iLA=="/>
                    <L7p:VariableToSet stringValue="postback"/>
                </L7p:SetVariable>
                <wsp:OneOrMore wsp:Usage="Required">
                    <wsp:All wsp:Usage="Required">
                        <L7p:ComparisonAssertion>
                            <L7p:Expression1 stringValue="${error.code}"/>
                            <L7p:Expression2 stringValue="sdfd"/>
                            <L7p:Operator operator="EMPTY"/>
                            <L7p:Predicates predicates="included">
                                <L7p:item binary="included">
                                    <L7p:Operator operator="EMPTY"/>
                                    <L7p:RightValue stringValue="sdfd"/>
                                </L7p:item>
                            </L7p:Predicates>
                        </L7p:ComparisonAssertion>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="MS4wL2J1bmRsZQ=="/>
                            <L7p:VariableToSet stringValue="restGatewayMan.uri"/>
                        </L7p:SetVariable>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="UFVU"/>
                            <L7p:VariableToSet stringValue="restGatewayMan.action"/>
                        </L7p:SetVariable>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="PGw3OkJ1bmRsZSB4bWxuczpsNz0iaHR0cDovL25zLmw3dGVjaC5jb20vMjAxMC8wNC9nYXRld2F5LW1hbmFnZW1lbnQiPg0KICAgIDxsNzpSZWZlcmVuY2VzPg0KPGw3Okl0ZW0geG1sbnM6bDc9Imh0dHA6Ly9ucy5sN3RlY2guY29tLzIwMTAvMDQvZ2F0ZXdheS1tYW5hZ2VtZW50Ij4NCiAgICA8bDc6TmFtZT5wb3J0YWwuYXBwbGljYXRpb24uaW5jcmVtZW50LnN0YXJ0PC9sNzpOYW1lPg0KICAgIDxsNzpJZD5iZjc0ZTBkNjUzNmRiNDVmZWFhMjY1ZDFjNzYwYjM1ODwvbDc6SWQ+DQogICAgPGw3OlR5cGU+Q0xVU1RFUl9QUk9QRVJUWTwvbDc6VHlwZT4NCiAgICA8bDc6UmVzb3VyY2U+DQogICAgICAgIDxsNzpDbHVzdGVyUHJvcGVydHkgaWQ9ImJmNzRlMGQ2NTM2ZGI0NWZlYWEyNjVkMWM3NjBiMzU4IiB2ZXJzaW9uPSIxMiI+DQogICAgICAgICAgIDxsNzpOYW1lPnBvcnRhbC5hcHBsaWNhdGlvbi5pbmNyZW1lbnQuc3RhcnQ8L2w3Ok5hbWU+DQogICAgICAgICAgIDxsNzpWYWx1ZT4ke2luY29tbmdKc29uLmluY3JlbWVudFN0YXJ0LnJlc3VsdH08L2w3OlZhbHVlPg0KICAgICAgIDwvbDc6Q2x1c3RlclByb3BlcnR5Pg0KICAgIDwvbDc6UmVzb3VyY2U+DQo8L2w3Okl0ZW0+DQogICAgPC9sNzpSZWZlcmVuY2VzPg0KICAgIDxsNzpNYXBwaW5ncz4NCiAgICAgICAgICAgIDxsNzpNYXBwaW5nIGFjdGlvbj0iTmV3T3JVcGRhdGUiIHNyY0lkPSJiZjc0ZTBkNjUzNmRiNDVmZWFhMjY1ZDFjNzYwYjM1OCIgdHlwZT0iQ0xVU1RFUl9QUk9QRVJUWSI+DQogICAgICA8bDc6UHJvcGVydGllcz4NCiAgICAgICAgPGw3OlByb3BlcnR5IGtleT0iTWFwQnkiPg0KICAgICAgICAgIDxsNzpTdHJpbmdWYWx1ZT5uYW1lPC9sNzpTdHJpbmdWYWx1ZT4NCiAgICAgICAgPC9sNzpQcm9wZXJ0eT4NCiAgICAgICAgPGw3OlByb3BlcnR5IGtleT0iRmFpbE9uTmV3Ij4NCiAgICAgICAgICA8bDc6Qm9vbGVhblZhbHVlPnRydWU8L2w3OkJvb2xlYW5WYWx1ZT4NCiAgICAgICAgPC9sNzpQcm9wZXJ0eT4NCiAgICAgIDwvbDc6UHJvcGVydGllcz4NCiAgICA8L2w3Ok1hcHBpbmc+DQogICAgPC9sNzpNYXBwaW5ncz4NCjwvbDc6QnVuZGxlPg0K"/>
                            <L7p:ContentType stringValue="text/xml; charset=utf-8"/>
                            <L7p:DataType variableDataType="message"/>
                            <L7p:VariableToSet stringValue="clusterPropertyBundle"/>
                        </L7p:SetVariable>
                        <L7p:RESTGatewayManagement>
                            <L7p:AssertionComment assertionComment="included">
                                <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="LEFT.COMMENT"/>
                                    <L7p:value stringValue="update increment start"/>
                                    </L7p:entry>
                                </L7p:Properties>
                            </L7p:AssertionComment>
                            <L7p:OtherTargetMessageVariable stringValue="clusterPropertyBundle"/>
                            <L7p:Target target="OTHER"/>
                        </L7p:RESTGatewayManagement>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="JHtwb3N0YmFja30NCiAgImVycm9yTWVzc2FnZSIgOiAiIiwgDQogICJpbmNyZW1lbnRTdGF0dXMiIDogIm9rIiwgDQogICJlbnRpdHlFcnJvcnMiIDogW10sICA="/>
                            <L7p:VariableToSet stringValue="postback"/>
                        </L7p:SetVariable>
                        <L7p:AuditDetailAssertion>
                            <L7p:Detail stringValue="${syncSuccessMsg}"/>
                            <L7p:LoggingOnly booleanValue="true"/>
                        </L7p:AuditDetailAssertion>
                        <L7p:assertionComment>
                            <L7p:Properties mapValue="included">
                                <L7p:entry>
                                    <L7p:key stringValue="LEFT.COMMENT"/>
                                    <L7p:value stringValue="success"/>
                                </L7p:entry>
                            </L7p:Properties>
                        </L7p:assertionComment>
                    </wsp:All>
                    <wsp:All wsp:Usage="Required">
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="QVBQTElDQVRJT04="/>
                            <L7p:VariableToSet stringValue="portal.sync.increment.type"/>
                        </L7p:SetVariable>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="JHtwb3N0YmFja30NCiAgImVycm9yTWVzc2FnZSIgOiAiZmFpbCIsIA0KICAiaW5jcmVtZW50U3RhdHVzIiA6ICJlcnJvciIsIA0KICAiZW50aXR5RXJyb3JzIiA6IFtdLCAg"/>
                            <L7p:VariableToSet stringValue="postback"/>
                        </L7p:SetVariable>
                        <L7p:AuditDetailAssertion>
                            <L7p:Detail stringValue="${syncFailMsg}"/>
                            <L7p:Level stringValue="WARNING"/>
                        </L7p:AuditDetailAssertion>
                        <L7p:assertionComment>
                            <L7p:Properties mapValue="included">
                                <L7p:entry>
                                    <L7p:key stringValue="LEFT.COMMENT"/>
                                    <L7p:value stringValue="error"/>
                                </L7p:entry>
                            </L7p:Properties>
                        </L7p:assertionComment>
                    </wsp:All>
                </wsp:OneOrMore>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="JHtwb3N0YmFja30gDQogICJzeW5jTG9nIiA6ICJ7XCJjb3VudFwiIDogXCIke2FwaUtleUNvdW50LmNvdW50fVwiLCBcImNyb25cIiA6IFwiJHtjcm9uLnJlc3VsdH1cIn0iDQp9DQo="/>
                    <L7p:VariableToSet stringValue="postback"/>
                </L7p:SetVariable>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="JHtwb3N0YmFja30="/>
                    <L7p:ContentType stringValue="application/json; charset=utf-8"/>
                    <L7p:DataType variableDataType="message"/>
                    <L7p:VariableToSet stringValue="postbackMessage"/>
                </L7p:SetVariable>
                <L7p:HttpRoutingAssertion>
                    <L7p:AssertionComment assertionComment="included">
                        <L7p:Properties mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="LEFT.COMMENT"/>
                                <L7p:value stringValue="post postback to portal"/>
                            </L7p:entry>
                        </L7p:Properties>
                    </L7p:AssertionComment>
                    <L7p:HttpMethod httpMethod="POST"/>
                    <L7p:KeyAlias stringValue="portalman"/>
                    <L7p:NonDefaultKeystoreId goidValue="00000000000000000000000000000002"/>
                    <L7p:ProtectedServiceUrl stringValue="${postbackUrl}"/>
                    <L7p:ProxyPassword stringValueNull="null"/>
                    <L7p:ProxyUsername stringValueNull="null"/>
                    <L7p:RequestHeaderRules httpPassthroughRuleSet="included">
                        <L7p:ForwardAll booleanValue="true"/>
                        <L7p:Rules httpPassthroughRules="included">
                            <L7p:item httpPassthroughRule="included">
                                <L7p:Name stringValue="Cookie"/>
                            </L7p:item>
                            <L7p:item httpPassthroughRule="included">
                                <L7p:Name stringValue="SOAPAction"/>
                            </L7p:item>
                        </L7p:Rules>
                    </L7p:RequestHeaderRules>
                    <L7p:RequestMsgSrc stringValue="postbackMessage"/>
                    <L7p:RequestParamRules httpPassthroughRuleSet="included">
                        <L7p:ForwardAll booleanValue="true"/>
                        <L7p:Rules httpPassthroughRules="included"/>
                    </L7p:RequestParamRules>
                    <L7p:ResponseHeaderRules httpPassthroughRuleSet="included">
                        <L7p:ForwardAll booleanValue="true"/>
                        <L7p:Rules httpPassthroughRules="included">
                            <L7p:item httpPassthroughRule="included">
                                <L7p:Name stringValue="Set-Cookie"/>
                            </L7p:item>
                        </L7p:Rules>
                    </L7p:ResponseHeaderRules>
                    <L7p:ResponseMsgDest stringValue="httpResponse1"/>
                    <L7p:SamlAssertionVersion intValue="2"/>
                    <L7p:UsesDefaultKeyStore booleanValue="false"/>
                </L7p:HttpRoutingAssertion>
            </wsp:All>
            <wsp:All wsp:Usage="Required">
                <L7p:AuditDetailAssertion>
                    <L7p:Detail stringValue="${syncFailMsg}"/>
                    <L7p:Level stringValue="WARNING"/>
                </L7p:AuditDetailAssertion>
            </wsp:All>
        </wsp:OneOrMore>
    </wsp:All>
</wsp:Policy>