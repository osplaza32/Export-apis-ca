<?xml version="1.0" encoding="UTF-8"?>
<wsp:Policy xmlns:L7p="http://www.layer7tech.com/ws/policy" xmlns:wsp="http://schemas.xmlsoap.org/ws/2002/12/policy">
    <wsp:All wsp:Usage="Required">
        <wsp:All wsp:Usage="Required">
            <L7p:CommentAssertion>
                <L7p:Comment stringValue="API Portal Authentication SAML Token Validation Service"/>
            </L7p:CommentAssertion>
            <L7p:ComparisonAssertion>
                <L7p:CaseSensitive booleanValue="false"/>
                <L7p:Expression1 stringValue="${request.url.path}"/>
                <L7p:MultivaluedComparison multivaluedComparison="FAIL"/>
                <L7p:Operator operatorNull="null"/>
                <L7p:Predicates predicates="included">
                    <L7p:item regex="included">
                        <L7p:Pattern stringValue=".*/sso/validateSaml"/>
                    </L7p:item>
                </L7p:Predicates>
            </L7p:ComparisonAssertion>
            <L7p:SetVariable>
                <L7p:Base64Expression stringValue="MA=="/>
                <L7p:VariableToSet stringValue="errorCode"/>
            </L7p:SetVariable>
            <L7p:SetVariable>
                <L7p:Base64Expression stringValue=""/>
                <L7p:VariableToSet stringValue="errorMsg"/>
            </L7p:SetVariable>
            <L7p:SetVariable>
                <L7p:Base64Expression stringValue="Mi41"/>
                <L7p:VariableToSet stringValue="VERSION"/>
            </L7p:SetVariable>
            <wsp:OneOrMore wsp:Usage="Required">
                <wsp:All wsp:Usage="Required">
                    <L7p:ComparisonAssertion>
                        <L7p:Expression1 stringValue="${request.http.method}"/>
                        <L7p:Expression2 stringValue="POST"/>
                        <L7p:MultivaluedComparison multivaluedComparison="FAIL"/>
                        <L7p:Predicates predicates="included">
                            <L7p:item binary="included">
                                <L7p:RightValue stringValue="POST"/>
                            </L7p:item>
                        </L7p:Predicates>
                    </L7p:ComparisonAssertion>
                </wsp:All>
                <wsp:All wsp:Usage="Required">
                    <L7p:SetVariable>
                        <L7p:Base64Expression stringValue="NDAw"/>
                        <L7p:VariableToSet stringValue="errorCode"/>
                    </L7p:SetVariable>
                    <L7p:SetVariable>
                        <L7p:Base64Expression stringValue="SW52YWxpZCByZXF1ZXN0IG1ldGhvZA=="/>
                        <L7p:VariableToSet stringValue="errorMsg"/>
                    </L7p:SetVariable>
                </wsp:All>
            </wsp:OneOrMore>
            <wsp:OneOrMore wsp:Usage="Required">
                <L7p:ComparisonAssertion>
                    <L7p:CaseSensitive booleanValue="false"/>
                    <L7p:Expression1 stringValue="${errorCode}"/>
                    <L7p:Operator operatorNull="null"/>
                    <L7p:Predicates predicates="included">
                        <L7p:item dataType="included">
                            <L7p:Type variableDataType="string"/>
                        </L7p:item>
                        <L7p:item binary="included">
                            <L7p:Negated booleanValue="true"/>
                            <L7p:RightValue stringValue="0"/>
                        </L7p:item>
                    </L7p:Predicates>
                </L7p:ComparisonAssertion>
                <wsp:All wsp:Usage="Required">
                    <L7p:SetVariable>
                        <L7p:Base64Expression stringValue="JHtyZXF1ZXN0Lmh0dHAucGFyYW1ldGVyLlJlbGF5U3RhdGV9"/>
                        <L7p:VariableToSet stringValue="relayState"/>
                    </L7p:SetVariable>
                    <wsp:OneOrMore wsp:Usage="Required">
                        <wsp:All wsp:Usage="Required">
                            <L7p:ComparisonAssertion>
                                <L7p:CaseSensitive booleanValue="false"/>
                                <L7p:Expression1 stringValue="${samlTokenAttributeIn}"/>
                                <L7p:Expression2 stringValue="parameter"/>
                                <L7p:MultivaluedComparison multivaluedComparison="FAIL"/>
                                <L7p:Predicates predicates="included">
                                    <L7p:item binary="included">
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:RightValue stringValue="parameter"/>
                                    </L7p:item>
                                </L7p:Predicates>
                            </L7p:ComparisonAssertion>
                            <L7p:LookupDynamicContextVariables>
                                <L7p:SourceVariable stringValue="request.http.parameter.${samlTokenAttribute}"/>
                                <L7p:TargetDataType variableDataType="string"/>
                                <L7p:TargetOutputVariablePrefix stringValue="samlToken"/>
                            </L7p:LookupDynamicContextVariables>
                            <L7p:SetVariable>
                                <L7p:Base64Expression stringValue="JHtzYW1sVG9rZW4ub3V0cHV0fQ=="/>
                                <L7p:VariableToSet stringValue="samlResponse"/>
                            </L7p:SetVariable>
                        </wsp:All>
                        <wsp:All wsp:Usage="Required">
                            <L7p:ComparisonAssertion>
                                <L7p:CaseSensitive booleanValue="false"/>
                                <L7p:Expression1 stringValue="${samlTokenAttributeIn}"/>
                                <L7p:Expression2 stringValue="header"/>
                                <L7p:MultivaluedComparison multivaluedComparison="FAIL"/>
                                <L7p:Predicates predicates="included">
                                    <L7p:item binary="included">
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:RightValue stringValue="header"/>
                                    </L7p:item>
                                </L7p:Predicates>
                            </L7p:ComparisonAssertion>
                            <L7p:LookupDynamicContextVariables>
                                <L7p:SourceVariable stringValue="request.http.header.${samlTokenAttribute}"/>
                                <L7p:TargetDataType variableDataType="string"/>
                                <L7p:TargetOutputVariablePrefix stringValue="samlToken"/>
                            </L7p:LookupDynamicContextVariables>
                            <L7p:SetVariable>
                                <L7p:Base64Expression stringValue="JHtzYW1sVG9rZW4ub3V0cHV0fQ=="/>
                                <L7p:VariableToSet stringValue="samlResponse"/>
                            </L7p:SetVariable>
                        </wsp:All>
                        <wsp:All wsp:Usage="Required">
                            <L7p:ComparisonAssertion>
                                <L7p:CaseSensitive booleanValue="false"/>
                                <L7p:Expression1 stringValue="${samlTokenAttributeIn}"/>
                                <L7p:Expression2 stringValue="cookie"/>
                                <L7p:MultivaluedComparison multivaluedComparison="FAIL"/>
                                <L7p:Predicates predicates="included">
                                    <L7p:item binary="included">
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:RightValue stringValue="cookie"/>
                                    </L7p:item>
                                </L7p:Predicates>
                            </L7p:ComparisonAssertion>
                            <L7p:LookupDynamicContextVariables>
                                <L7p:SourceVariable stringValue="request.http.cookievalues.${samlTokenAttribute}"/>
                                <L7p:TargetDataType variableDataType="string"/>
                                <L7p:TargetOutputVariablePrefix stringValue="samlToken"/>
                            </L7p:LookupDynamicContextVariables>
                            <L7p:SetVariable>
                                <L7p:Base64Expression stringValue="JHtzYW1sVG9rZW4ub3V0cHV0fQ=="/>
                                <L7p:VariableToSet stringValue="samlResponse"/>
                            </L7p:SetVariable>
                        </wsp:All>
                        <L7p:FalseAssertion/>
                    </wsp:OneOrMore>
                    <L7p:EncodeDecode>
                        <L7p:SourceVariableName stringValue="samlResponse"/>
                        <L7p:TargetDataType variableDataType="string"/>
                        <L7p:TargetVariableName stringValue="decodedSaml"/>
                        <L7p:TransformType transformType="BASE64_DECODE"/>
                    </L7p:EncodeDecode>
                    <L7p:SetVariable>
                        <L7p:Base64Expression stringValue="JHtkZWNvZGVkU2FtbH0="/>
                        <L7p:ContentType stringValue="text/xml; charset=utf-8"/>
                        <L7p:DataType variableDataType="message"/>
                        <L7p:VariableToSet stringValue="samlArt"/>
                    </L7p:SetVariable>
                    <wsp:OneOrMore wsp:Usage="Required">
                        <wsp:All wsp:Usage="Required">
                            <L7p:SamlpResponseEvaluation>
                                <L7p:AttributeStatement samlAttributeInfo="included">
                                    <L7p:Attributes samlAttributeElementInfoArray="included">
                                    <L7p:item samlAttributeElementInfo="included">
                                    <L7p:AnyValue booleanValue="true"/>
                                    <L7p:FriendlyName stringValue=""/>
                                    <L7p:Name stringValue="User.Username"/>
                                    <L7p:Namespace stringValue=""/>
                                    </L7p:item>
                                    <L7p:item samlAttributeElementInfo="included">
                                    <L7p:AnyValue booleanValue="true"/>
                                    <L7p:FriendlyName stringValue=""/>
                                    <L7p:Name stringValue="User.Email"/>
                                    <L7p:Namespace stringValue=""/>
                                    </L7p:item>
                                    <L7p:item samlAttributeElementInfo="included">
                                    <L7p:AnyValue booleanValue="true"/>
                                    <L7p:FriendlyName stringValue=""/>
                                    <L7p:Name stringValue="User.Firstname"/>
                                    <L7p:Namespace stringValue=""/>
                                    </L7p:item>
                                    <L7p:item samlAttributeElementInfo="included">
                                    <L7p:AnyValue booleanValue="true"/>
                                    <L7p:FriendlyName stringValue=""/>
                                    <L7p:Name stringValue="User.Lastname"/>
                                    <L7p:Namespace stringValue=""/>
                                    </L7p:item>
                                    <L7p:item samlAttributeElementInfo="included">
                                    <L7p:AnyValue booleanValue="true"/>
                                    <L7p:FriendlyName stringValue=""/>
                                    <L7p:Name stringValue="User.Organization"/>
                                    <L7p:Namespace stringValue=""/>
                                    </L7p:item>
                                    <L7p:item samlAttributeElementInfo="included">
                                    <L7p:AnyValue booleanValue="true"/>
                                    <L7p:FriendlyName stringValue=""/>
                                    <L7p:Name stringValue="User.Group"/>
                                    <L7p:Namespace stringValue=""/>
                                    </L7p:item>
                                    </L7p:Attributes>
                                </L7p:AttributeStatement>
                                <L7p:OtherTargetMessageVariable stringValue="samlart"/>
                                <L7p:Version boxedIntegerValue="2"/>
                            </L7p:SamlpResponseEvaluation>
                            <L7p:CommentAssertion>
                                <L7p:Comment stringValue="Mapped the SAML attributes"/>
                            </L7p:CommentAssertion>
                            <L7p:SetVariable>
                                <L7p:Base64Expression stringValue="JHtzYW1scFJlc3BvbnNlLmF0dHJpYnV0ZS5Vc2VyLlVzZXJuYW1lfQ=="/>
                                <L7p:VariableToSet stringValue="username"/>
                            </L7p:SetVariable>
                            <wsp:OneOrMore wsp:Usage="Required">
                                <L7p:ComparisonAssertion>
                                    <L7p:Expression1 stringValue="${username}"/>
                                    <L7p:Expression2 stringValue="AttributeValue"/>
                                    <L7p:Negate booleanValue="true"/>
                                    <L7p:Operator operator="CONTAINS"/>
                                    <L7p:Predicates predicates="included">
                                    <L7p:item binary="included">
                                    <L7p:Negated booleanValue="true"/>
                                    <L7p:Operator operator="CONTAINS"/>
                                    <L7p:RightValue stringValue="AttributeValue"/>
                                    </L7p:item>
                                    </L7p:Predicates>
                                </L7p:ComparisonAssertion>
                                <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue=""/>
                                    <L7p:VariableToSet stringValue="username"/>
                                </L7p:SetVariable>
                                <L7p:assertionComment>
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="workaround for gateway defect (DE246306).  If the vale contains AttributeValue, replace it with an empty string."/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                </L7p:assertionComment>
                            </wsp:OneOrMore>
                            <L7p:SetVariable>
                                <L7p:Base64Expression stringValue="JHtzYW1scFJlc3BvbnNlLmF0dHJpYnV0ZS5Vc2VyLkZpcnN0bmFtZX0="/>
                                <L7p:VariableToSet stringValue="firstname"/>
                            </L7p:SetVariable>
                            <wsp:OneOrMore wsp:Usage="Required">
                                <L7p:ComparisonAssertion>
                                    <L7p:Expression1 stringValue="${firstname}"/>
                                    <L7p:Expression2 stringValue="AttributeValue"/>
                                    <L7p:Negate booleanValue="true"/>
                                    <L7p:Operator operator="CONTAINS"/>
                                    <L7p:Predicates predicates="included">
                                    <L7p:item binary="included">
                                    <L7p:Negated booleanValue="true"/>
                                    <L7p:Operator operator="CONTAINS"/>
                                    <L7p:RightValue stringValue="AttributeValue"/>
                                    </L7p:item>
                                    </L7p:Predicates>
                                </L7p:ComparisonAssertion>
                                <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue=""/>
                                    <L7p:VariableToSet stringValue="firstname"/>
                                </L7p:SetVariable>
                                <L7p:assertionComment>
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="workaround for gateway defect (DE246306).  If the vale contains AttributeValue, replace it with an empty string."/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                </L7p:assertionComment>
                            </wsp:OneOrMore>
                            <L7p:SetVariable>
                                <L7p:Base64Expression stringValue="JHtzYW1scFJlc3BvbnNlLmF0dHJpYnV0ZS5Vc2VyLkxhc3RuYW1lfQ=="/>
                                <L7p:VariableToSet stringValue="lastname"/>
                            </L7p:SetVariable>
                            <wsp:OneOrMore wsp:Usage="Required">
                                <L7p:ComparisonAssertion>
                                    <L7p:Expression1 stringValue="${lastname}"/>
                                    <L7p:Expression2 stringValue="AttributeValue"/>
                                    <L7p:Negate booleanValue="true"/>
                                    <L7p:Operator operator="CONTAINS"/>
                                    <L7p:Predicates predicates="included">
                                    <L7p:item binary="included">
                                    <L7p:Negated booleanValue="true"/>
                                    <L7p:Operator operator="CONTAINS"/>
                                    <L7p:RightValue stringValue="AttributeValue"/>
                                    </L7p:item>
                                    </L7p:Predicates>
                                </L7p:ComparisonAssertion>
                                <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue=""/>
                                    <L7p:VariableToSet stringValue="lastname"/>
                                </L7p:SetVariable>
                                <L7p:assertionComment>
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="workaround for gateway defect (DE246306).  If the vale contains AttributeValue, replace it with an empty string."/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                </L7p:assertionComment>
                            </wsp:OneOrMore>
                            <L7p:SetVariable>
                                <L7p:Base64Expression stringValue="JHtzYW1scFJlc3BvbnNlLmF0dHJpYnV0ZS5Vc2VyLkVtYWlsfQ=="/>
                                <L7p:VariableToSet stringValue="email"/>
                            </L7p:SetVariable>
                            <wsp:OneOrMore wsp:Usage="Required">
                                <L7p:ComparisonAssertion>
                                    <L7p:Expression1 stringValue="${email}"/>
                                    <L7p:Expression2 stringValue="AttributeValue"/>
                                    <L7p:Negate booleanValue="true"/>
                                    <L7p:Operator operator="CONTAINS"/>
                                    <L7p:Predicates predicates="included">
                                    <L7p:item binary="included">
                                    <L7p:Negated booleanValue="true"/>
                                    <L7p:Operator operator="CONTAINS"/>
                                    <L7p:RightValue stringValue="AttributeValue"/>
                                    </L7p:item>
                                    </L7p:Predicates>
                                </L7p:ComparisonAssertion>
                                <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue=""/>
                                    <L7p:VariableToSet stringValue="email"/>
                                </L7p:SetVariable>
                                <L7p:assertionComment>
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="workaround for gateway defect (DE246306).  If the vale contains AttributeValue, replace it with an empty string."/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                </L7p:assertionComment>
                            </wsp:OneOrMore>
                            <L7p:SetVariable>
                                <L7p:Base64Expression stringValue="JHtzYW1scFJlc3BvbnNlLmF0dHJpYnV0ZS5Vc2VyLk9yZ2FuaXphdGlvbn0="/>
                                <L7p:VariableToSet stringValue="organization"/>
                            </L7p:SetVariable>
                            <wsp:OneOrMore wsp:Usage="Required">
                                <wsp:All wsp:Usage="Required">
                                    <L7p:ComparisonAssertion>
                                    <L7p:Expression1 stringValue="${organization}"/>
                                    <L7p:Expression2 stringValue=""/>
                                    <L7p:Operator operator="EMPTY"/>
                                    <L7p:Predicates predicates="included">
                                    <L7p:item binary="included">
                                    <L7p:Operator operator="EMPTY"/>
                                    <L7p:RightValue stringValue=""/>
                                    </L7p:item>
                                    </L7p:Predicates>
                                    </L7p:ComparisonAssertion>
                                    <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="Q0Ffb3Jn"/>
                                    <L7p:VariableToSet stringValue="organization"/>
                                    </L7p:SetVariable>
                                    <L7p:assertionComment>
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="//This handles the case where if GW fixes the above defect in the future this policy still works"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:assertionComment>
                                </wsp:All>
                                <L7p:ComparisonAssertion>
                                    <L7p:Expression1 stringValue="${organization}"/>
                                    <L7p:Expression2 stringValue="AttributeValue"/>
                                    <L7p:Negate booleanValue="true"/>
                                    <L7p:Operator operator="CONTAINS"/>
                                    <L7p:Predicates predicates="included">
                                    <L7p:item binary="included">
                                    <L7p:Negated booleanValue="true"/>
                                    <L7p:Operator operator="CONTAINS"/>
                                    <L7p:RightValue stringValue="AttributeValue"/>
                                    </L7p:item>
                                    </L7p:Predicates>
                                </L7p:ComparisonAssertion>
                                <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="Q0Ffb3Jn"/>
                                    <L7p:VariableToSet stringValue="organization"/>
                                </L7p:SetVariable>
                                <L7p:assertionComment>
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="workaround for gateway defect (DE246306).  If the vale contains AttributeValue, replace it with &quot;CA_org&quot;."/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                </L7p:assertionComment>
                            </wsp:OneOrMore>
                            <L7p:SetVariable>
                                <L7p:Base64Expression stringValue="JHtzYW1scFJlc3BvbnNlLmF0dHJpYnV0ZS5Vc2VyLkdyb3VwfQ=="/>
                                <L7p:VariableToSet stringValue="saml_groups"/>
                            </L7p:SetVariable>
                            <wsp:OneOrMore wsp:Usage="Required">
                                <L7p:ComparisonAssertion>
                                    <L7p:Expression1 stringValue="${saml_groups}"/>
                                    <L7p:Expression2 stringValue="AttributeValue"/>
                                    <L7p:Negate booleanValue="true"/>
                                    <L7p:Operator operator="CONTAINS"/>
                                    <L7p:Predicates predicates="included">
                                    <L7p:item binary="included">
                                    <L7p:Negated booleanValue="true"/>
                                    <L7p:Operator operator="CONTAINS"/>
                                    <L7p:RightValue stringValue="AttributeValue"/>
                                    </L7p:item>
                                    </L7p:Predicates>
                                </L7p:ComparisonAssertion>
                                <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue=""/>
                                    <L7p:VariableToSet stringValue="saml_groups"/>
                                </L7p:SetVariable>
                                <L7p:assertionComment>
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="workaround for gateway defect (DE246306).  If the vale contains AttributeValue, replace it with an empty string."/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                </L7p:assertionComment>
                            </wsp:OneOrMore>
                            <L7p:CommentAssertion>
                                <L7p:Comment stringValue="End of Mapped SAML Attributes"/>
                            </L7p:CommentAssertion>
                            <L7p:Include>
                                <L7p:PolicyGuid stringValue="aeaded19-ba8d-4bb5-9cb7-83299c0c2db8"/>
                            </L7p:Include>
                            <L7p:Include>
                                <L7p:PolicyGuid stringValue="a66dca50-a14e-488e-a3f3-419da1383e07"/>
                            </L7p:Include>
                            <L7p:CommentAssertion>
                                <L7p:Comment stringValue="Construct Gims format XML"/>
                            </L7p:CommentAssertion>
                            <L7p:SetVariable>
                                <L7p:Base64Expression stringValue="PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4NCjxMN2dpbXM6c2VydmljZSAgeG1sbnM6TDdnaW1zPSJodHRwOi8vd3d3LmxheWVyN3RlY2guY29tLzIwMTIvMTIvZ2ltcyI+DQoJPEw3Z2ltczp1c2VyPg0KCQk8TDdnaW1zOnZlcnNpb24+JHtWRVJTSU9OfTwvTDdnaW1zOnZlcnNpb24+DQoJCTxMN2dpbXM6ZG4+PCFbQ0RBVEFbY249JHt1c2VybmFtZX1dXT48L0w3Z2ltczpkbj4NCgkJPEw3Z2ltczphdHRyPg0KCQkJPEw3Z2ltczphdHRyLW5hbWU+bG9naW48L0w3Z2ltczphdHRyLW5hbWU+DQoJCQk8TDdnaW1zOmF0dHItdmFsdWU+PCFbQ0RBVEFbJHt1c2VybmFtZX1dXT48L0w3Z2ltczphdHRyLXZhbHVlPg0KCQk8L0w3Z2ltczphdHRyPg0KCQk8TDdnaW1zOmF0dHI+DQoJCQk8TDdnaW1zOmF0dHItbmFtZT5naXZlbk5hbWU8L0w3Z2ltczphdHRyLW5hbWU+DQoJCQk8TDdnaW1zOmF0dHItdmFsdWU+PCFbQ0RBVEFbJHtmaXJzdG5hbWV9XV0+PC9MN2dpbXM6YXR0ci12YWx1ZT4NCgkJPC9MN2dpbXM6YXR0cj4NCgkJPEw3Z2ltczphdHRyPg0KCQkJPEw3Z2ltczphdHRyLW5hbWU+c248L0w3Z2ltczphdHRyLW5hbWU+DQoJCQk8TDdnaW1zOmF0dHItdmFsdWU+PCFbQ0RBVEFbJHtsYXN0bmFtZX1dXT48L0w3Z2ltczphdHRyLXZhbHVlPg0KCQk8L0w3Z2ltczphdHRyPg0KCQk8TDdnaW1zOmF0dHI+DQoJCQk8TDdnaW1zOmF0dHItbmFtZT5tYWlsPC9MN2dpbXM6YXR0ci1uYW1lPg0KCQkJPEw3Z2ltczphdHRyLXZhbHVlPjwhW0NEQVRBWyR7ZW1haWx9XV0+PC9MN2dpbXM6YXR0ci12YWx1ZT4NCgkJPC9MN2dpbXM6YXR0cj4NCgkJJHt4bWwuZ3JvdXBzfQ0KCQk8TDdnaW1zOmF0dHI+DQoJCQk8TDdnaW1zOmF0dHItbmFtZT5vcmdhbml6YXRpb248L0w3Z2ltczphdHRyLW5hbWU+DQoJCQk8TDdnaW1zOmF0dHItdmFsdWU+PCFbQ0RBVEFbJHtvcmdhbml6YXRpb259XV0+PC9MN2dpbXM6YXR0ci12YWx1ZT4NCgkJPC9MN2dpbXM6YXR0cj4NCgk8L0w3Z2ltczp1c2VyPg0KPC9MN2dpbXM6c2VydmljZT4="/>
                                <L7p:ContentType stringValue="text/xml; charset=utf-8"/>
                                <L7p:DataType variableDataType="message"/>
                                <L7p:VariableToSet stringValue="gimsRequest"/>
                            </L7p:SetVariable>
                            <L7p:Encapsulated>
                                <L7p:EncapsulatedAssertionConfigGuid stringValue="ed1e3112-5df8-4769-8436-09ddb1362f88"/>
                                <L7p:EncapsulatedAssertionConfigName stringValue="portalosencass"/>
                                <L7p:Parameters mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="defaultHost"/>
                                    <L7p:value stringValue="${gateway.portal.config.pssg.host}"/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="defaultPort"/>
                                    <L7p:value stringValue="9448"/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="hostName"/>
                                    <L7p:value stringValue="${gateway.portal.config.pssg.sso.host}"/>
                                    </L7p:entry>
                                    <L7p:entry>
                                    <L7p:key stringValue="port"/>
                                    <L7p:value stringValue="${gateway.portal.config.pssg.sso.port}"/>
                                    </L7p:entry>
                                </L7p:Parameters>
                            </L7p:Encapsulated>
                            <L7p:HttpRoutingAssertion>
                                <L7p:AssertionComment assertionComment="included">
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="LEFT.COMMENT"/>
                                    <L7p:value stringValue="get from portal"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                </L7p:AssertionComment>
                                <L7p:FailOnErrorStatus booleanValue="false"/>
                                <L7p:HttpMethod httpMethod="POST"/>
                                <L7p:KeyAlias stringValue="portalman"/>
                                <L7p:NonDefaultKeystoreId goidValue="00000000000000000000000000000002"/>
                                <L7p:ProtectedServiceUrl stringValue="https://${outputHost}:${outputPort}/sso/authenticate?identifier=${gateway.portal.config.identifier}&amp;nodeId=${gateway.portal.config.node.id}"/>
                                <L7p:ProxyPassword stringValueNull="null"/>
                                <L7p:ProxyUsername stringValueNull="null"/>
                                <L7p:RequestHeaderRules httpPassthroughRuleSet="included">
                                    <L7p:ForwardAll booleanValue="true"/>
                                    <L7p:Rules httpPassthroughRules="included">
                                    <L7p:item httpPassthroughRule="included">
                                    <L7p:Name stringValue="Cookie"/>
                                    </L7p:item>
                                    <L7p:item httpPassthroughRule="included">
                                    <L7p:Name stringValue="SOAPAction"/>
                                    </L7p:item>
                                    </L7p:Rules>
                                </L7p:RequestHeaderRules>
                                <L7p:RequestMsgSrc stringValue="gimsRequest"/>
                                <L7p:RequestParamRules httpPassthroughRuleSet="included">
                                    <L7p:ForwardAll booleanValue="true"/>
                                    <L7p:Rules httpPassthroughRules="included"/>
                                </L7p:RequestParamRules>
                                <L7p:ResponseHeaderRules httpPassthroughRuleSet="included">
                                    <L7p:ForwardAll booleanValue="true"/>
                                    <L7p:Rules httpPassthroughRules="included">
                                    <L7p:item httpPassthroughRule="included">
                                    <L7p:Name stringValue="Set-Cookie"/>
                                    </L7p:item>
                                    </L7p:Rules>
                                </L7p:ResponseHeaderRules>
                                <L7p:ResponseMsgDest stringValue="httpResponse1"/>
                                <L7p:SamlAssertionVersion intValue="2"/>
                                <L7p:UsesDefaultKeyStore booleanValue="false"/>
                            </L7p:HttpRoutingAssertion>
                            <L7p:SetVariable>
                                <L7p:Base64Expression stringValue="JHtodHRwUm91dGluZy5yZWFzb25Db2RlfQ=="/>
                                <L7p:VariableToSet stringValue="responseCode"/>
                            </L7p:SetVariable>
                            <wsp:OneOrMore wsp:Usage="Required">
                                <wsp:All wsp:Usage="Required">
                                    <L7p:ComparisonAssertion>
                                    <L7p:Expression1 stringValue="${responseCode}"/>
                                    <L7p:Expression2 stringValue="200"/>
                                    <L7p:MultivaluedComparison multivaluedComparison="FAIL"/>
                                    <L7p:Predicates predicates="included">
                                    <L7p:item binary="included">
                                    <L7p:RightValue stringValue="200"/>
                                    </L7p:item>
                                    </L7p:Predicates>
                                    </L7p:ComparisonAssertion>
                                    <L7p:ResponseXpathAssertion>
                                    <L7p:VariablePrefix stringValue="token"/>
                                    <L7p:XmlMsgSrc stringValue="httpResponse1"/>
                                    <L7p:XpathExpression xpathExpressionValue="included">
                                    <L7p:Expression stringValue="//L7gims:service/L7gims:user/L7gims:attr/L7gims:attr-name[text()=&quot;token&quot;]/../L7gims:attr-value/text()"/>
                                    <L7p:Namespaces mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="L7gims"/>
                                    <L7p:value stringValue="http://www.layer7tech.com/2012/12/gims"/>
                                    </L7p:entry>
                                    </L7p:Namespaces>
                                    <L7p:XpathVersion xpathVersion="XPATH_1_0"/>
                                    </L7p:XpathExpression>
                                    </L7p:ResponseXpathAssertion>
                                    <L7p:ResponseXpathAssertion>
                                    <L7p:VariablePrefix stringValue="portalHost"/>
                                    <L7p:XmlMsgSrc stringValue="httpResponse1"/>
                                    <L7p:XpathExpression xpathExpressionValue="included">
                                    <L7p:Expression stringValue="//L7gims:service/L7gims:user/L7gims:attr/L7gims:attr-name[text()=&quot;portalHost&quot;]/../L7gims:attr-value/text()"/>
                                    <L7p:Namespaces mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="L7gims"/>
                                    <L7p:value stringValue="http://www.layer7tech.com/2012/12/gims"/>
                                    </L7p:entry>
                                    </L7p:Namespaces>
                                    <L7p:XpathVersion xpathVersion="XPATH_1_0"/>
                                    </L7p:XpathExpression>
                                    </L7p:ResponseXpathAssertion>
                                    <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="cG9zdA=="/>
                                    <L7p:VariableToSet stringValue="samlReqMethod"/>
                                    </L7p:SetVariable>
                                    <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="aHR0cHM6Ly8ke3BvcnRhbEhvc3QucmVzdWx0fS9hZG1pbi9zYW1sQ2FsbGJhY2s="/>
                                    <L7p:VariableToSet stringValue="portalSsoUrl"/>
                                    </L7p:SetVariable>
                                </wsp:All>
                                <wsp:All wsp:Usage="Required">
                                    <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="JHtyZXNwb25zZUNvZGV9"/>
                                    <L7p:VariableToSet stringValue="errorCode"/>
                                    </L7p:SetVariable>
                                    <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="JHtodHRwUmVzcG9uc2UxLm1haW5wYXJ0fQ=="/>
                                    <L7p:VariableToSet stringValue="errorMsg"/>
                                    </L7p:SetVariable>
                                </wsp:All>
                            </wsp:OneOrMore>
                            <L7p:assertionComment>
                                <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="LEFT.COMMENT"/>
                                    <L7p:value stringValue="Validate SAML Response.  All SAML attributes required for Gims format needs to be present"/>
                                    </L7p:entry>
                                </L7p:Properties>
                            </L7p:assertionComment>
                        </wsp:All>
                        <wsp:All wsp:Usage="Required">
                            <L7p:SetVariable>
                                <L7p:Base64Expression stringValue="NDAw"/>
                                <L7p:VariableToSet stringValue="errorCode"/>
                            </L7p:SetVariable>
                            <L7p:SetVariable>
                                <L7p:Base64Expression stringValue="RmFpbCB0byB2YWxpZGF0ZSBTQU1MIHN0YXRlbWVudA=="/>
                                <L7p:VariableToSet stringValue="errorMsg"/>
                            </L7p:SetVariable>
                            <L7p:assertionComment>
                                <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="LEFT.COMMENT"/>
                                    <L7p:value stringValue="Fail to validate SAML Response, set error message "/>
                                    </L7p:entry>
                                </L7p:Properties>
                            </L7p:assertionComment>
                        </wsp:All>
                        <L7p:assertionComment>
                            <L7p:Properties mapValue="included">
                                <L7p:entry>
                                    <L7p:key stringValue="LEFT.COMMENT"/>
                                    <L7p:value stringValue="Validate SAML Response"/>
                                </L7p:entry>
                            </L7p:Properties>
                        </L7p:assertionComment>
                    </wsp:OneOrMore>
                </wsp:All>
                <wsp:All wsp:Usage="Required">
                    <L7p:SetVariable>
                        <L7p:Base64Expression stringValue="NDAw"/>
                        <L7p:VariableToSet stringValue="errorCode"/>
                    </L7p:SetVariable>
                    <L7p:SetVariable>
                        <L7p:Base64Expression stringValue="RmFpbCB0byB2YWxpZGF0ZSBTQU1MIFJlc3BvbnNl"/>
                        <L7p:VariableToSet stringValue="errorMsg"/>
                    </L7p:SetVariable>
                    <L7p:assertionComment>
                        <L7p:Properties mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="LEFT.COMMENT"/>
                                <L7p:value stringValue="fail to base64 decode"/>
                            </L7p:entry>
                        </L7p:Properties>
                    </L7p:assertionComment>
                </wsp:All>
            </wsp:OneOrMore>
            <wsp:OneOrMore wsp:Usage="Required">
                <wsp:All wsp:Usage="Required">
                    <wsp:OneOrMore wsp:Usage="Required">
                        <L7p:ComparisonAssertion>
                            <L7p:CaseSensitive booleanValue="false"/>
                            <L7p:Expression1 stringValue="${responseCode}"/>
                            <L7p:Operator operatorNull="null"/>
                            <L7p:Predicates predicates="included">
                                <L7p:item dataType="included">
                                    <L7p:Type variableDataType="string"/>
                                </L7p:item>
                                <L7p:item binary="included">
                                    <L7p:RightValue stringValue="200"/>
                                </L7p:item>
                            </L7p:Predicates>
                        </L7p:ComparisonAssertion>
                        <L7p:ComparisonAssertion>
                            <L7p:CaseSensitive booleanValue="false"/>
                            <L7p:Expression1 stringValue="${errorCode}"/>
                            <L7p:Operator operatorNull="null"/>
                            <L7p:Predicates predicates="included">
                                <L7p:item dataType="included">
                                    <L7p:Type variableDataType="string"/>
                                </L7p:item>
                                <L7p:item binary="included">
                                    <L7p:RightValue stringValue="0"/>
                                </L7p:item>
                            </L7p:Predicates>
                        </L7p:ComparisonAssertion>
                    </wsp:OneOrMore>
                    <wsp:OneOrMore wsp:Usage="Required">
                        <wsp:All wsp:Usage="Required">
                            <L7p:ComparisonAssertion>
                                <L7p:CaseSensitive booleanValue="false"/>
                                <L7p:Expression1 stringValue="${samlReqMethod}"/>
                                <L7p:Expression2 stringValue="post"/>
                                <L7p:MultivaluedComparison multivaluedComparison="FAIL"/>
                                <L7p:Predicates predicates="included">
                                    <L7p:item binary="included">
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:RightValue stringValue="post"/>
                                    </L7p:item>
                                </L7p:Predicates>
                            </L7p:ComparisonAssertion>
                            <L7p:HardcodedResponse>
                                <L7p:Base64ResponseBody stringValue="PCFET0NUWVBFIGh0bWwgUFVCTElDICItLy9XM0MvL0RURCBIVE1MIDQuMDEvL0VOIj4KPGh0bWw+Cjxib2R5Pgo8U0NSSVBUIExBTkdVQUdFPSJKYXZhU2NyaXB0Ij4KZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigiRE9NQ29udGVudExvYWRlZCIsIGZ1bmN0aW9uKGV2ZW50KSB7IAkKCWRvY3VtZW50LnNhbWxwb3N0LnN1Ym1pdCgpCn0pOwo8L1NDUklQVD4KICAgICAgICA8Zm9ybSBuYW1lPSJzYW1scG9zdCIgYWN0aW9uPSIke3BvcnRhbFNzb1VybH0iICBtZXRob2Q9IlBPU1QiPgogICAgICAgICAgICA8cD4KICAgICAgICAgICAgICAgIFByZXNzIHRoZSBDb250aW51ZSBidXR0b24gdG8gTE9HSU4uCiAgICAgICAgICAgIDwvcD4KICAgICAgICAgICAgPGRpdj4KICAgICAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJoaWRkZW4iIG5hbWU9InRva2VuIiB2YWx1ZT0iJHt0b2tlbi5yZXN1bHR9Ii8+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2PgogICAgICAgICAgICAgICAgPGlucHV0IHR5cGU9InN1Ym1pdCIgdmFsdWU9IkNvbnRpbnVlIi8+CiAgICAgICAgICAgIDwvZGl2PiAgICAgICAgICAgIAogICAgICAgIDwvZm9ybT4KPC9ib2R5Pgo8L2h0bWw+"/>
                                <L7p:EarlyResponse booleanValue="true"/>
                                <L7p:ResponseContentType stringValue="text/html; charset=UTF-8"/>
                            </L7p:HardcodedResponse>
                            <L7p:assertionComment>
                                <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="LEFT.COMMENT"/>
                                    <L7p:value stringValue="Auto Post form"/>
                                    </L7p:entry>
                                </L7p:Properties>
                            </L7p:assertionComment>
                        </wsp:All>
                        <wsp:All wsp:Usage="Required">
                            <L7p:ComparisonAssertion>
                                <L7p:CaseSensitive booleanValue="false"/>
                                <L7p:Expression1 stringValue="${samlReqMethod}"/>
                                <L7p:Expression2 stringValue="redirect"/>
                                <L7p:MultivaluedComparison multivaluedComparison="FAIL"/>
                                <L7p:Predicates predicates="included">
                                    <L7p:item binary="included">
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:RightValue stringValue="redirect"/>
                                    </L7p:item>
                                </L7p:Predicates>
                            </L7p:ComparisonAssertion>
                            <L7p:SetVariable>
                                <L7p:Base64Expression stringValue="JHtwb3J0YWxTc29Vcmx9P3Rva2VuPSR7dG9rZW4ucmVzdWx0fQ=="/>
                                <L7p:VariableToSet stringValue="location"/>
                            </L7p:SetVariable>
                            <L7p:AuditDetailAssertion>
                                <L7p:Detail stringValue="Redirect to: ${location}"/>
                            </L7p:AuditDetailAssertion>
                            <L7p:HardcodedResponse>
                                <L7p:EarlyResponse booleanValue="true"/>
                                <L7p:ResponseContentType stringValue="text/html; charset=UTF-8"/>
                                <L7p:ResponseStatus stringValue="303"/>
                            </L7p:HardcodedResponse>
                            <L7p:AddHeader>
                                <L7p:HeaderName stringValue="Location"/>
                                <L7p:HeaderValue stringValue="${location}"/>
                                <L7p:Target target="RESPONSE"/>
                            </L7p:AddHeader>
                            <L7p:assertionComment>
                                <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="LEFT.COMMENT"/>
                                    <L7p:value stringValue="Http Redirect"/>
                                    </L7p:entry>
                                </L7p:Properties>
                            </L7p:assertionComment>
                        </wsp:All>
                        <L7p:assertionComment>
                            <L7p:Properties mapValue="included">
                                <L7p:entry>
                                    <L7p:key stringValue="LEFT.COMMENT"/>
                                    <L7p:value stringValue="Sends SAML Auth Request via samlReqMethod"/>
                                </L7p:entry>
                            </L7p:Properties>
                        </L7p:assertionComment>
                    </wsp:OneOrMore>
                    <L7p:assertionComment>
                        <L7p:Properties mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="LEFT.COMMENT"/>
                                <L7p:value stringValue="if (success path)"/>
                            </L7p:entry>
                            <L7p:entry>
                                <L7p:key stringValue="RIGHT.COMMENT"/>
                                <L7p:value stringValue="// Return response"/>
                            </L7p:entry>
                        </L7p:Properties>
                    </L7p:assertionComment>
                </wsp:All>
                <wsp:All wsp:Usage="Required">
                    <L7p:CustomizeErrorResponse>
                        <L7p:Content stringValueReference="inline"><![CDATA[<L7gims:service xmlns:L7gims="http://www.layer7tech.com/2012/12/L7gims">
<L7gims:Method>${request.http.method}</L7gims:Method>
<L7gims:Resource>${request.http.uri}</L7gims:Resource>
<L7gims:ResourceId>${entity_id}</L7gims:ResourceId>
<L7gims:Timestamp>${gateway.time}</L7gims:Timestamp>
<L7gims:Status>${errorCode}</L7gims:Status>
<L7gims:Detail>${errorMsg}</L7gims:Detail>
</L7gims:service>]]></L7p:Content>
                        <L7p:ContentType stringValue="text/xml; charset=UTF-8"/>
                        <L7p:ExtraHeaders nameValuePairArray="included"/>
                        <L7p:HttpStatus stringValue="${errorCode}"/>
                    </L7p:CustomizeErrorResponse>
                    <L7p:FalseAssertion/>
                    <L7p:assertionComment>
                        <L7p:Properties mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="LEFT.COMMENT"/>
                                <L7p:value stringValue="Else (error)"/>
                            </L7p:entry>
                            <L7p:entry>
                                <L7p:key stringValue="RIGHT.COMMENT"/>
                                <L7p:value stringValue="// Return error, falsify policy"/>
                            </L7p:entry>
                        </L7p:Properties>
                    </L7p:assertionComment>
                </wsp:All>
            </wsp:OneOrMore>
        </wsp:All>
    </wsp:All>
</wsp:Policy>