<?xml version="1.0" encoding="UTF-8"?>
<wsp:Policy xmlns:L7p="http://www.layer7tech.com/ws/policy" xmlns:wsp="http://schemas.xmlsoap.org/ws/2002/12/policy">
    <wsp:All wsp:Usage="Required">
        <wsp:All wsp:Usage="Required">
            <wsp:All wsp:Usage="Required">
                <L7p:CommentAssertion>
                    <L7p:Comment stringValue="API Portal Authentication SAML Auth Request Service"/>
                </L7p:CommentAssertion>
                <L7p:CommentAssertion>
                    <L7p:Comment stringValue="It generates an auto sumbit form to perform HTTP Post to IDP with SAML AuthnRequest"/>
                </L7p:CommentAssertion>
                <L7p:ComparisonAssertion>
                    <L7p:CaseSensitive booleanValue="false"/>
                    <L7p:Expression1 stringValue="${request.url.path}"/>
                    <L7p:MultivaluedComparison multivaluedComparison="FAIL"/>
                    <L7p:Operator operatorNull="null"/>
                    <L7p:Predicates predicates="included">
                        <L7p:item regex="included">
                            <L7p:Pattern stringValue=".*/sso/samlRequest"/>
                        </L7p:item>
                    </L7p:Predicates>
                </L7p:ComparisonAssertion>
                <L7p:ComparisonAssertion>
                    <L7p:Expression1 stringValue="${request.http.method}"/>
                    <L7p:Expression2 stringValue="GET"/>
                    <L7p:MultivaluedComparison multivaluedComparison="FAIL"/>
                    <L7p:Predicates predicates="included">
                        <L7p:item binary="included">
                            <L7p:RightValue stringValue="GET"/>
                        </L7p:item>
                    </L7p:Predicates>
                </L7p:ComparisonAssertion>
                <L7p:CommentAssertion>
                    <L7p:Comment stringValue="Generates the SAML AuthnRequest in SOAP message"/>
                </L7p:CommentAssertion>
                <wsp:OneOrMore wsp:Usage="Required">
                    <wsp:All wsp:Usage="Required">
                        <L7p:ComparisonAssertion>
                            <L7p:Expression1 stringValue="${serviceProviderId}"/>
                            <L7p:Expression2 stringValue="GET"/>
                            <L7p:MultivaluedComparison multivaluedComparison="FAIL"/>
                            <L7p:Negate booleanValue="true"/>
                            <L7p:Operator operator="EMPTY"/>
                            <L7p:Predicates predicates="included">
                                <L7p:item binary="included">
                                    <L7p:Negated booleanValue="true"/>
                                    <L7p:Operator operator="EMPTY"/>
                                    <L7p:RightValue stringValue="GET"/>
                                </L7p:item>
                            </L7p:Predicates>
                        </L7p:ComparisonAssertion>
                        <L7p:SamlpRequestBuilder>
                            <L7p:AuthenticationStatement samlAuthenticationInfo="included">
                                <L7p:AuthenticationMethods stringArrayValue="included"/>
                            </L7p:AuthenticationStatement>
                            <L7p:CustomIssuerValue stringValue="${serviceProviderId}"/>
                            <L7p:DestinationAttribute stringValue="${idpURL}"/>
                            <L7p:NameIdentifierType nameIdentifierType="NONE"/>
                            <L7p:OtherTargetMessageVariable stringValue="soapSamlAuthReq"/>
                            <L7p:RequestId boxedIntegerValue="0"/>
                            <L7p:SignAssertion booleanValue="false"/>
                            <L7p:SoapVersion boxedIntegerValue="0"/>
                            <L7p:Version boxedIntegerValue="2"/>
                            <L7p:XmlEncryptConfig xmlElementEncryptionConfig="included">
                                <L7p:UseOaep booleanValue="true"/>
                            </L7p:XmlEncryptConfig>
                        </L7p:SamlpRequestBuilder>
                    </wsp:All>
                    <wsp:All wsp:Usage="Required">
                        <L7p:SamlpRequestBuilder>
                            <L7p:AuthenticationStatement samlAuthenticationInfo="included">
                                <L7p:AuthenticationMethods stringArrayValue="included"/>
                            </L7p:AuthenticationStatement>
                            <L7p:DestinationAttribute stringValue="${idpURL}"/>
                            <L7p:NameIdentifierType nameIdentifierType="NONE"/>
                            <L7p:OtherTargetMessageVariable stringValue="soapSamlAuthReq"/>
                            <L7p:RequestId boxedIntegerValue="0"/>
                            <L7p:SignAssertion booleanValue="false"/>
                            <L7p:SoapVersion boxedIntegerValue="0"/>
                            <L7p:Version boxedIntegerValue="2"/>
                            <L7p:XmlEncryptConfig xmlElementEncryptionConfig="included">
                                <L7p:UseOaep booleanValue="true"/>
                            </L7p:XmlEncryptConfig>
                        </L7p:SamlpRequestBuilder>
                    </wsp:All>
                    <L7p:assertionComment>
                        <L7p:Properties mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="RIGHT.COMMENT"/>
                                <L7p:value stringValue="Use service provider id if provided"/>
                            </L7p:entry>
                        </L7p:Properties>
                    </L7p:assertionComment>
                </wsp:OneOrMore>
                <L7p:CommentAssertion>
                    <L7p:Comment stringValue="Set the AssertionConsumerServiceURL in SAML AuthnRequest"/>
                </L7p:CommentAssertion>
                <wsp:OneOrMore wsp:Usage="Required">
                    <L7p:ComparisonAssertion>
                        <L7p:Expression1 stringValue="${serviceProviderId}"/>
                        <L7p:Expression2 stringValue="GET"/>
                        <L7p:MultivaluedComparison multivaluedComparison="FAIL"/>
                        <L7p:Operator operator="EMPTY"/>
                        <L7p:Predicates predicates="included">
                            <L7p:item binary="included">
                                <L7p:Operator operator="EMPTY"/>
                                <L7p:RightValue stringValue="GET"/>
                            </L7p:item>
                        </L7p:Predicates>
                    </L7p:ComparisonAssertion>
                    <L7p:Regex>
                        <L7p:AutoTarget booleanValue="false"/>
                        <L7p:OtherTargetMessageVariable stringValue="soapSamlAuthReq"/>
                        <L7p:Regex stringValue="&lt;saml2:Subject>&lt;saml2:NameID xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:nil=&quot;true&quot;/>.*&lt;/saml2:Subject>"/>
                        <L7p:Replace booleanValue="true"/>
                        <L7p:Replacement stringValue=""/>
                        <L7p:Target target="OTHER"/>
                    </L7p:Regex>
                    <L7p:assertionComment>
                        <L7p:Properties mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="RIGHT.COMMENT"/>
                                <L7p:value stringValue="Remove extra line in request if  service provider id is provided"/>
                            </L7p:entry>
                        </L7p:Properties>
                    </L7p:assertionComment>
                </wsp:OneOrMore>
                <L7p:Regex>
                    <L7p:AutoTarget booleanValue="false"/>
                    <L7p:OtherTargetMessageVariable stringValue="soapSamlAuthReq"/>
                    <L7p:Regex stringValue="(&lt;samlp2:AuthnRequest)"/>
                    <L7p:Replace booleanValue="true"/>
                    <L7p:Replacement stringValue="&lt;samlp2:AuthnRequest AssertionConsumerServiceURL=&quot;${portalACSURL}&quot;"/>
                    <L7p:Target target="OTHER"/>
                </L7p:Regex>
                <L7p:Regex>
                    <L7p:AutoTarget booleanValue="false"/>
                    <L7p:CaptureVar stringValue="samlAuthReq"/>
                    <L7p:OtherTargetMessageVariable stringValue="soapSamlAuthReq"/>
                    <L7p:Regex stringValue="&lt;samlp2:AuthnRequest.*&lt;/samlp2:AuthnRequest>"/>
                    <L7p:Replacement stringValue=""/>
                    <L7p:Target target="OTHER"/>
                </L7p:Regex>
                <L7p:EncodeDecode>
                    <L7p:SourceVariableName stringValue="samlAuthReq"/>
                    <L7p:TargetDataType variableDataType="string"/>
                    <L7p:TargetVariableName stringValue="base64SamlAuthReq"/>
                    <L7p:TransformType transformType="BASE64_ENCODE"/>
                </L7p:EncodeDecode>
                <wsp:OneOrMore wsp:Usage="Required">
                    <wsp:All wsp:Usage="Required">
                        <L7p:ComparisonAssertion>
                            <L7p:CaseSensitive booleanValue="false"/>
                            <L7p:Expression1 stringValue="${samlBinding}"/>
                            <L7p:Expression2 stringValue="post"/>
                            <L7p:MultivaluedComparison multivaluedComparison="FAIL"/>
                            <L7p:Predicates predicates="included">
                                <L7p:item binary="included">
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:RightValue stringValue="post"/>
                                </L7p:item>
                            </L7p:Predicates>
                        </L7p:ComparisonAssertion>
                        <L7p:HardcodedResponse>
                            <L7p:Base64ResponseBody stringValue="PCFET0NUWVBFIGh0bWwgUFVCTElDICItLy9XM0MvL0RURCBIVE1MIDQuMDEvL0VOIj4KPGh0bWw+Cjxib2R5Pgo8U0NSSVBUIExBTkdVQUdFPSJKYXZhU2NyaXB0Ij4KZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigiRE9NQ29udGVudExvYWRlZCIsIGZ1bmN0aW9uKGV2ZW50KSB7IAkKCWRvY3VtZW50LnNhbWxwb3N0LnN1Ym1pdCgpCn0pOwo8L1NDUklQVD4KICAgICAgICA8Zm9ybSBuYW1lPSJzYW1scG9zdCIgYWN0aW9uPSIke2lkcFVSTH0iICBtZXRob2Q9IlBPU1QiPgogICAgICAgICAgICA8cD4KICAgICAgICAgICAgICAgIFByZXNzIHRoZSBDb250aW51ZSBidXR0b24gdG8gUE9TVCB5b3VyIFNBTUwgcmVxdWVzdCB3aXRoIEF1dGhuUmVxdWVzdCB0byB0aGUgSURQLgogICAgICAgICAgICA8L3A+CiAgICAgICAgICAgIDxkaXY+CiAgICAgICAgICAgICAgICA8aW5wdXQgdHlwZT0iaGlkZGVuIiBuYW1lPSJTQU1MUmVxdWVzdCIgdmFsdWU9IiR7YmFzZTY0U2FtbEF1dGhSZXF9Ii8+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2PgogICAgICAgICAgICAgICAgPGlucHV0IHR5cGU9InN1Ym1pdCIgdmFsdWU9IkNvbnRpbnVlIi8+CiAgICAgICAgICAgIDwvZGl2PiAgICAgICAgICAgIAogICAgICAgIDwvZm9ybT4KPC9ib2R5Pgo8L2h0bWw+"/>
                            <L7p:EarlyResponse booleanValue="true"/>
                            <L7p:ResponseContentType stringValue="text/html; charset=UTF-8"/>
                        </L7p:HardcodedResponse>
                        <L7p:assertionComment>
                            <L7p:Properties mapValue="included">
                                <L7p:entry>
                                    <L7p:key stringValue="LEFT.COMMENT"/>
                                    <L7p:value stringValue="Auto Post form"/>
                                </L7p:entry>
                            </L7p:Properties>
                        </L7p:assertionComment>
                    </wsp:All>
                    <wsp:All wsp:Usage="Required">
                        <L7p:ComparisonAssertion>
                            <L7p:CaseSensitive booleanValue="false"/>
                            <L7p:Expression1 stringValue="${samlBinding}"/>
                            <L7p:Expression2 stringValue="redirect"/>
                            <L7p:MultivaluedComparison multivaluedComparison="FAIL"/>
                            <L7p:Predicates predicates="included">
                                <L7p:item binary="included">
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:RightValue stringValue="redirect"/>
                                </L7p:item>
                            </L7p:Predicates>
                        </L7p:ComparisonAssertion>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="JHtpZHBVUkx9P1NBTUxSZXF1ZXN0PSR7YmFzZTY0U2FtbEF1dGhSZXF9"/>
                            <L7p:VariableToSet stringValue="location"/>
                        </L7p:SetVariable>
                        <L7p:AuditDetailAssertion>
                            <L7p:Detail stringValue="Redirect to: ${location}"/>
                        </L7p:AuditDetailAssertion>
                        <L7p:HardcodedResponse>
                            <L7p:EarlyResponse booleanValue="true"/>
                            <L7p:ResponseContentType stringValue="text/html; charset=UTF-8"/>
                            <L7p:ResponseStatus stringValue="303"/>
                        </L7p:HardcodedResponse>
                        <L7p:AddHeader>
                            <L7p:HeaderName stringValue="Location"/>
                            <L7p:HeaderValue stringValue="${location}"/>
                            <L7p:RemoveExisting booleanValue="true"/>
                            <L7p:Target target="RESPONSE"/>
                        </L7p:AddHeader>
                        <L7p:assertionComment>
                            <L7p:Properties mapValue="included">
                                <L7p:entry>
                                    <L7p:key stringValue="LEFT.COMMENT"/>
                                    <L7p:value stringValue="Http Redirect"/>
                                </L7p:entry>
                            </L7p:Properties>
                        </L7p:assertionComment>
                    </wsp:All>
                    <L7p:assertionComment>
                        <L7p:Properties mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="LEFT.COMMENT"/>
                                <L7p:value stringValue="Sends SAML Auth Request via samlReqMethod"/>
                            </L7p:entry>
                        </L7p:Properties>
                    </L7p:assertionComment>
                </wsp:OneOrMore>
                <L7p:assertionComment>
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="LEFT.COMMENT"/>
                            <L7p:value stringValue="/samlRequest Generates Saml Request"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:assertionComment>
            </wsp:All>
        </wsp:All>
    </wsp:All>
</wsp:Policy>