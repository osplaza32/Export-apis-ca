<?xml version="1.0" encoding="UTF-8"?>
<wsp:Policy xmlns:L7p="http://www.layer7tech.com/ws/policy" xmlns:wsp="http://schemas.xmlsoap.org/ws/2002/12/policy">
    <wsp:All wsp:Usage="Required">
        <L7p:Include>
            <L7p:PolicyGuid stringValue="d493c224-cd27-414e-b426-aa5f135210a9"/>
        </L7p:Include>
        <wsp:OneOrMore wsp:Usage="Required">
            <wsp:All wsp:Usage="Required">
                <wsp:OneOrMore wsp:Usage="Required">
                    <wsp:All wsp:Usage="Required">
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="JHtyZXF1ZXN0Lmh0dHAuaGVhZGVyLnJlcXVlc3RUaW1lc3RhbXB9"/>
                            <L7p:VariableToSet stringValue="Timestamp"/>
                        </L7p:SetVariable>
                        <L7p:Regex>
                            <L7p:AutoTarget booleanValue="false"/>
                            <L7p:OtherTargetMessageVariable stringValue="Timestamp"/>
                            <L7p:Regex stringValue="\-|T|\:|\."/>
                            <L7p:RegexVar stringValue="Timestamp"/>
                            <L7p:Replace booleanValue="true"/>
                            <L7p:Replacement stringValue=""/>
                            <L7p:Target target="OTHER"/>
                        </L7p:Regex>
                        <L7p:Regex>
                            <L7p:AutoTarget booleanValue="false"/>
                            <L7p:CaptureVar stringValue="Timestamp"/>
                            <L7p:OtherTargetMessageVariable stringValue="Timestamp"/>
                            <L7p:Regex stringValue="^................."/>
                            <L7p:Replacement stringValue=""/>
                            <L7p:Target target="OTHER"/>
                        </L7p:Regex>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="aHR0cDovLzEwLjQ5LjkuMTI2OjgzNTkvY3VzdG9tZXJBY2NvdW50QmFsYW5jZQ=="/>
                            <L7p:VariableToSet stringValue="urlBackend"/>
                        </L7p:SetVariable>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="ew0KICAgIlJlcXVlc3RIZWFkZXIiOiB7DQogICAgICAiQ29uc3VtZXIiOiB7DQogICAgICAgICAic3lzQ29kZSI6ICJBUFAiLA0KICAgICAgICAgImVudGVycHJpc2VDb2RlIjogIkVOVEVMLVBFUiIsDQogICAgICAgICAiY291bnRyeUNvZGUiOiAiUEVSIg0KICAgICAgfSwNCiAgICAgICJUcmFjZSI6IHsNCiAgICAgICAgICJjbGllbnRSZXFUaW1lc3RhbXAiOiAiMjAxOC0wNC0wOVQxMjozNDowMC41NDQtMDM6MDAiLA0KICAgICAgInByb2Nlc3NJRCI6ICIiLA0KICAgICAgImV2ZW50SUQiOiAiIiwNCiAgICAgICJzb3VyY2VJRCI6ICIiLA0KICAgICAgImNvcnJlbGF0aW9uRXZlbnRJRCI6ICJudWxsIiwNCiAgICAgICJjb252ZXJzYXRpb25JRCI6ICJudWxsIiwNCiAgICAgICJjb3JyZWxhdGlvbklEIjogIm51bGwiLA0KICAgICAgICAgICAgIlNlcnZpY2UiOiB7DQogICAgICAgICAgICAgICAgImNvZGUiOiAiQ00wMTgiLA0KICAgICAgICAgICAgICAgICJuYW1lIjogIkN1c3RvbWVyQWNjb3VudEJhbGFuY2UiLA0KICAgICAgICAgICAgICAgICJvcGVyYXRpb24iOiAiR2V0Ig0KICAgICAgICAgICAgfQ0KICAgICAgICB9LA0KICAgICAgICAiQ2hhbm5lbCI6IHsNCiAgICAgICAgICAgICJuYW1lIjogIldFQiINCiAgICAgICAgfSwNCiAgICAgICAgIlJlc3VsdCI6IHsNCiAgICAgICAgICAgICJzdGF0dXMiOiAiT0siLA0KICAgICAgICAgICAgImRlc2NyaXB0aW9uIjogIkVqZWN1Y2nDs24gRXhpdG9zYSINCiAgICAgICAgfQ0KICAgIH0sDQoJIkJvZHkiOiB7DQogICAgIkN1c3RvbWVyQWNjb3VudCI6IHsNCiAgICAgICJBc3NldCI6IHsNCiAgICAgICAgIk1TSVNETiI6IHsNCiAgICAgICAgICAiU04iOiAiJHtyZXF1ZXN0Lmh0dHAucGFyYW1ldGVyLnNufSINCiAgICAgICAgfQ0KICAgICAgfSwNCiAgICAgICJCdXNpbmVzc0ludGVyYWN0aW9uIjogew0KICAgICAgICAiaW50ZXJhY3Rpb25FeHRlcm5hbElEIjogIiR7cmVxdWVzdC5odHRwLnBhcmFtZXRlci5pbnRlcmFjdGlvbkV4dGVybmFsSUR9Ig0KICAgICAgfSwNCiAgICAgICJGaWx0ZXIiOiB7DQogICAgICAgICJuYW1lIjogIiR7cmVxdWVzdC5odHRwLnBhcmFtZXRlci5maWx0ZXJOYW1lfSINCiAgICAgIH0NCiAgICB9DQogIH0NCiAgfQ=="/>
                            <L7p:ContentType stringValue="application/json; charset=utf-8"/>
                            <L7p:DataType variableDataType="message"/>
                            <L7p:VariableToSet stringValue="message"/>
                        </L7p:SetVariable>
                        <L7p:AuditDetailAssertion>
                            <L7p:CustomLoggerSuffix stringValue="entel.api.syslog"/>
                            <L7p:Detail stringValue="IDTRANSACTION: ${requestId}  REQUEST BACKEND: ${message.mainpart} "/>
                            <L7p:LoggingOnly booleanValue="true"/>
                        </L7p:AuditDetailAssertion>
                        <L7p:HttpRoutingAssertion>
                            <L7p:FailOnErrorStatus booleanValue="false"/>
                            <L7p:HttpMethod httpMethod="POST"/>
                            <L7p:PassThroughSoapFaults booleanValue="false"/>
                            <L7p:ProtectedServiceUrl stringValue="${urlBackend}"/>
                            <L7p:ProxyPassword stringValueNull="null"/>
                            <L7p:ProxyUsername stringValueNull="null"/>
                            <L7p:RequestHeaderRules httpPassthroughRuleSet="included">
                                <L7p:Rules httpPassthroughRules="included">
                                    <L7p:item httpPassthroughRule="included">
                                    <L7p:Name stringValue="Cookie"/>
                                    </L7p:item>
                                    <L7p:item httpPassthroughRule="included">
                                    <L7p:Name stringValue="SOAPAction"/>
                                    </L7p:item>
                                </L7p:Rules>
                            </L7p:RequestHeaderRules>
                            <L7p:RequestMsgSrc stringValue="message"/>
                            <L7p:RequestParamRules httpPassthroughRuleSet="included">
                                <L7p:ForwardAll booleanValue="true"/>
                                <L7p:Rules httpPassthroughRules="included"/>
                            </L7p:RequestParamRules>
                            <L7p:ResponseHeaderRules httpPassthroughRuleSet="included">
                                <L7p:Rules httpPassthroughRules="included">
                                    <L7p:item httpPassthroughRule="included">
                                    <L7p:Name stringValue="Set-Cookie"/>
                                    </L7p:item>
                                </L7p:Rules>
                            </L7p:ResponseHeaderRules>
                            <L7p:ResponseMsgDest stringValue="jsonResponse"/>
                            <L7p:SamlAssertionVersion intValue="2"/>
                        </L7p:HttpRoutingAssertion>
                        <L7p:AuditDetailAssertion>
                            <L7p:CustomLoggerSuffix stringValue="entel.api.syslog"/>
                            <L7p:Detail stringValue="IDTRANSACTION: ${requestId} BACKEND: ${httpRouting.url} LATENCY: ${httpRouting.latency} ms REASON CODE: ${httpRouting.reasonCode} RESPONSEBACKEND: ${response.mainpart} "/>
                            <L7p:LoggingOnly booleanValue="true"/>
                        </L7p:AuditDetailAssertion>
                        <L7p:ComparisonAssertion>
                            <L7p:AssertionComment assertionComment="included">
                                <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="Evalua si el estado de la respuesta es OK"/>
                                    </L7p:entry>
                                </L7p:Properties>
                            </L7p:AssertionComment>
                            <L7p:CaseSensitive booleanValue="false"/>
                            <L7p:Expression1 stringValue="${httpRouting.reasonCode}"/>
                            <L7p:Expression2 stringValue="200"/>
                            <L7p:Predicates predicates="included">
                                <L7p:item binary="included">
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:RightValue stringValue="200"/>
                                </L7p:item>
                            </L7p:Predicates>
                        </L7p:ComparisonAssertion>
                        <wsp:OneOrMore wsp:Usage="Required">
                            <wsp:All wsp:Usage="Required">
                                <L7p:EvaluateJsonPathExpression>
                                    <L7p:AssertionComment assertionComment="included">
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="Extrae el Body"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:AssertionComment>
                                    <L7p:Expression stringValue="$.Body"/>
                                    <L7p:OtherTargetMessageVariable stringValue="jsonResponse"/>
                                    <L7p:Target target="OTHER"/>
                                    <L7p:VariablePrefix stringValue="resultBody"/>
                                </L7p:EvaluateJsonPathExpression>
                                <L7p:EvaluateJsonPathExpression>
                                    <L7p:AssertionComment assertionComment="included">
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="Extrae el Body"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:AssertionComment>
                                    <L7p:Expression stringValue="$.Body.CustomerAccount.CustomerAccountBalance"/>
                                    <L7p:OtherTargetMessageVariable stringValue="jsonResponse"/>
                                    <L7p:Target target="OTHER"/>
                                    <L7p:VariablePrefix stringValue="resultBody3"/>
                                </L7p:EvaluateJsonPathExpression>
                                <L7p:Regex>
                                    <L7p:AssertionComment assertionComment="included">
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="Arregla el Body"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:AssertionComment>
                                    <L7p:AutoTarget booleanValue="false"/>
                                    <L7p:OtherTargetMessageVariable stringValue="resultBody.result"/>
                                    <L7p:Regex stringValue="^\{|\}$"/>
                                    <L7p:Replace booleanValue="true"/>
                                    <L7p:Replacement stringValue=""/>
                                    <L7p:Target target="OTHER"/>
                                </L7p:Regex>
                                <L7p:SetVariable>
                                    <L7p:AssertionComment assertionComment="included">
                                    <L7p:Properties mapValue="included">
                                    <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="Arregla el Body"/>
                                    </L7p:entry>
                                    </L7p:Properties>
                                    </L7p:AssertionComment>
                                    <L7p:Base64Expression stringValue="JHtyZXN1bHRCb2R5LnJlc3VsdH0="/>
                                    <L7p:VariableToSet stringValue="resultBody2"/>
                                </L7p:SetVariable>
                                <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="ew0KInJlc3VsdCI6ew0KCSJ0cmFuc2FjdGlvbklkIjoiJHtyZXF1ZXN0SWR9IiwNCgkiY29kZSI6IjIwMCIsDQoJImRlc2NyaXB0aW9uIjoiT0siLA0KCSJkZXNjcmlwdGlvbkRldGFpbCI6IlByb2Nlc2FtaWVudG8gY29uY2x1w61kbyBleGl0b3NhbWVudGUiLA0KCSJyZXNwb25zZVRpbWVzdGFtcCI6IiR7cmVzcG9uc2VUaW1lc3RhbXB9Ig0KCX0sDQoke3Jlc3VsdEJvZHkyfQ0KfQ=="/>
                                    <L7p:VariableToSet stringValue="serviceResponse2"/>
                                </L7p:SetVariable>
                                <L7p:AuditDetailAssertion>
                                    <L7p:CustomLoggerSuffix stringValue="entel.api.syslog"/>
                                    <L7p:Detail stringValue="IDTRANSACTION: ${requestId}  RESPONSE GW: ${serviceResponse} "/>
                                    <L7p:LoggingOnly booleanValue="true"/>
                                </L7p:AuditDetailAssertion>
                                <L7p:ExportVariables>
                                    <L7p:ExportedVars stringArrayValue="included">
                                    <L7p:item stringValue="code"/>
                                    <L7p:item stringValue="description"/>
                                    <L7p:item stringValue="httpRouting.reasonCode"/>
                                    <L7p:item stringValue="resultBody.results"/>
                                    <L7p:item stringValue="resultBody2"/>
                                    </L7p:ExportedVars>
                                </L7p:ExportVariables>
                                <L7p:HardcodedResponse>
                                    <L7p:Base64ResponseBody stringValue="JHtzZXJ2aWNlUmVzcG9uc2V9CgoK"/>
                                    <L7p:ResponseContentType stringValue="application/json; charset=utf-8"/>
                                </L7p:HardcodedResponse>
                            </wsp:All>
                            <wsp:All wsp:Usage="Required">
                                <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="ew0KInJlc3VsdCI6ew0KCSJ0cmFuc2FjdGlvbklkIjoiJHtyZXF1ZXN0SWR9IiwNCgkiY29kZSI6IjIwMCIsDQoJImRlc2NyaXB0aW9uIjoiT0siLA0KCSJkZXNjcmlwdGlvbkRldGFpbCI6IlByb2Nlc2FtaWVudG8gY29uY2x1w61kbyBleGl0b3NhbWVudGUiLA0KCSJyZXNwb25zZVRpbWVzdGFtcCI6IiR7cmVzcG9uc2VUaW1lc3RhbXB9Ig0KCX0NCn0="/>
                                    <L7p:VariableToSet stringValue="serviceResponse2"/>
                                </L7p:SetVariable>
                                <L7p:AuditDetailAssertion>
                                    <L7p:CustomLoggerSuffix stringValue="entel.api.syslog"/>
                                    <L7p:Detail stringValue="IDTRANSACTION: ${requestId}  RESPONSE GW: ${serviceResponse} "/>
                                    <L7p:LoggingOnly booleanValue="true"/>
                                </L7p:AuditDetailAssertion>
                                <L7p:ExportVariables>
                                    <L7p:ExportedVars stringArrayValue="included">
                                    <L7p:item stringValue="code"/>
                                    <L7p:item stringValue="description"/>
                                    <L7p:item stringValue="httpRouting.reasonCode"/>
                                    <L7p:item stringValue="resultBody.results"/>
                                    <L7p:item stringValue="resultBody2"/>
                                    </L7p:ExportedVars>
                                </L7p:ExportVariables>
                                <L7p:HardcodedResponse>
                                    <L7p:Base64ResponseBody stringValue="JHtzZXJ2aWNlUmVzcG9uc2V9CgoK"/>
                                    <L7p:ResponseContentType stringValue="application/json; charset=utf-8"/>
                                </L7p:HardcodedResponse>
                            </wsp:All>
                        </wsp:OneOrMore>
                        <L7p:assertionComment>
                            <L7p:Properties mapValue="included">
                                <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="OK"/>
                                </L7p:entry>
                            </L7p:Properties>
                        </L7p:assertionComment>
                    </wsp:All>
                    <wsp:All wsp:Usage="Required">
                        <L7p:Encapsulated>
                            <L7p:EncapsulatedAssertionConfigGuid stringValue="14295f18-da19-4f0e-9643-a8c30b3544dc"/>
                            <L7p:EncapsulatedAssertionConfigName stringValue="CodeStatus"/>
                        </L7p:Encapsulated>
                        <L7p:EvaluateJsonPathExpression>
                            <L7p:Expression stringValue=".SourceError.description"/>
                            <L7p:Target target="RESPONSE"/>
                            <L7p:VariablePrefix stringValue="descriptionDetail"/>
                        </L7p:EvaluateJsonPathExpression>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="JHtkZXNjcmlwdGlvbkRldGFpbC5yZXN1bHR9"/>
                            <L7p:VariableToSet stringValue="descriptionDetail"/>
                        </L7p:SetVariable>
                        <L7p:EvaluateJsonPathExpression>
                            <L7p:Expression stringValue=".SourceError.code"/>
                            <L7p:Target target="RESPONSE"/>
                            <L7p:VariablePrefix stringValue="codeSource"/>
                        </L7p:EvaluateJsonPathExpression>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="JHtjb2RlU291cmNlLnJlc3VsdH0="/>
                            <L7p:VariableToSet stringValue="codeSource"/>
                        </L7p:SetVariable>
                        <L7p:AuditDetailAssertion>
                            <L7p:CustomLoggerSuffix stringValue="entel.api.syslog"/>
                            <L7p:Detail stringValue="IDTRANSACTION: ${requestId} CODE: ${code} DESCRIPTION: ${description} DETAIL: ${descriptionDetail}"/>
                            <L7p:LoggingOnly booleanValue="true"/>
                        </L7p:AuditDetailAssertion>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="JHtyZXF1ZXN0LnRpbWUubG9jYWwueXl5eS1NTS1kZCdUJ0hIOm1tOnNzLlNTU30="/>
                            <L7p:VariableToSet stringValue="responseTimestamp"/>
                        </L7p:SetVariable>
                        <L7p:ExportVariables>
                            <L7p:ExportedVars stringArrayValue="included">
                                <L7p:item stringValue="code"/>
                                <L7p:item stringValue="codeDescription"/>
                                <L7p:item stringValue="codeSource"/>
                                <L7p:item stringValue="codeSource.count"/>
                                <L7p:item stringValue="codeSource.found"/>
                                <L7p:item stringValue="codeSource.result"/>
                                <L7p:item stringValue="codeSource.results"/>
                                <L7p:item stringValue="description"/>
                            </L7p:ExportedVars>
                        </L7p:ExportVariables>
                        <L7p:CustomizeErrorResponse>
                            <L7p:Content stringValueReference="inline"><![CDATA[{
"result":{
	"transactionId":"${requestId}",
	"code":"${httpRouting.ReasonCode}",
	"description":"${codeDescription}",
	"descriptionDetail":"${codeSource} - ${descriptionDetail}",
	"responseTimestamp":"${responseTimestamp}"
	}
}]]></L7p:Content>
                            <L7p:ContentType stringValue="application/json; charset=UTF-8"/>
                            <L7p:ExtraHeaders nameValuePairArray="included"/>
                            <L7p:HttpStatus stringValue="${httpRouting.reasonCode}"/>
                        </L7p:CustomizeErrorResponse>
                        <L7p:RaiseError/>
                        <L7p:assertionComment>
                            <L7p:Properties mapValue="included">
                                <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="NOK"/>
                                </L7p:entry>
                            </L7p:Properties>
                        </L7p:assertionComment>
                    </wsp:All>
                    <L7p:Include>
                        <L7p:AssertionComment assertionComment="included">
                            <L7p:Properties mapValue="included">
                                <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="NOK - Otros errores"/>
                                </L7p:entry>
                            </L7p:Properties>
                        </L7p:AssertionComment>
                        <L7p:PolicyGuid stringValue="1b3f18a3-5e88-4cae-9fae-44b459727ac1"/>
                    </L7p:Include>
                </wsp:OneOrMore>
            </wsp:All>
        </wsp:OneOrMore>
    </wsp:All>
</wsp:Policy>