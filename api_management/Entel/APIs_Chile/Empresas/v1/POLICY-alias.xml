<?xml version="1.0" encoding="UTF-8"?>
<wsp:Policy xmlns:L7p="http://www.layer7tech.com/ws/policy" xmlns:wsp="http://schemas.xmlsoap.org/ws/2002/12/policy">
    <wsp:All wsp:Usage="Required">
        <L7p:AuditDetailAssertion>
            <L7p:Detail stringValue="Policy Fragment: alias"/>
        </L7p:AuditDetailAssertion>
        <wsp:OneOrMore wsp:Usage="Required">
            <wsp:All wsp:Usage="Required">
                <L7p:JSONSchema>
                    <L7p:ResourceInfo staticResourceInfo="included">
                        <L7p:Document stringValueReference="inline"><![CDATA[1 {
 2   "definitions": {}, 
 3   "$schema": "http://json-schema.org/draft-07/schema#", 
 4   "$id": "http://example.com/root.json", 
 5   "type": "object", 
 6   "title": "The Root Schema", 
 7   "required": [
 8     "lineaIn", 
 9     "alias"
10   ], 
11   "properties": {
12     "lineaIn": {
13       "$id": "#/properties/lineaIn", 
14       "type": "string", 
15       "title": "The Lineain Schema", 
16       "default": "", 
17       "examples": [
18         ""
19       ], 
20       "pattern": "^(.*)$"
21     }, 
22     "alias": {
23       "$id": "#/properties/alias", 
24       "type": "string", 
25       "title": "The Alias Schema", 
26       "default": "", 
27       "examples": [
28         ""
29       ], 
30       "pattern": "^(.*)$"
31     }
32   }
33 }]]></L7p:Document>
                    </L7p:ResourceInfo>
                </L7p:JSONSchema>
                <wsp:All wsp:Usage="Required">
                    <L7p:SetVariable>
                        <L7p:Base64Expression stringValue="QTE="/>
                        <L7p:VariableToSet stringValue="code"/>
                    </L7p:SetVariable>
                    <L7p:SetVariable>
                        <L7p:Base64Expression stringValue="SW52YWxpZCBwYXJhbWV0ZXI="/>
                        <L7p:VariableToSet stringValue="description"/>
                    </L7p:SetVariable>
                    <L7p:SetVariable>
                        <L7p:Base64Expression stringValue="U3RydWN0dXJlIG9mIEpTT04gaW52YWxpZA=="/>
                        <L7p:VariableToSet stringValue="descriptionDetail"/>
                    </L7p:SetVariable>
                    <L7p:SetVariable>
                        <L7p:Base64Expression stringValue="JHtyZXF1ZXN0LnRpbWUubG9jYWwueXl5eS9NTS9kZCdUJ0hIOm1tOnNzLlNTU30="/>
                        <L7p:VariableToSet stringValue="responseTimestamp"/>
                    </L7p:SetVariable>
                    <L7p:AuditDetailAssertion>
                        <L7p:CustomLoggerSuffix stringValue="entel.api.syslog"/>
                        <L7p:Detail stringValue="TRANSACTION: ${requestId} CODE: ${code} DESCRIPTION: ${description} DETAIL: ${descriptionDetail}"/>
                        <L7p:LoggingOnly booleanValue="true"/>
                    </L7p:AuditDetailAssertion>
                    <L7p:CustomizeErrorResponse>
                        <L7p:Content stringValueReference="inline"><![CDATA[{
"result":{
	"transactionId":"${requestId}",
	"code":"${code}",
	"description":"${description}",
	"descriptionDetail":"${descriptionDetail}",
	"responseTimestamp":"${responseTimestamp}"
	}
}]]></L7p:Content>
                        <L7p:ContentType stringValue="application/json; charset=UTF-8"/>
                        <L7p:ExtraHeaders nameValuePairArray="included"/>
                        <L7p:HttpStatus stringValue="400"/>
                    </L7p:CustomizeErrorResponse>
                    <L7p:RaiseError/>
                </wsp:All>
            </wsp:All>
            <wsp:OneOrMore wsp:Usage="Required">
                <wsp:All wsp:Usage="Required">
                    <L7p:AuditDetailAssertion>
                        <L7p:CustomLoggerSuffix stringValue="entel.api.syslog"/>
                        <L7p:Detail stringValue="IDTRANSACTION: ${requestId}  REQUEST BACKEND: ${request.mainpart}"/>
                        <L7p:LoggingOnly booleanValue="true"/>
                    </L7p:AuditDetailAssertion>
                    <L7p:HttpRoutingAssertion>
                        <L7p:FailOnErrorStatus booleanValue="false"/>
                        <L7p:HttpMethod httpMethod="PUT"/>
                        <L7p:ProtectedServiceUrl stringValue="https://api.entel.cl/empresas/alias"/>
                        <L7p:ProxyPassword stringValueNull="null"/>
                        <L7p:ProxyUsername stringValueNull="null"/>
                        <L7p:RequestHeaderRules httpPassthroughRuleSet="included">
                            <L7p:ForwardAll booleanValue="true"/>
                            <L7p:Rules httpPassthroughRules="included">
                                <L7p:item httpPassthroughRule="included">
                                    <L7p:Name stringValue="Cookie"/>
                                </L7p:item>
                                <L7p:item httpPassthroughRule="included">
                                    <L7p:Name stringValue="SOAPAction"/>
                                </L7p:item>
                            </L7p:Rules>
                        </L7p:RequestHeaderRules>
                        <L7p:RequestParamRules httpPassthroughRuleSet="included">
                            <L7p:ForwardAll booleanValue="true"/>
                            <L7p:Rules httpPassthroughRules="included"/>
                        </L7p:RequestParamRules>
                        <L7p:ResponseHeaderRules httpPassthroughRuleSet="included">
                            <L7p:ForwardAll booleanValue="true"/>
                            <L7p:Rules httpPassthroughRules="included">
                                <L7p:item httpPassthroughRule="included">
                                    <L7p:Name stringValue="Set-Cookie"/>
                                </L7p:item>
                            </L7p:Rules>
                        </L7p:ResponseHeaderRules>
                        <L7p:SamlAssertionVersion intValue="2"/>
                    </L7p:HttpRoutingAssertion>
                    <L7p:AuditDetailAssertion>
                        <L7p:CustomLoggerSuffix stringValue="entel.api.syslog"/>
                        <L7p:Detail stringValue="IDTRANSACTION: ${requestId} BACKEND: ${httpRouting.url} LATENCY: ${httpRouting.latency} ms REASON CODE: ${httpRouting.reasonCode} RESPONSEBACKEND: ${response.mainpart} "/>
                        <L7p:LoggingOnly booleanValue="true"/>
                    </L7p:AuditDetailAssertion>
                    <L7p:ComparisonAssertion>
                        <L7p:AssertionComment assertionComment="included">
                            <L7p:Properties mapValue="included">
                                <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="Evalua si el estado de la respuesta es OK"/>
                                </L7p:entry>
                            </L7p:Properties>
                        </L7p:AssertionComment>
                        <L7p:Expression1 stringValue="${httpRouting.reasonCode}"/>
                        <L7p:Expression2 stringValue="200"/>
                        <L7p:Predicates predicates="included">
                            <L7p:item binary="included">
                                <L7p:RightValue stringValue="200"/>
                            </L7p:item>
                        </L7p:Predicates>
                    </L7p:ComparisonAssertion>
                    <L7p:EvaluateJsonPathExpression>
                        <L7p:Expression stringValue=".code"/>
                        <L7p:OtherTargetMessageVariable stringValue="serviceResponse"/>
                        <L7p:Target target="OTHER"/>
                        <L7p:VariablePrefix stringValue="codeResult"/>
                    </L7p:EvaluateJsonPathExpression>
                    <L7p:EvaluateJsonPathExpression>
                        <L7p:Expression stringValue=".message"/>
                        <L7p:OtherTargetMessageVariable stringValue="serviceResponse"/>
                        <L7p:Target target="OTHER"/>
                        <L7p:VariablePrefix stringValue="message"/>
                    </L7p:EvaluateJsonPathExpression>
                    <L7p:SetVariable>
                        <L7p:Base64Expression stringValue="JHtyZXF1ZXN0LnRpbWUubG9jYWwueXl5eS1NTS1kZCdUJ0hIOm1tOnNzLlNTU30="/>
                        <L7p:VariableToSet stringValue="responseTimestamp"/>
                    </L7p:SetVariable>
                    <L7p:SetVariable>
                        <L7p:Base64Expression stringValue="ew0KInJlc3VsdCI6ew0KCSJ0cmFuc2FjdGlvbklkIjoiJHtyZXF1ZXN0SWR9IiwNCgkiY29kZSI6IiR7Y29kZVJlc3VsdC5yZXN1bHR9IiwNCgkiZGVzY3JpcHRpb24iOiJPSyIsDQoJImRlc2NyaXB0aW9uRGV0YWlsIjoiJHttZXNzYWdlLnJlc3VsdH0iLA0KCSJyZXNwb25zZVRpbWVzdGFtcCI6IiR7cmVzcG9uc2VUaW1lc3RhbXB9Ig0KCX0NCn0="/>
                        <L7p:VariableToSet stringValue="serviceRsp"/>
                    </L7p:SetVariable>
                    <L7p:AuditDetailAssertion>
                        <L7p:CustomLoggerSuffix stringValue="entel.api.syslog"/>
                        <L7p:Detail stringValue="IDTRANSACTION: ${requestId}  RESPONSE GW: ${serviceRsp} "/>
                        <L7p:LoggingOnly booleanValue="true"/>
                    </L7p:AuditDetailAssertion>
                    <L7p:HardcodedResponse>
                        <L7p:Base64ResponseBody stringValue="JHtzZXJ2aWNlUnNwfQoKCg=="/>
                        <L7p:ResponseContentType stringValue="application/json; charset=utf-8"/>
                    </L7p:HardcodedResponse>
                </wsp:All>
                <wsp:All wsp:Usage="Required">
                    <L7p:Encapsulated>
                        <L7p:EncapsulatedAssertionConfigGuid stringValue="14295f18-da19-4f0e-9643-a8c30b3544dc"/>
                        <L7p:EncapsulatedAssertionConfigName stringValue="CodeStatus"/>
                    </L7p:Encapsulated>
                    <L7p:EvaluateJsonPathExpression>
                        <L7p:Expression stringValue=".code"/>
                        <L7p:OtherTargetMessageVariable stringValue="serviceResponse"/>
                        <L7p:Target target="OTHER"/>
                        <L7p:VariablePrefix stringValue="codeResullt"/>
                    </L7p:EvaluateJsonPathExpression>
                    <L7p:EvaluateJsonPathExpression>
                        <L7p:Expression stringValue=".message"/>
                        <L7p:OtherTargetMessageVariable stringValue="serviceResponse"/>
                        <L7p:Target target="OTHER"/>
                        <L7p:VariablePrefix stringValue="message"/>
                    </L7p:EvaluateJsonPathExpression>
                    <L7p:SetVariable>
                        <L7p:Base64Expression stringValue="JHtyZXF1ZXN0LnRpbWUubG9jYWwueXl5eS1NTS1kZCdUJ0hIOm1tOnNzLlNTU30="/>
                        <L7p:VariableToSet stringValue="responseTimestamp"/>
                    </L7p:SetVariable>
                    <L7p:AuditDetailAssertion>
                        <L7p:CustomLoggerSuffix stringValue="entel.api.syslog"/>
                        <L7p:Detail stringValue="IDTRANSACTION: ${requestId} CODE: ${code} DESCRIPTION: ${description} DETAIL: ${descriptionDetail}"/>
                        <L7p:LoggingOnly booleanValue="true"/>
                    </L7p:AuditDetailAssertion>
                    <L7p:CustomizeErrorResponse>
                        <L7p:Content stringValueReference="inline"><![CDATA[{
"result":{
	"transactionId":"${requestId}",
	"code":"${codeResult.result},
	"description":"${codeDescription}",
	"descriptionDetail":"${mensaje.result}",
	"responseTimestamp":"${responseTimestamp}"
	}
}]]></L7p:Content>
                        <L7p:ContentType stringValue="application/json; charset=UTF-8"/>
                        <L7p:ExtraHeaders nameValuePairArray="included"/>
                        <L7p:HttpStatus stringValue="400"/>
                    </L7p:CustomizeErrorResponse>
                    <L7p:RaiseError/>
                </wsp:All>
                <L7p:Include>
                    <L7p:PolicyGuid stringValue="1b3f18a3-5e88-4cae-9fae-44b459727ac1"/>
                </L7p:Include>
                <L7p:assertionComment>
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="RIGHT.COMMENT"/>
                            <L7p:value stringValue="Logica"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:assertionComment>
            </wsp:OneOrMore>
        </wsp:OneOrMore>
    </wsp:All>
</wsp:Policy>