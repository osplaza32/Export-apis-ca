<?xml version="1.0" encoding="UTF-8"?>
<wsp:Policy xmlns:L7p="http://www.layer7tech.com/ws/policy" xmlns:wsp="http://schemas.xmlsoap.org/ws/2002/12/policy">
    <wsp:All wsp:Usage="Required">
        <L7p:AuditDetailAssertion>
            <L7p:Detail stringValue="Policy Fragment: APIM-getContractState"/>
        </L7p:AuditDetailAssertion>
        <L7p:SetVariable>
            <L7p:Base64Expression stringValue="JHtyZXF1ZXN0LnNzbC5zZXNzaW9uaWR9"/>
            <L7p:VariableToSet stringValue="idTransaction"/>
        </L7p:SetVariable>
        <wsp:OneOrMore wsp:Usage="Required">
            <wsp:All wsp:Usage="Required">
                <L7p:ComparisonAssertion>
                    <L7p:CaseSensitive booleanValue="false"/>
                    <L7p:Expression1 stringValue="${url.length}"/>
                    <L7p:Expression2 stringValue="4"/>
                    <L7p:Predicates predicates="included">
                        <L7p:item binary="included">
                            <L7p:CaseSensitive booleanValue="false"/>
                            <L7p:RightValue stringValue="4"/>
                        </L7p:item>
                    </L7p:Predicates>
                </L7p:ComparisonAssertion>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="JHt1cmxbM119"/>
                    <L7p:VariableToSet stringValue="msisdn"/>
                </L7p:SetVariable>
                <L7p:Regex>
                    <L7p:AutoTarget booleanValue="false"/>
                    <L7p:OtherTargetMessageVariable stringValue="msisdn"/>
                    <L7p:Regex stringValue="^(569){1}\d{8}\b"/>
                    <L7p:RegexName stringValue="regularNumberPhone"/>
                    <L7p:RegexVar stringValue="regularExpresion"/>
                    <L7p:Replacement stringValue=""/>
                    <L7p:Target target="OTHER"/>
                </L7p:Regex>
            </wsp:All>
            <wsp:All wsp:Usage="Required">
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="SW52YWxpZCBwYXJhbWV0ZXI="/>
                    <L7p:VariableToSet stringValue="description"/>
                </L7p:SetVariable>
                <L7p:AuditDetailAssertion>
                    <L7p:CustomLoggerSuffix stringValue="entel.api.syslog"/>
                    <L7p:Detail stringValue="idOperation: ${idTransaction} ResourceId: ${msisdn} Message: ${description} Service: ${request.http.uri}"/>
                    <L7p:LoggingOnly booleanValue="true"/>
                </L7p:AuditDetailAssertion>
                <L7p:CustomizeErrorResponse>
                    <L7p:Content stringValueReference="inline"><![CDATA[{
"error":"Invalid parameter"
}]]></L7p:Content>
                    <L7p:ContentType stringValue="application/json; charset=UTF-8"/>
                    <L7p:ExtraHeaders nameValuePairArray="included"/>
                    <L7p:HttpStatus stringValue="400"/>
                </L7p:CustomizeErrorResponse>
                <L7p:RaiseError/>
            </wsp:All>
            <L7p:assertionComment>
                <L7p:Properties mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="LEFT.COMMENT"/>
                        <L7p:value stringValue="validar parametro entrada"/>
                    </L7p:entry>
                </L7p:Properties>
            </L7p:assertionComment>
        </wsp:OneOrMore>
        <wsp:All wsp:Usage="Required">
            <wsp:OneOrMore wsp:Usage="Required">
                <wsp:All wsp:Usage="Required">
                    <L7p:HttpRoutingAssertion>
                        <L7p:Enabled booleanValue="false"/>
                        <L7p:HttpMethod httpMethod="GET"/>
                        <L7p:Login stringValue="EUSBUSER"/>
                        <L7p:Password stringValue="EUSBUSER"/>
                        <L7p:ProtectedServiceUrl stringValue="http://${gateway.asset.ip}/eoc/avmSecurity/getToken"/>
                        <L7p:ProxyPassword stringValueNull="null"/>
                        <L7p:ProxyUsername stringValueNull="null"/>
                        <L7p:RequestHeaderRules httpPassthroughRuleSet="included">
                            <L7p:ForwardAll booleanValue="true"/>
                            <L7p:Rules httpPassthroughRules="included">
                                <L7p:item httpPassthroughRule="included">
                                    <L7p:Name stringValue="Cookie"/>
                                </L7p:item>
                                <L7p:item httpPassthroughRule="included">
                                    <L7p:Name stringValue="SOAPAction"/>
                                </L7p:item>
                            </L7p:Rules>
                        </L7p:RequestHeaderRules>
                        <L7p:RequestParamRules httpPassthroughRuleSet="included">
                            <L7p:ForwardAll booleanValue="true"/>
                            <L7p:Rules httpPassthroughRules="included"/>
                        </L7p:RequestParamRules>
                        <L7p:ResponseHeaderRules httpPassthroughRuleSet="included">
                            <L7p:ForwardAll booleanValue="true"/>
                            <L7p:Rules httpPassthroughRules="included">
                                <L7p:item httpPassthroughRule="included">
                                    <L7p:Name stringValue="Set-Cookie"/>
                                </L7p:item>
                            </L7p:Rules>
                        </L7p:ResponseHeaderRules>
                        <L7p:ResponseMsgDest stringValue="responseGetToken"/>
                        <L7p:SamlAssertionVersion intValue="2"/>
                    </L7p:HttpRoutingAssertion>
                    <L7p:EvaluateJsonPathExpression>
                        <L7p:Enabled booleanValue="false"/>
                        <L7p:Expression stringValue=".cwtoken"/>
                        <L7p:OtherTargetMessageVariable stringValue="responseGetToken"/>
                        <L7p:Target target="OTHER"/>
                        <L7p:VariablePrefix stringValue="cwtoken"/>
                    </L7p:EvaluateJsonPathExpression>
                    <L7p:JdbcQuery>
                        <L7p:AssertionFailureEnabled booleanValue="false"/>
                        <L7p:ConnectionName stringValue="TransGooglePlay"/>
                        <L7p:ConvertVariablesToStrings booleanValue="false"/>
                        <L7p:SqlQuery stringValue="SELECT TOKEN FROM TOKEN_ASSET WHERE IDTOKEN = 1"/>
                    </L7p:JdbcQuery>
                    <L7p:SetVariable>
                        <L7p:Base64Expression stringValue="JHthc3NlcnRpb24ubGF0ZW5jeS5tc30="/>
                        <L7p:VariableToSet stringValue="latencyBD"/>
                    </L7p:SetVariable>
                    <L7p:SetVariable>
                        <L7p:Base64Expression stringValue="JHtqZGJjUXVlcnkuVE9LRU5bMF19"/>
                        <L7p:VariableToSet stringValue="cwtoken"/>
                    </L7p:SetVariable>
                </wsp:All>
                <wsp:All wsp:Usage="Required">
                    <L7p:SetVariable>
                        <L7p:Base64Expression stringValue="Q2FuJ3QgZ2V0IHRva2Vu"/>
                        <L7p:VariableToSet stringValue="description"/>
                    </L7p:SetVariable>
                    <L7p:AuditDetailAssertion>
                        <L7p:CustomLoggerSuffix stringValue="entel.api.syslog"/>
                        <L7p:Detail stringValue="idOperation: ${idTransaction} ResourceId: ${msisdn} Message: ${description} Service: ${request.http.uri}"/>
                        <L7p:LoggingOnly booleanValue="true"/>
                    </L7p:AuditDetailAssertion>
                    <L7p:CustomizeErrorResponse>
                        <L7p:Content stringValueReference="inline"><![CDATA[{
"error":"Can't get token"
}]]></L7p:Content>
                        <L7p:ContentType stringValue="application/json; charset=UTF-8"/>
                        <L7p:ExtraHeaders nameValuePairArray="included"/>
                    </L7p:CustomizeErrorResponse>
                    <L7p:RaiseError/>
                </wsp:All>
            </wsp:OneOrMore>
            <wsp:OneOrMore wsp:Usage="Required">
                <wsp:All wsp:Usage="Required">
                    <L7p:HttpRoutingAssertion>
                        <L7p:AuthOauthTokenVar stringValue="cwtoken"/>
                        <L7p:AuthOauthVersion stringValue="2.0"/>
                        <L7p:FailOnErrorStatus booleanValue="false"/>
                        <L7p:ProtectedServiceUrl stringValue="http://${gateway.asset.hostname}/eoc/integration/v1/product/?MSISDN=${msisdn}"/>
                        <L7p:ProxyPassword stringValueNull="null"/>
                        <L7p:ProxyUsername stringValueNull="null"/>
                        <L7p:RequestHeaderRules httpPassthroughRuleSet="included">
                            <L7p:ForwardAll booleanValue="true"/>
                            <L7p:Rules httpPassthroughRules="included">
                                <L7p:item httpPassthroughRule="included">
                                    <L7p:Name stringValue="Cookie"/>
                                </L7p:item>
                                <L7p:item httpPassthroughRule="included">
                                    <L7p:Name stringValue="SOAPAction"/>
                                </L7p:item>
                            </L7p:Rules>
                        </L7p:RequestHeaderRules>
                        <L7p:RequestParamRules httpPassthroughRuleSet="included">
                            <L7p:ForwardAll booleanValue="true"/>
                            <L7p:Rules httpPassthroughRules="included"/>
                        </L7p:RequestParamRules>
                        <L7p:ResponseHeaderRules httpPassthroughRuleSet="included">
                            <L7p:ForwardAll booleanValue="true"/>
                            <L7p:Rules httpPassthroughRules="included">
                                <L7p:item httpPassthroughRule="included">
                                    <L7p:Name stringValue="Set-Cookie"/>
                                </L7p:item>
                            </L7p:Rules>
                        </L7p:ResponseHeaderRules>
                        <L7p:ResponseMsgDest stringValue="responseGetAsset"/>
                        <L7p:SamlAssertionVersion intValue="2"/>
                    </L7p:HttpRoutingAssertion>
                    <L7p:ComparisonAssertion>
                        <L7p:CaseSensitive booleanValue="false"/>
                        <L7p:Expression1 stringValue="${httpRouting.reasonCode}"/>
                        <L7p:Operator operatorNull="null"/>
                        <L7p:Predicates predicates="included">
                            <L7p:item dataType="included">
                                <L7p:Type variableDataType="int"/>
                            </L7p:item>
                            <L7p:item binary="included">
                                <L7p:CaseSensitive booleanValue="false"/>
                                <L7p:RightValue stringValue="200"/>
                            </L7p:item>
                        </L7p:Predicates>
                    </L7p:ComparisonAssertion>
                    <L7p:EvaluateJsonPathExpression>
                        <L7p:Expression stringValue=".productCharacteristics[?(@.name=='contractState')].value"/>
                        <L7p:OtherTargetMessageVariable stringValue="responseGetAsset"/>
                        <L7p:Target target="OTHER"/>
                        <L7p:VariablePrefix stringValue="contractStatus"/>
                    </L7p:EvaluateJsonPathExpression>
                    <wsp:OneOrMore wsp:Usage="Required">
                        <wsp:All wsp:Usage="Required">
                            <L7p:ComparisonAssertion>
                                <L7p:CaseSensitive booleanValue="false"/>
                                <L7p:Expression1 stringValue="${contractStatus.result}"/>
                                <L7p:Operator operatorNull="null"/>
                                <L7p:Predicates predicates="included">
                                    <L7p:item dataType="included">
                                    <L7p:Type variableDataType="string"/>
                                    </L7p:item>
                                    <L7p:item binary="included">
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:RightValue stringValue="Active"/>
                                    </L7p:item>
                                </L7p:Predicates>
                            </L7p:ComparisonAssertion>
                            <L7p:SetVariable>
                                <L7p:Base64Expression stringValue="Y29udHJhY3QgYWN0aXZl"/>
                                <L7p:VariableToSet stringValue="description"/>
                            </L7p:SetVariable>
                            <L7p:AuditDetailAssertion>
                                <L7p:CustomLoggerSuffix stringValue="entel.api.syslog"/>
                                <L7p:Detail stringValue="idOperation: ${idTransaction} ResourceId: ${msisdn} Message: ${description} Service: ${request.http.uri}"/>
                                <L7p:LoggingOnly booleanValue="true"/>
                            </L7p:AuditDetailAssertion>
                            <L7p:HardcodedResponse>
                                <L7p:Base64ResponseBody stringValue="ewoiY29kZSI6ICIwIiwKImRlc2NyaXB0aW9uIjogImNvbnRyYWN0IGFjdGl2ZSIKfQ=="/>
                                <L7p:ResponseContentType stringValue="application/json; charset=UTF-8"/>
                            </L7p:HardcodedResponse>
                        </wsp:All>
                        <wsp:All wsp:Usage="Required">
                            <L7p:SetVariable>
                                <L7p:Base64Expression stringValue="Y29udHJhY3Qgbm90IGFjdGl2ZQ=="/>
                                <L7p:VariableToSet stringValue="description"/>
                            </L7p:SetVariable>
                            <L7p:AuditDetailAssertion>
                                <L7p:CustomLoggerSuffix stringValue="entel.api.syslog"/>
                                <L7p:Detail stringValue="idOperation: ${idTransaction} ResourceId: ${msisdn} Message: ${description} Service: ${request.http.uri}"/>
                                <L7p:LoggingOnly booleanValue="true"/>
                            </L7p:AuditDetailAssertion>
                            <L7p:HardcodedResponse>
                                <L7p:Base64ResponseBody stringValue="ewoiY29kZSI6ICIxIiwKImRlc2NyaXB0aW9uIjogImNvbnRyYWN0IG5vdCBhY3RpdmUiCn0="/>
                                <L7p:ResponseContentType stringValue="application/json; charset=UTF-8"/>
                            </L7p:HardcodedResponse>
                        </wsp:All>
                        <L7p:assertionComment>
                            <L7p:Properties mapValue="included">
                                <L7p:entry>
                                    <L7p:key stringValue="LEFT.COMMENT"/>
                                    <L7p:value stringValue="Contract Valid"/>
                                </L7p:entry>
                            </L7p:Properties>
                        </L7p:assertionComment>
                    </wsp:OneOrMore>
                    <L7p:assertionComment>
                        <L7p:Properties mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="LEFT.COMMENT"/>
                                <L7p:value stringValue="GetAsset"/>
                            </L7p:entry>
                        </L7p:Properties>
                    </L7p:assertionComment>
                </wsp:All>
                <wsp:All wsp:Usage="Required">
                    <L7p:SetVariable>
                        <L7p:Base64Expression stringValue="Q2FuJ3QgZ2V0IGNvbnRyYWN0IGFzc2V0"/>
                        <L7p:VariableToSet stringValue="description"/>
                    </L7p:SetVariable>
                    <L7p:AuditDetailAssertion>
                        <L7p:CustomLoggerSuffix stringValue="entel.api.syslog"/>
                        <L7p:Detail stringValue="idOperation: ${idTransaction} ResourceId: ${msisdn} Message: ${description} Service: ${request.http.uri}"/>
                        <L7p:LoggingOnly booleanValue="true"/>
                    </L7p:AuditDetailAssertion>
                    <L7p:CustomizeErrorResponse>
                        <L7p:Content stringValueReference="inline"><![CDATA[{
"error":"Can't get contract asset"
}]]></L7p:Content>
                        <L7p:ContentType stringValue="application/json; charset=UTF-8"/>
                        <L7p:ExtraHeaders nameValuePairArray="included"/>
                    </L7p:CustomizeErrorResponse>
                    <L7p:RaiseError/>
                </wsp:All>
            </wsp:OneOrMore>
        </wsp:All>
    </wsp:All>
</wsp:Policy>