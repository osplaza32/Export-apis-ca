<?xml version="1.0" encoding="UTF-8"?>
<wsp:Policy xmlns:L7p="http://www.layer7tech.com/ws/policy" xmlns:wsp="http://schemas.xmlsoap.org/ws/2002/12/policy">
    <wsp:All wsp:Usage="Required">
        <wsp:All wsp:Usage="Required">
            <L7p:Encapsulated>
                <L7p:EncapsulatedAssertionConfigGuid stringValue="14295f18-da19-4f0e-9643-a8c30b3544dc"/>
                <L7p:EncapsulatedAssertionConfigName stringValue="CodeStatus"/>
            </L7p:Encapsulated>
            <L7p:Regex>
                <L7p:AutoTarget booleanValue="false"/>
                <L7p:Regex stringValue="&quot;description&quot; : null"/>
                <L7p:Replace booleanValue="true"/>
                <L7p:Replacement stringValue="&quot;description&quot; : &quot;null&quot;"/>
                <L7p:Target target="RESPONSE"/>
            </L7p:Regex>
            <L7p:EvaluateJsonPathExpression>
                <L7p:Expression stringValue=".SourceError.description"/>
                <L7p:Target target="RESPONSE"/>
                <L7p:VariablePrefix stringValue="descriptionDetail"/>
            </L7p:EvaluateJsonPathExpression>
            <L7p:SetVariable>
                <L7p:Base64Expression stringValue="JHtkZXNjcmlwdGlvbkRldGFpbC5yZXN1bHR9"/>
                <L7p:VariableToSet stringValue="descriptionDetail"/>
            </L7p:SetVariable>
            <L7p:EvaluateJsonPathExpression>
                <L7p:Expression stringValue=".SourceError.code"/>
                <L7p:Target target="RESPONSE"/>
                <L7p:VariablePrefix stringValue="codeSource"/>
            </L7p:EvaluateJsonPathExpression>
            <L7p:SetVariable>
                <L7p:Base64Expression stringValue="JHtjb2RlU291cmNlLnJlc3VsdH0="/>
                <L7p:VariableToSet stringValue="codeSource"/>
            </L7p:SetVariable>
            <L7p:SetVariable>
                <L7p:Base64Expression stringValue="JHtyZXF1ZXN0LnRpbWUubG9jYWwueXl5eS1NTS1kZCdUJ0hIOm1tOnNzLlNTU30="/>
                <L7p:VariableToSet stringValue="responseTimestamp"/>
            </L7p:SetVariable>
            <L7p:AuditDetailAssertion>
                <L7p:CustomLoggerSuffix stringValue="entel.api.syslog"/>
                <L7p:Detail stringValue="REQUESTID: ${requestId} | EVENTID: ${eventId} | APIM ${service.name} Route Failed | IS STATUS: ${httpRouting.reasonCode} | IS URI: ${httpRouting.url} | IS REQUEST: ${message.mainpart} | IS RESPONSE: ${response.mainpart} | TIMESTAMP: ${request.time.local.yyyy-MM-dd'T'HH:mm:ss.SSS}"/>
                <L7p:Level stringValue="WARNING"/>
                <L7p:LoggingOnly booleanValue="true"/>
            </L7p:AuditDetailAssertion>
            <L7p:Encapsulated>
                <L7p:EncapsulatedAssertionConfigGuid stringValue="2873d7c1-bfb2-42b8-ab9a-35767965de80"/>
                <L7p:EncapsulatedAssertionConfigName stringValue="API Portal Integration - Post Route"/>
                <L7p:Parameters mapValue="included">
                    <L7p:entry>
                        <L7p:key stringValue="portal.analytics.response.code"/>
                        <L7p:value stringValue="500"/>
                    </L7p:entry>
                    <L7p:entry>
                        <L7p:key stringValue="portal.analytics.routingTotalTime"/>
                        <L7p:value stringValue="${assertion.latency.ms}"/>
                    </L7p:entry>
                </L7p:Parameters>
            </L7p:Encapsulated>
            <L7p:CustomizeErrorResponse>
                <L7p:Content stringValueReference="inline"><![CDATA[{
"result":{
	"transactionId":"${requestId}",
	"code":"${httpRouting.ReasonCode}",
	"description":"${codeDescription}",
	"descriptionDetail":"${codeSource} - ${descriptionDetail}",
	"responseTimestamp":"${responseTimestamp}"
	}
}]]></L7p:Content>
                <L7p:ContentType stringValue="application/json; charset=UTF-8"/>
                <L7p:ExtraHeaders nameValuePairArray="included"/>
                <L7p:HttpStatus stringValue="${httpRouting.reasonCode}"/>
            </L7p:CustomizeErrorResponse>
            <L7p:RaiseError/>
        </wsp:All>
    </wsp:All>
</wsp:Policy>