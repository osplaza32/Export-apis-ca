<?xml version="1.0" encoding="UTF-8"?>
<wsp:Policy xmlns:L7p="http://www.layer7tech.com/ws/policy" xmlns:wsp="http://schemas.xmlsoap.org/ws/2002/12/policy">
    <wsp:All wsp:Usage="Required">
        <L7p:Encapsulated>
            <L7p:EncapsulatedAssertionConfigGuid stringValue="ae2e93d4-1acf-4931-b01a-8f52407756d6"/>
            <L7p:EncapsulatedAssertionConfigName stringValue="MAG OTP Configuration"/>
        </L7p:Encapsulated>
        <wsp:All wsp:Usage="Required">
            <L7p:SetVariable>
                <L7p:Base64Expression stringValue="JHtyZXF1ZXN0Lmh0dHAucGFyYW1ldGVyLnVzZXJpZH0="/>
                <L7p:VariableToSet stringValue="userid"/>
            </L7p:SetVariable>
            <L7p:SetVariable>
                <L7p:Base64Expression stringValue="JHtyZXF1ZXN0Lmh0dHAucGFyYW1ldGVyLm90cH0="/>
                <L7p:VariableToSet stringValue="otp"/>
            </L7p:SetVariable>
            <L7p:SetVariable>
                <L7p:AssertionComment assertionComment="included">
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="LEFT.COMMENT"/>
                            <L7p:value stringValue="possible values"/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="RIGHT.COMMENT"/>
                            <L7p:value stringValue="alphanumeric, numerical"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:AssertionComment>
                <L7p:Base64Expression stringValue="JHtkZWZhdWx0T3RwVHlwZX0="/>
                <L7p:VariableToSet stringValue="otp_type"/>
            </L7p:SetVariable>
            <L7p:SetVariable>
                <L7p:AssertionComment assertionComment="included">
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="LEFT.COMMENT"/>
                            <L7p:value stringValue="possible values"/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="RIGHT.COMMENT"/>
                            <L7p:value stringValue="4 or 6 or 8"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:AssertionComment>
                <L7p:Base64Expression stringValue="JHtkZWZhdWx0T3RwTGVuZ3RofQ=="/>
                <L7p:VariableToSet stringValue="otp_length"/>
            </L7p:SetVariable>
        </wsp:All>
        <wsp:OneOrMore wsp:Usage="Required">
            <wsp:All wsp:Usage="Required">
                <L7p:Encapsulated>
                    <L7p:EncapsulatedAssertionConfigGuid stringValue="657c23a2-7b28-454b-adbd-d7f05f1a6250"/>
                    <L7p:EncapsulatedAssertionConfigName stringValue="MAG Require OTP"/>
                    <L7p:Parameters mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="notificationType"/>
                            <L7p:value stringValue="custom"/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="otp"/>
                            <L7p:value stringValue="${otp}"/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="updateDb"/>
                            <L7p:value stringValue="true"/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="userid"/>
                            <L7p:value stringValue="${userid}"/>
                        </L7p:entry>
                    </L7p:Parameters>
                </L7p:Encapsulated>
                <L7p:CommentAssertion>
                    <L7p:Comment stringValue="OTP was successfully validated, so allow access to protected resource"/>
                </L7p:CommentAssertion>
                <L7p:HardcodedResponse>
                    <L7p:Base64ResponseBody stringValue="eyAgCiAgICJxdW90ZXMiOlsgIAogICAgICB7ICAKICAgICAgICAgInByb2R1Y3RJRCI6IjEyMzQiLAogICAgICAgICAicHJvZHVjdE5hbWUiOiJDQSBTZXJ2aWNlIERlc2sgRW50ZXJwcmlzZSIsCiAgICAgICAgICJwcmljZSI6IjEwMDAwMCIKICAgICAgfSwKICAgICAgeyAgCiAgICAgICAgICJwcm9kdWN0SUQiOiIxMjM2IiwKICAgICAgICAgInByb2R1Y3ROYW1lIjoiQ0EgU2luZ2xlIFNTTyIsCiAgICAgICAgICJwcmljZSI6IjgwMDAwIgogICAgICB9LAogICAgICB7ICAKICAgICAgICAgInByb2R1Y3RJRCI6IjU2NzgiLAogICAgICAgICAicHJvZHVjdE5hbWUiOiJDQSBNb2JpbGUgQXBwIEFuYWx5dGljcyIsCiAgICAgICAgICJwcmljZSI6IjQwMDAwIgogICAgICB9LAogICAgICB7ICAKICAgICAgICAgInByb2R1Y3RJRCI6Ijk4OTkiLAogICAgICAgICAicHJvZHVjdE5hbWUiOiJDQSBBUEkgTWFuYWdlbWVudCIsCiAgICAgICAgICJwcmljZSI6IjYwMDAwIgogICAgICB9XQp9"/>
                    <L7p:EarlyResponse booleanValue="true"/>
                    <L7p:ResponseContentType stringValue="application/json; charset=UTF-8"/>
                </L7p:HardcodedResponse>
                <L7p:assertionComment>
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="RIGHT.COMMENT"/>
                            <L7p:value stringValue="// validate otp and allow access to resource"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:assertionComment>
            </wsp:All>
            <wsp:All wsp:Usage="Required">
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="JHtlcnJvci5jb2RlfQ=="/>
                    <L7p:VariableToSet stringValue="tempCode"/>
                </L7p:SetVariable>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="JHtzdGF0dXN9"/>
                    <L7p:VariableToSet stringValue="tempStatus"/>
                </L7p:SetVariable>
                <L7p:SetVariable>
                    <L7p:Base64Expression stringValue="JHtlcnJvci5tc2d9"/>
                    <L7p:VariableToSet stringValue="tempMsg"/>
                </L7p:SetVariable>
                <wsp:OneOrMore wsp:Usage="Required">
                    <wsp:All wsp:Usage="Required">
                        <L7p:ComparisonAssertion>
                            <L7p:CaseSensitive booleanValue="false"/>
                            <L7p:Expression1 stringValue="${error.code}"/>
                            <L7p:Expression2 stringValue="140"/>
                            <L7p:Predicates predicates="included">
                                <L7p:item binary="included">
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:RightValue stringValue="140"/>
                                </L7p:item>
                            </L7p:Predicates>
                        </L7p:ComparisonAssertion>
                        <L7p:AddHeader>
                            <L7p:HeaderName stringValue="X-OTP"/>
                            <L7p:HeaderValue stringValue="required"/>
                            <L7p:RemoveExisting booleanValue="true"/>
                            <L7p:Target target="RESPONSE"/>
                        </L7p:AddHeader>
                        <L7p:AddHeader>
                            <L7p:HeaderName stringValue="X-OTP-CHANNEL"/>
                            <L7p:HeaderValue stringValue="EMAIL,SMS"/>
                            <L7p:RemoveExisting booleanValue="true"/>
                            <L7p:Target target="RESPONSE"/>
                        </L7p:AddHeader>
                        <L7p:assertionComment>
                            <L7p:Properties mapValue="included">
                                <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// 140"/>
                                </L7p:entry>
                            </L7p:Properties>
                        </L7p:assertionComment>
                    </wsp:All>
                    <wsp:All wsp:Usage="Required">
                        <L7p:ComparisonAssertion>
                            <L7p:CaseSensitive booleanValue="false"/>
                            <L7p:Expression1 stringValue="${error.code}"/>
                            <L7p:Expression2 stringValue="144"/>
                            <L7p:Predicates predicates="included">
                                <L7p:item binary="included">
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:RightValue stringValue="144"/>
                                </L7p:item>
                            </L7p:Predicates>
                        </L7p:ComparisonAssertion>
                        <L7p:AddHeader>
                            <L7p:HeaderName stringValue="X-OTP"/>
                            <L7p:HeaderValue stringValue="invalid"/>
                            <L7p:RemoveExisting booleanValue="true"/>
                            <L7p:Target target="RESPONSE"/>
                        </L7p:AddHeader>
                        <L7p:AddHeader>
                            <L7p:HeaderName stringValue="X-OTP-RETRY"/>
                            <L7p:HeaderValue stringValue="-1"/>
                            <L7p:RemoveExisting booleanValue="true"/>
                            <L7p:Target target="RESPONSE"/>
                        </L7p:AddHeader>
                        <L7p:AddHeader>
                            <L7p:HeaderName stringValue="X-OTP-RETRY-INTERVAL"/>
                            <L7p:HeaderValue stringValue="${max_retry_wait_seconds}"/>
                            <L7p:RemoveExisting booleanValue="true"/>
                            <L7p:Target target="RESPONSE"/>
                        </L7p:AddHeader>
                        <L7p:assertionComment>
                            <L7p:Properties mapValue="included">
                                <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// 144"/>
                                </L7p:entry>
                            </L7p:Properties>
                        </L7p:assertionComment>
                    </wsp:All>
                    <wsp:All wsp:Usage="Required">
                        <L7p:ComparisonAssertion>
                            <L7p:CaseSensitive booleanValue="false"/>
                            <L7p:Expression1 stringValue="${error.code}"/>
                            <L7p:Expression2 stringValue="142"/>
                            <L7p:Predicates predicates="included">
                                <L7p:item binary="included">
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:RightValue stringValue="142"/>
                                </L7p:item>
                            </L7p:Predicates>
                        </L7p:ComparisonAssertion>
                        <L7p:AddHeader>
                            <L7p:HeaderName stringValue="X-OTP"/>
                            <L7p:HeaderValue stringValue="invalid"/>
                            <L7p:RemoveExisting booleanValue="true"/>
                            <L7p:Target target="RESPONSE"/>
                        </L7p:AddHeader>
                        <L7p:AddHeader>
                            <L7p:HeaderName stringValue="X-OTP-RETRY"/>
                            <L7p:HeaderValue stringValue="${retryCount}"/>
                            <L7p:RemoveExisting booleanValue="true"/>
                            <L7p:Target target="RESPONSE"/>
                        </L7p:AddHeader>
                        <L7p:CommentAssertion>
                            <L7p:Comment stringValue="!-- Since LDAP resolution is not supported in SolutionKit Installer, hence create a new LDAP query (with same properties as the one mentioned )here after fresh install ---"/>
                        </L7p:CommentAssertion>
                        <L7p:CommentAssertion>
                            <L7p:Comment stringValue="You can use any Directory Service Providers. As an example LDAP is given below for retrieving Email ID and Mobile Number of the Users"/>
                        </L7p:CommentAssertion>
                        <wsp:OneOrMore wsp:Usage="Required">
                            <L7p:LDAPQuery>
                                <L7p:AttrNames stringArrayValue="included">
                                    <L7p:item stringValue="mail"/>
                                    <L7p:item stringValue="mobile"/>
                                </L7p:AttrNames>
                                <L7p:CacheSize intValue="100"/>
                                <L7p:Enabled booleanValue="false"/>
                                <L7p:LdapProviderOid goidValue="2d904ad66fed1166c5dae908e9fb3d26"/>
                                <L7p:QueryMappings queryAttributeMappings="included">
                                    <L7p:item mapping="included">
                                    <L7p:AttributeName stringValue="mail"/>
                                    <L7p:JoinMultivalued booleanValue="false"/>
                                    <L7p:MatchingContextVariableName stringValue="email"/>
                                    </L7p:item>
                                    <L7p:item mapping="included">
                                    <L7p:AttributeName stringValue="mobile"/>
                                    <L7p:JoinMultivalued booleanValue="false"/>
                                    <L7p:MatchingContextVariableName stringValue="mobile"/>
                                    </L7p:item>
                                </L7p:QueryMappings>
                                <L7p:SearchFilter stringValue="uid=${userid}"/>
                                <L7p:SearchFilterInjectionProtected booleanValue="true"/>
                            </L7p:LDAPQuery>
                            <wsp:All wsp:Usage="Required">
                                <L7p:CommentAssertion>
                                    <L7p:Comment stringValue="Else manually setting the Email and Mobile as shown below is also fine"/>
                                </L7p:CommentAssertion>
                                <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="c2FtcGxlQGV4YW1wbGUuY29t"/>
                                    <L7p:VariableToSet stringValue="email"/>
                                </L7p:SetVariable>
                                <L7p:SetVariable>
                                    <L7p:Base64Expression stringValue="KzEtMTIzLTU1NS01NTU1"/>
                                    <L7p:VariableToSet stringValue="mobile"/>
                                </L7p:SetVariable>
                            </wsp:All>
                        </wsp:OneOrMore>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="JHt0ZW1wQ29kZX0="/>
                            <L7p:VariableToSet stringValue="error.code"/>
                        </L7p:SetVariable>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="JHt0ZW1wU3RhdHVzfQ=="/>
                            <L7p:VariableToSet stringValue="status"/>
                        </L7p:SetVariable>
                        <L7p:SetVariable>
                            <L7p:Base64Expression stringValue="JHt0ZW1wTXNnfQ=="/>
                            <L7p:VariableToSet stringValue="error.msg"/>
                        </L7p:SetVariable>
                        <L7p:assertionComment>
                            <L7p:Properties mapValue="included">
                                <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// 142"/>
                                </L7p:entry>
                            </L7p:Properties>
                        </L7p:assertionComment>
                    </wsp:All>
                    <wsp:All wsp:Usage="Required">
                        <L7p:ComparisonAssertion>
                            <L7p:CaseSensitive booleanValue="false"/>
                            <L7p:Expression1 stringValue="${error.code}"/>
                            <L7p:Expression2 stringValue="143"/>
                            <L7p:Predicates predicates="included">
                                <L7p:item binary="included">
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:RightValue stringValue="143"/>
                                </L7p:item>
                            </L7p:Predicates>
                        </L7p:ComparisonAssertion>
                        <L7p:AddHeader>
                            <L7p:HeaderName stringValue="X-OTP"/>
                            <L7p:HeaderValue stringValue="expired"/>
                            <L7p:RemoveExisting booleanValue="true"/>
                            <L7p:Target target="RESPONSE"/>
                        </L7p:AddHeader>
                        <L7p:AddHeader>
                            <L7p:HeaderName stringValue="X-OTP-RETRY"/>
                            <L7p:HeaderValue stringValue="${retryCount}"/>
                            <L7p:RemoveExisting booleanValue="true"/>
                            <L7p:Target target="RESPONSE"/>
                        </L7p:AddHeader>
                        <L7p:assertionComment>
                            <L7p:Properties mapValue="included">
                                <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// 143"/>
                                </L7p:entry>
                            </L7p:Properties>
                        </L7p:assertionComment>
                    </wsp:All>
                    <wsp:All wsp:Usage="Required">
                        <L7p:ComparisonAssertion>
                            <L7p:CaseSensitive booleanValue="false"/>
                            <L7p:Expression1 stringValue="${error.code}"/>
                            <L7p:Expression2 stringValue="145"/>
                            <L7p:Predicates predicates="included">
                                <L7p:item binary="included">
                                    <L7p:CaseSensitive booleanValue="false"/>
                                    <L7p:RightValue stringValue="145"/>
                                </L7p:item>
                            </L7p:Predicates>
                        </L7p:ComparisonAssertion>
                        <L7p:AddHeader>
                            <L7p:HeaderName stringValue="X-OTP"/>
                            <L7p:HeaderValue stringValue="suspended"/>
                            <L7p:RemoveExisting booleanValue="true"/>
                            <L7p:Target target="RESPONSE"/>
                        </L7p:AddHeader>
                        <L7p:AddHeader>
                            <L7p:HeaderName stringValue="X-OTP-RETRY"/>
                            <L7p:HeaderValue stringValue="-1"/>
                            <L7p:RemoveExisting booleanValue="true"/>
                            <L7p:Target target="RESPONSE"/>
                        </L7p:AddHeader>
                        <L7p:AddHeader>
                            <L7p:HeaderName stringValue="X-OTP-RETRY-INTERVAL"/>
                            <L7p:HeaderValue stringValue="${remainingTime}"/>
                            <L7p:RemoveExisting booleanValue="true"/>
                            <L7p:Target target="RESPONSE"/>
                        </L7p:AddHeader>
                        <L7p:assertionComment>
                            <L7p:Properties mapValue="included">
                                <L7p:entry>
                                    <L7p:key stringValue="RIGHT.COMMENT"/>
                                    <L7p:value stringValue="// 145"/>
                                </L7p:entry>
                            </L7p:Properties>
                        </L7p:assertionComment>
                    </wsp:All>
                    <L7p:TrueAssertion/>
                    <L7p:assertionComment>
                        <L7p:Properties mapValue="included">
                            <L7p:entry>
                                <L7p:key stringValue="RIGHT.COMMENT"/>
                                <L7p:value stringValue="// handle error codes for headers"/>
                            </L7p:entry>
                        </L7p:Properties>
                    </L7p:assertionComment>
                </wsp:OneOrMore>
                <L7p:Encapsulated>
                    <L7p:EncapsulatedAssertionConfigGuid stringValue="56bd8147-3ab4-4d09-9460-8b2de02b7a9e"/>
                    <L7p:EncapsulatedAssertionConfigName stringValue="OTK Fail with error message"/>
                    <L7p:Parameters mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="apiPrefix"/>
                            <L7p:value stringValue=""/>
                        </L7p:entry>
                        <L7p:entry>
                            <L7p:key stringValue="givenErrorCode"/>
                            <L7p:value stringValue="${error.code}"/>
                        </L7p:entry>
                    </L7p:Parameters>
                </L7p:Encapsulated>
                <L7p:assertionComment>
                    <L7p:Properties mapValue="included">
                        <L7p:entry>
                            <L7p:key stringValue="RIGHT.COMMENT"/>
                            <L7p:value stringValue="// fail with additional headers and regenerate otp if error.code=142"/>
                        </L7p:entry>
                    </L7p:Properties>
                </L7p:assertionComment>
            </wsp:All>
        </wsp:OneOrMore>
    </wsp:All>
</wsp:Policy>